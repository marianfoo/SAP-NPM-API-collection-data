[{"name":"CHANGELOG.md","content":"# Change Log\r\nAll notable changes to this project will be documented in this file.\r\n\r\nThis project adheres to [Semantic Versioning](http://semver.org/).\r\n\r\nThe format is based on [Keep a Changelog](http://keepachangelog.com/).\r\n\r\n\r\n## 5.5.4- 2022-06-10\r\n\r\n### Updated\r\n- Updated devDep async to 3.2.4\r\n\r\n## 5.5.3- 2022-04-06\r\n\r\n### Changed\r\n- changed istanbul test framework with c8\r\n\r\n## 5.5.2 - 2022-03-22\r\n\r\n### Updated\r\n- Remove certificate forwarding to Auditlog service.\r\n\r\n## 5.5.1 - 2022-03-01\r\n\r\n### Fixed\r\n- - Updated xssec to v3.2.13\r\n\r\n## 5.5.0 - 2022-01-28\r\n\r\n### Added\r\n- Node.js 16.x support\r\n\r\n### Fixed\r\n- Updated *@sap/hdbext* to 7.6.0\r\n- Updated *debug* to 4.3.3\r\n\r\n## 5.4.0 - 2022-01-03\r\n\r\n### Updated\r\n- Documentation with new usage for tenant() when providing subdomain.\r\n\r\n### Fixed\r\n- $SUBSCRIBER option can now be properly used by providing a subdomain in tenant().\r\n\r\n## 5.3.0 - 2021-11-22\r\n\r\n### Added\r\n- Added mTLS support.\r\n- Custom Timestamp functionality via .at() method for messages.\r\n\r\n### Updated\r\n- Documentation with mTLS support guidelines.\r\n- Documentation with custom timestamp usage.\r\n- *@sap/xssec* library to v3.2.10.\r\n\r\n## 5.2.0 - 2021-10-08\r\n\r\n### Added\r\n- Added express middleware functionality.\r\n\r\n### Updated\r\n- Documentation with express middleware usage steps.\r\n\r\n## 5.1.0 - 2021-08-12\r\n\r\n### Added\r\n- Added support for OAuth2 plan\r\n- Added support for SecurityContext with OAuth2 (and user token exchange)\r\n\r\n## 5.0.0 - 2021-03-09\r\n\r\n### Fixed\r\n- Replaced *request* with *node-fetch* 2.6.1\r\n- Replaced *requestretry* with *fetch-retry* 4.1.0\r\n\r\n## 4.2.0 - 2021-02-22\r\n\r\n### Added\r\n- Node.js 14.x support\r\n\r\n### Fixed\r\n- Updated *@sap/hdbext* to 7.1.3\r\n- Updated *lodash* to 4.17.21\r\n\r\n## 4.1.0 - 2021-02-12\r\n\r\n### Added\r\n- Added support for passing HTTP(s) request agent options to the Service transport.\r\n  This feature is experimental and is therefore not documented. It may be changed or removed anytime.\r\n\r\n## 4.0.0 - 2021-02-09\r\n\r\n### Fixed\r\n- Update devdeps\r\n- Update debug to 4.2.0\r\n- Update requestretry to 4.1.1\r\n- Allow empty strings in objectWithTypeAndId (utils.js) check\r\n\r\n### Removed\r\n- Node.js 6.x support\r\n\r\n## 3.2.0 - 2020-08-10\r\n\r\n### Added\r\n- Add support for multiple data subjects in Data access messages, v2 API\r\n\r\n## 3.1.1 - 2020-07-27\r\n\r\n### Fixed\r\n- Update dependencies\r\n\r\n## 3.1.0 - 2019-12-06\r\n\r\n### Added\r\n- Node.js 12.x support\r\n- Retry logic when accessing the auditlog\r\n\r\n### Fixed\r\n- Update dependencies\r\n\r\n## 3.0.2 - 2019-07-16\r\n\r\n### Fixed\r\n- Update dev dependencies\r\n\r\n## 3.0.1 - 2019-05-17\r\n\r\n### Fixed\r\n- Transactional messages: uuid and time fields are now updated for each log operation\r\n\r\n## 3.0.0 - 2019-04-23\r\n\r\n### Removed\r\n- Node.js v0.12 support\r\n- Node.js v4 support\r\n\r\n## 2.3.0 - 2018-12-18\r\n\r\n### Added\r\n- Node.js version 10 support\r\n\r\n### Fixed\r\n- Update `lodash` to 4.17.11\r\n\r\n## 2.2.4 - 2018-08-14\r\n\r\n### Fixed\r\n- Update dependencies.\r\n\r\n## 2.2.3 - 2018-07-17\r\n\r\n### Fixed\r\n- Update request to v2.87.0.\r\n\r\n## 2.2.2 - 2018-05-18\r\n\r\n### Fixed\r\n- Update request to v2.86.0.\r\n\r\n## 2.2.1 - 2018-04-05\r\n\r\n### Fixed\r\n- Update dependencies.\r\n\r\n## 2.2.0 - 2018-01-23\r\n\r\n### Added\r\n- npm-shrinkwrap.json.\r\n- Audit log service v2 support.\r\n\r\n### Fixed\r\n- Documentation for data access messages.\r\n\r\n## 2.1.1 - 2017-10-13\r\n\r\n### Changed\r\n- Dependencies' versions\r\n\r\n## 2.1.0 - 2017-08-08\r\n\r\n### Added\r\n- Support for old and new values in data modification messages.\r\n- Support for setting a tenant.\r\n- Support for Node.js v8.\r\n- Documentation improvements.\r\n\r\n## 2.0.1 - 2017-05-30\r\n\r\n### Fixed\r\n- Improved debug messages.\r\n\r\n## 2.0.0 - 2017-03-13\r\n\r\n### Added\r\n- The library requires the application to be bound to an instance of the **Audit log service**.\r\n- Instantiating the library now requires a configuration object containing the `credentials` from the service binding to be provided (see README.md).\r\n- `configurationChange` method is added to the API (see README.md).\r\n- `updateConfigurationChange` method is added to the API (see README.md).\r\n\r\n### Changed\r\n- `read`, `update` and `securityMessage` methods have some changes to their argument lists (see README.md).\r\n\r\n### Removed\r\n- `delete` method is removed from the API.\r\n- `create` method is removed from the API."},{"name":"README.md","content":"# @sap/audit-logging\r\n\r\nProvides audit logging functionalities for Node.js applications.\r\n\r\n<!-- toc -->\r\n\r\n- [Overview](#overview)\r\n  * [General audit logging principles](#general-audit-logging-principles)\r\n  * [Prerequisites](#prerequisites)\r\n  * [Versions](#versions)\r\n  * [Express Middleware](#express-middleware)\r\n    - [Simple Usage](#simple-usage)\r\n    - [Making Use of the SecurityContext and User Token Exchange Flow](#making-use-of-the-securitycontext-and-user-token-exchange-flow)\r\n    - [Plugging Middleware Only When Needed](#plugging-middleware-only-when-needed)\r\n  * [mTLS Support](#mtls-support)\r\n- [API - v1](#api---v1)\r\n  * [Importing the library](#importing-the-library)\r\n  * [Data access messages](#data-access-messages)\r\n  * [Data modification messages](#data-modification-messages)\r\n  * [Update data modification](#update-data-modification)\r\n  * [Configuration change messages](#configuration-change-messages)\r\n  * [Update configuration change](#update-configuration-change)\r\n  * [General security messages](#general-security-messages)\r\n  * [Logging a message](#logging-a-message)\r\n- [API - v2](#api---v2)\r\n  * [Importing the library](#importing-the-library-1)\r\n  * [Data access messages](#data-access-messages-1)\r\n  * [Data modification messages](#data-modification-messages-1)\r\n  * [Configuration change messages](#configuration-change-messages-1)\r\n  * [General security messages](#general-security-messages-1)\r\n- [OAuth2 User Token Exchange](#oauth2-user-token-exchange)\r\n- [Local development](#local-development)\r\n  * [Without Audit log service](#without-audit-log-service)\r\n  * [With Audit log service](#with-audit-log-service)\r\n\r\n<!-- tocstop -->\r\n\r\n## Overview\r\n\r\nAudit logging is about writing entries in a specific format to a log storage. Subject to audit logging are events of significant importance.\r\nFor example, security events which may impact the confidentiality, the integrity or the availability of a system.\r\nAnother example of such an event would be access to personal data (both reading and altering) like bank accounts, political opinion,\r\nhealth status etc.\r\n\r\nWhile the consumer of ordinary logs is a system administrator who would like to keep track of the state of a system,\r\naudit logs are read by an auditor. There are legal requirements (in some countries stricter than in others) regarding audit logging.\r\n\r\nIn general the events that are supposed to be audit logged can be grouped in 3 main categories:\r\n- changes to system configurations (which may have significant effect on the system itself)\r\n- access to personal data (related to data privacy)\r\n- general security events (like starting/stopping a system, failed authorization checks etc.)\r\n\r\n\r\n### General audit logging principles\r\n\r\n- All attempts to perform an action in a system should be audit logged no matter if they have been successful or not.\r\n- Audit log entries should be consistent with the state of the system. If, for example, the writing of the audit log entry fails,\r\nbut the changes to system critical parameters have been applied, then those changes should be reverted. Best practice is to wait for\r\nthe callback of the logger before continuing with the execution of other code.\r\n- Especially important is which user (or other agent) has triggered the corresponding event that is being audit logged.\r\nFor most of the cases the library will validate that such a field is provided in the message.\r\n- All audit log entries should be in English. Numbers should be converted to strings with English locale.\r\nAll time fields should be in UTC time in order to avoid timezone and day light saving time issues.\r\n- Passwords should never be audit logged.\r\n\r\n### Prerequisites\r\n\r\nAn application using the audit log library needs to be bound to an instance of the Audit log service.\r\n\r\n### Versions\r\n\r\nThe Audit log service provides REST APIs that are available to applications for\r\nlogging relevant messages. The latest Audit log server supports 2 versions\r\nof the REST APIs. This library provides JavaScript programming interfaces for\r\nboth of these versions of the server's APIs.\r\n**Note:** It is recommended to use REST APIs v2 if available on the Audit log server being in use (and respectively the JavaScript v2 APIs).\r\nThe initial version of the Audit log server REST APIs is deprecated in favor of the v2 version. The same applies to the JavaScript APIs provided by this library.\r\n\r\n### Express Middleware\r\n\r\nThe Audit Log client provides an easier way to use the auditlog client in an express application. Below you can find a few examples on how to make use of the express middleware. The middleware works with both **v1** and **v2** of the Auditlog Service.\r\n\r\n#### Simple Usage\r\n\r\n```js\r\nconst express = require(\"express\");\r\nconst app = express();\r\n\r\nconst auditMiddleware = require('./node-audit-logging/middleware');\r\n\r\n// Config for auditLoggingService.\r\nconst auditLogConfig = {...}; // Retrieved from the environment using @sap/xsenv.\r\n// app.use(auditMiddleware(auditLogConfig, 1)); // Here we select using v1.\r\napp.use(auditMiddleware(auditLogConfig, 2));\r\n\r\napp.get('/', async function (req, res) {\r\n  let auditLog = req.auditLog;\r\n  // ...\r\n});\r\n```\r\n\r\n#### Making Use of the SecurityContext and User Token Exchange Flow\r\n\r\nIn order to make use also of the *SecurityContext* that comes from the *@sap/xssec* library, you need to make sure you import the *@sap/xssec* middleware before the auditlogging. **This only works with the OAuth2 plan.**\r\n\r\n```js\r\nconst express = require('express');\r\n// Includes required for xssec.\r\nconst passport = require('passport');\r\nconst { JWTStrategy } = require('xssec');\r\n// Includes required for auditLogging.\r\nconst auditLogMiddleware = require('@sap/audit-logging/middleware');\r\n\r\nconst app = express();\r\n\r\n// Config for xssec middelware.\r\nconst xsuaaConfig = {...}; // Retrieved from the environment using @sap/xsenv.\r\npassport.use(new JWTStrategy(xsuaaConfig));\r\napp.use(passport.initialize());\r\napp.use(passport.authenticate('JWT', { session: false, failWithError: true }));\r\n\r\n// Config for auditLoggingService.\r\nconst auditLogConfig = {...}; // Retrieved from the environment using @sap/xsenv.\r\napp.use(auditLogMiddleware(auditLogConfig));\r\n\r\napp.get('/', async function (req, res) {\r\n  let auditLog = req.auditLog;\r\n  // ...\r\n});\r\n```\r\n\r\n#### Plugging Middleware Only When Needed\r\n\r\nIf you have the case where you do not want to include the auditLog to a request, you can plug the middleware only on the routes it is required:\r\n\r\n```js\r\nconst express = require('express');\r\n// Includes required for xssec.\r\nconst passport = require('passport');\r\nconst { JWTStrategy } = require('xssec');\r\n// Includes required for auditLogging.\r\nconst auditLogMiddleware = require('@sap/audit-logging/middleware');\r\n\r\nconst app = express();\r\n\r\n// Config for xssec middelware.\r\nconst xsuaaConfig = {...}; // Retrieved from the environment using @sap/xsenv.\r\npassport.use(new JWTStrategy(xsuaaConfig));\r\napp.use(passport.initialize());\r\napp.use(passport.authenticate('JWT', { session: false, failWithError: true }));\r\n\r\n// Config for auditLoggingService.\r\nconst auditLogConfig = {...}; // Retrieved from the environment using @sap/xsenv.\r\n\r\n// In this API we need auditlog, so we add the auditLogMiddleware\r\napp.get('/withAuditLog', auditLogMiddleware(auditLogConfig), function(req, res) {\r\n    let auditLog = req.auditLog; // This will be undefined.\r\n    // ...\r\n});\r\n\r\n// Here we do not need the auditLog, so we do not add the auditLogMiddleware.\r\napp.get('/withoutAuditLog', function(req, res) {\r\n    let auditLog = req.auditLog; // This will be undefined.\r\n    // ...\r\n});\r\n```\r\n\r\n### mTLS Support\r\n\r\nThe library also supports certificate based authentication. In order to use this type of authentication, you need to create x509 credentials and pass them to the auditlog library the same way you would pass all other credential types. If you are retrieving credentials via *@sap/xsenv* you might need to create **binding** and not **service key**.\r\n\r\nFor further information how to create the appropriate credential type, visit [Audit Log Retrieval API Usage for the Cloud Foundry Environment](https://help.sap.com/products/BTP/65de2977205c403bbc107264b8eccf4b/30ece35bac024ca69de8b16bff79c413.html).\r\n\r\n## API - v1\r\n\r\nThe library provides an API for writing audit messages of type configuration changes, data modifications, data accesses and security events.\r\n\r\n### Importing the library\r\n\r\n`credentials` object is the bound audit log service's credentials.\r\nTake a look at *@sap/xsenv* package for more information on how to retrieve service credentials.\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nvar credentials = {\r\n  \"user\": \"user\",\r\n  \"password\": \"password\",\r\n  \"url\": \"https://host:port\"\r\n};\r\nvar auditLog = require('@sap/audit-logging')(credentials);\r\n```\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nvar credentials = {\r\n  \"uaa\": {\r\n    \"clientid\": \"clientid\",\r\n    \"clientsecret\": \"clientsecret\",\r\n    \"url\": \"https://host:port\"\r\n  }\r\n  \"url\": \"https://host:port\"\r\n};\r\nvar auditLog = require('@sap/audit-logging')(credentials, securityContext);\r\n```\r\n\r\n* `credentials` - Retrieved from the environment.\r\n* `securityContext` - *Optional* - created manually or through usage of the req.AuthInfo from **@sap/xssec**.\r\n\r\n### Data access messages\r\n\r\nLet's suppose we need to create an entry for a data access operation over personal data. We can achieve that with the following code:\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nauditLog.read('user123')\r\n  .attribute('username', true)\r\n  .attribute('first name', true)\r\n  .attribute('last name', true)\r\n  .accessChannel('UI')\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `read` - takes a string which identifies the object which is being *accessed*.\r\n* `attribute(name, successful)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being accessed.\r\n  * `successful` - specifies whether the access was successful or not.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `accessChannel` - takes a string which specifies *channel* of access.\r\n* `attachment(id, name)` - if attachments or files are downloaded or displayed, information identifying the attachment shall be logged.\r\n  * `id` - attachment id\r\n  * `name` - attachment name\r\n* `tenant` - takes a string which specifies the tenant id. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nauditLog.read('user123')\r\n  .attribute('username', true)\r\n  .attribute('first name', true)\r\n  .attribute('last name', true)\r\n  .accessChannel('UI')\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `read` - takes a string which identifies the object which is being *accessed*.\r\n* `attribute(name, successful)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being accessed.\r\n  * `successful` - specifies whether the access was successful or not.\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `accessChannel` - takes a string which specifies *channel* of access.\r\n* `attachment(id, name)` - if attachments or files are downloaded or displayed, information identifying the attachment shall be logged.\r\n  * `id` - attachment id\r\n  * `name` - attachment name\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n### Data modification messages\r\n\r\nHere is how to create an entry for a data modification operation:\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nauditLog.update('user123')\r\n  .attribute('first name', 'john', 'John')\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .log(...);\r\n```\r\n\r\n**Note**: Specifying an old and a new value for an attribute is only supported in newer versions of the Audit log service. Providing these values while working with an older version of the service results in an error in the callback. In such cases one may use the `attribute` method with an alternative signature:\r\n\r\n```js\r\nauditLog.update('user123')\r\n  .attribute('password', false)\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `update` - takes a string which identifies the object which is being *updated*.\r\n* `attribute(name, oldValue, newValue)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being modified.\r\n  * `oldValue` - is the current value of the attribute.\r\n  * `newValue` - is the value of the attribute after the change.\r\n\r\n  **Note**: One may use this signature of the `attribute` method only if the Audit log service being consumed supports old and new values.\r\n\r\n* `attribute(name, successful)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being modified.\r\n  * `successful` - specifies whether the modification was successful or not.\r\n\r\n  **Note**: this signature of the method is **deprecated**. It should be used only if the consumed Audit log service does not support old and new values.\r\n\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `tenant` - takes a string which specifies the tenant id. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nauditLog.update('user123')\r\n  .attribute('first name', 'john', 'John')\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .log(...);\r\n```\r\n\r\n**Note**: Specifying an old and a new value for an attribute is only supported in newer versions of the Audit log service. Providing these values while working with an older version of the service results in an error in the callback. In such cases one may use the `attribute` method with an alternative signature:\r\n\r\n```js\r\nauditLog.update('user123')\r\n  .attribute('password', false)\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `update` - takes a string which identifies the object which is being *updated*.\r\n* `attribute(name, oldValue, newValue)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being modified.\r\n  * `oldValue` - is the current value of the attribute.\r\n  * `newValue` - is the value of the attribute after the change.\r\n\r\n  **Note**: One may use this signature of the `attribute` method only if the Audit log service being consumed supports old and new values.\r\n\r\n* `attribute(name, successful)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being modified.\r\n  * `successful` - specifies whether the modification was successful or not.\r\n\r\n  **Note**: this signature of the method is **deprecated**. It should be used only if the consumed Audit log service does not support old and new values.\r\n\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n### Update data modification\r\n\r\n```js\r\nauditLog.updateDataModification(id, isSuccessful)\r\n  .log(...);\r\n```\r\n\r\n* `updateDataModification(id, isSuccessful)` - takes two arguments.\r\n  * `id` - id of the data modification message saved earlier (see [log](#logging-a-message))\r\n  * `isSuccessful` - denotes whether the data modification was successful or not.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n**Note**: This function should only be used with an Audit log service that supports old and new values.\r\n\r\n### Configuration change messages\r\n\r\nHere is how to create an entry for a configuration change operation:\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nauditLog.configurationChange('configuration object')\r\n  .attribute('session timeout', '5', '25')\r\n  .tenant('tenantId')\r\n  .by('Application Admin')\r\n  .successful(true)\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `configurationChange` - takes a string which identifies the object which is being *configured*.\r\n* `attribute(name, oldValue, newValue)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being accessed.\r\n  * `oldValue` - is the current value of the attribute being changed.\r\n  * `newValue` - is the value of the attribute after the change.\r\n* `successful(isSuccessful)` - used to mark whether the configuration change is finished with success, failure.\r\n  If not called configuration change will be marked as *pending*.\r\n  * `isSuccessful` - should be a valid boolean.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `tenant` - takes a string which specifies the tenant id. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nauditLog.configurationChange('configuration object')\r\n  .attribute('session timeout', '5', '25')\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .successful(true)\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `configurationChange` - takes a string which identifies the object which is being *configured*.\r\n* `attribute(name, oldValue, newValue)` - sets object attributes. It is **mandatory** to provide at least one attribute.\r\n  * `name` - is the name of the attribute being accessed.\r\n  * `oldValue` - is the current value of the attribute being changed.\r\n  * `newValue` - is the value of the attribute after the change.\r\n* `successful(isSuccessful)` - used to mark whether the configuration change is finished with success, failure.\r\n  If not called configuration change will be marked as *pending*.\r\n  * `isSuccessful` - should be a valid boolean.\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n### Update configuration change\r\n\r\n```js\r\nauditLog.updateConfigurationChange(id, isSuccessful)\r\n  .log(...);\r\n```\r\n\r\n* `updateConfigurationChange(id, isSuccessful)` - takes two arguments.\r\n  * `id` - id of the configuration message saved earlier (see [log](#logging-a-message))\r\n  * `isSuccessful` - denotes whether the configuration change was successful or not.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n### General security messages\r\n\r\nHere is how to create a general security audit log message:\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nauditLog.securityMessage('%d unsuccessful login attempts', 3)\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .externalIP('127.0.0.1')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `securityMessage` - takes a formatted string as in [util.format()](https://nodejs.org/api/util.html#util_util_format_format_args).\r\n* `externalIP` - states the IP of the machine that contacts the system. It is not mandatory, but it should be either IPv4 or IPv6.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `tenant` - takes a string which specifies the tenant id. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nauditLog.securityMessage('%d unsuccessful login attempts', 3)\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .externalIP('127.0.0.1')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(...);\r\n```\r\n\r\n* `securityMessage` - takes a formatted string as in [util.format()](https://nodejs.org/api/util.html#util_util_format_format_args).\r\n* `externalIP` - states the IP of the machine that contacts the system. It is not mandatory, but it should be either IPv4 or IPv6.\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. The provided value is ignored by older versions of the Audit log service that do not support setting a tenant. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - See [here](#logging-a-message)\r\n\r\n### Logging a message\r\n\r\nUse the `log` method to write a message to the Audit log. It takes one argument - a callback function.\r\nBe aware that the state of the audit logs should be consistent with the state of the system.\r\nMake sure you handle errors from the audit log writer properly.\r\nApplication code **should wait** for the logging to finish before executing any other code.\r\n\r\n```js\r\nvar message = /* any of the above example messages */;\r\nmessage.log(function (err, id) {\r\n    // Do error handling and place all of the remaining logic here\r\n  });\r\n```\r\n\r\n* `message` - Any of the following:\r\n  * [`read`](#data-access-messages)\r\n  * [`update`](#data-modification-messages)\r\n  * [`configurationChange`](#configuration-change-messages)\r\n  * [`updateConfigurationChange`](#update-configuration-change)\r\n  * [`securityMessage`](#general-security-messages)\r\n* `err` - error object in case of error.\r\n* `id` - Id of the message that is saved. Use it when you want to do [`updateConfigurationChange`](#update-configuration-change). `id` is undefined in case of [`updateConfigurationChange`](#update-configuration-change).\r\n\r\n**Note**: When a message is logged, the library checks for missing properties and will throw an error if some are missing.\r\n\r\n## API - v2\r\n\r\n### Importing the library\r\n\r\n`credentials` object with credentials for the Audit log service.\r\nTake a look at *@sap/xsenv* package for more information on how to retrieve service credentials.\r\nThe callback will be called with an error if the Audit log server does not support version 2 of the REST APIs.\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nvar credentials = {\r\n  \"user\": \"user\",\r\n  \"password\": \"password\",\r\n  \"url\": \"https://host:port\"\r\n};\r\n\r\nvar auditLogging = require('@sap/audit-logging');\r\nauditLogging.v2(credentials, function(err, auditLog) {\r\n  if (err) {\r\n    // if the Audit log server does not support version 2 of the REST APIs\r\n    // an error in the callback is returned\r\n    return console.log(err);\r\n  }\r\n});\r\n```\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nvar credentials = {\r\n  \"uaa\": {\r\n    \"clientid\": \"clientid\",\r\n    \"clientsecret\": \"clientsecret\",\r\n    \"url\": \"https://host:port\"\r\n  }\r\n  \"url\": \"https://host:port\"\r\n};\r\n\r\nvar auditLogging = require('@sap/audit-logging');\r\nauditLogging.v2(credentials, securityContext, function(err, auditLog) {\r\n  if (err) {\r\n    // if the Audit log server does not support version 2 of the REST APIs\r\n    // an error in the callback is returned\r\n    return console.log(err);\r\n  }\r\n});\r\n```\r\n\r\n* `credentials` - Retrieved from the environment.\r\n* `securityContext` - *Optional* - created manually or through usage of the req.AuthInfo from **@sap/xssec**.\r\n*Note: This method is backwards compatible if you provide the callback instead of the securityContext it will still work.*\r\n\r\n### Data access messages\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nauditLog.read({ type: 'online system', id: { name: 'Students info system', module: 'Foreign students' } })\r\n  .attribute({ name: 'status' })\r\n  .attribute({ name: 'date-of-birth', successful: true })\r\n  .attachment({ id: 'exam-results-9537' })\r\n  .attachment({ id: 'recommendations-4381', name: 'file.doc' })\r\n  .dataSubject({ type: 'student', id: { student_id: 'st_123' }, role: 'foreign student' })\r\n  // multiple data subjects can also be provided in array format as following:\r\n  //  .dataSubjects([{ type: 'student', id: { student_id: 'st_913' }, role: 'foreign student' },\r\n  //                 { type: 'student', id: { student_id: 'st_619' }, role: 'foreign student' }])\r\n  .accessChannel('UI')\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(function (err) {\r\n\r\n  });\r\n```\r\n\r\n* `read` - takes a JavaScript object which identifies the object which contains the data being accessed. Should have `type` and `id` properties.\r\n* `attribute(attribute)` - takes an object which describes an attribute. Should have a `name` property and optionally a `successful` property. It is **mandatory** to provide at least one attribute.\r\n* `attachment(attachment)` - takes an object which describes an attachment (used if attachments or files are downloaded or displayed). Should have an `id` property and optionally a `name` property.\r\n* `dataSubject` - takes an object describing the owner of the personal data. Should have `type` and `id` properties. The `role` property is optional. `dataSubject` or `dataSubjects` is **mandatory**.\r\n* `dataSubjects` - takes an array of data subject objects.\r\n* `accessChannel` - takes a string which specifies *channel* of access.\r\n* `tenant` - takes a string which specifies the tenant id.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - logs the message.\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nauditLog.read({ type: 'online system', id: { name: 'Students info system', module: 'Foreign students' } })\r\n  .attribute({ name: 'status' })\r\n  .attribute({ name: 'date-of-birth', successful: true })\r\n  .attachment({ id: 'exam-results-9537' })\r\n  .attachment({ id: 'recommendations-4381', name: 'file.doc' })\r\n  .dataSubject({ type: 'student', id: { student_id: 'st_123' }, role: 'foreign student' })\r\n  // multiple data subjects can also be provided in array format as following:\r\n  //  .dataSubjects([{ type: 'student', id: { student_id: 'st_913' }, role: 'foreign student' },\r\n  //                 { type: 'student', id: { student_id: 'st_619' }, role: 'foreign student' }])\r\n  .accessChannel('UI')\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(function (err) {\r\n\r\n  });\r\n```\r\n\r\n* `read` - takes a JavaScript object which identifies the object which contains the data being accessed. Should have `type` and `id` properties.\r\n* `attribute(attribute)` - takes an object which describes an attribute. Should have a `name` property and optionally a `successful` property. It is **mandatory** to provide at least one attribute.\r\n* `attachment(attachment)` - takes an object which describes an attachment (used if attachments or files are downloaded or displayed). Should have an `id` property and optionally a `name` property.\r\n* `dataSubject` - takes an object describing the owner of the personal data. Should have `type` and `id` properties. The `role` property is optional. `dataSubject` or `dataSubjects` is **mandatory**.\r\n* `dataSubjects` - takes an array of data subject objects.\r\n* `accessChannel` - takes a string which specifies *channel* of access.\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - logs the message.\r\n\r\n### Data modification messages\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nvar message = auditLog.update({ type: 'online system', id: { name: 'Students info system', module: 'Foreign students' } })\r\n  .attribute({ name: 'status' })\r\n  .attribute({ name: 'town', old: 'Birmingham', new: 'London' })\r\n  .dataSubject({ type: 'student', id: { student_id: 'st_123' }, role: 'foreign student' })\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z');\r\n\r\nmessage.logPrepare(function (err) {\r\n  message.logSuccess(function (err) { });\r\n  // or\r\n  message.logFailure(function(err) { });\r\n});\r\n```\r\n\r\n* `update` - takes a JavaScript object which identifies the object which contains the data being updated. Should have `type` and `id` properties.\r\n* `attribute(attribute)` - takes an object which describes an attribute. Should have a `name` property and optionally - `old` and `new` properties. It is **mandatory** to provide at least one attribute.\r\n* `dataSubject` - takes an object describing the owner of the personal data. Should have `type` and `id` properties. The `role` property is optional. `dataSubject` is **mandatory**.\r\n* `tenant` - takes a string which specifies the tenant id.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `logPrepare` - Used to log that a user has started an operation over the data.\r\n* `logSuccess` - Used to log that the operation over the data has been completed successfully.\r\n* `logFailure` - Used to log that the operation over the data has not been completed successfully.\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nvar message = auditLog.update({ type: 'online system', id: { name: 'Students info system', module: 'Foreign students' } })\r\n  .attribute({ name: 'status' })\r\n  .attribute({ name: 'town', old: 'Birmingham', new: 'London' })\r\n  .dataSubject({ type: 'student', id: { student_id: 'st_123' }, role: 'foreign student' })\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z');\r\n\r\nmessage.logPrepare(function (err) {\r\n  message.logSuccess(function (err) { });\r\n  // or\r\n  message.logFailure(function(err) { });\r\n});\r\n```\r\n\r\n* `update` - takes a JavaScript object which identifies the object which contains the data being updated. Should have `type` and `id` properties.\r\n* `attribute(attribute)` - takes an object which describes an attribute. Should have a `name` property and optionally - `old` and `new` properties. It is **mandatory** to provide at least one attribute.\r\n* `dataSubject` - takes an object describing the owner of the personal data. Should have `type` and `id` properties. The `role` property is optional. `dataSubject` is **mandatory**.\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `logPrepare` - Used to log that a user has started an operation over the data.\r\n* `logSuccess` - Used to log that the operation over the data has been completed successfully.\r\n* `logFailure` - Used to log that the operation over the data has not been completed successfully.\r\n\r\n### Configuration change messages\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nvar message = auditLog.configurationChange({ type: 'online system', id: { name: 'Students info system', configuration: 'global-config' } })\r\n  .attribute({ name: 'session timeout', old: '5', new: '25' })\r\n  .tenant('tenantId')\r\n  .by('Application Admin')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z');\r\n\r\nmessage.logPrepare(function (err) {\r\n  message.logSuccess(function (err) { });\r\n  // or\r\n  message.logFailure(function(err) { });\r\n});\r\n```\r\n\r\n* `configurationChange` - takes a JavaScript object which identifies the object which contains the data being configured. Should have `type` and `id` properties.\r\n* `attribute(attribute)` - takes an object which describes an attribute. Should have a `name`, `old` and `new` properties. It is **mandatory** to provide at least one attribute.\r\n* `tenant` - takes a string which specifies the tenant id.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `logPrepare` - Used to log that a user has started a configuration change operation.\r\n* `logSuccess` - Used to log that the operation has been completed successfully.\r\n* `logFailure` - Used to log that the operation has not been completed successfully.\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nvar message = auditLog.configurationChange({ type: 'online system', id: { name: 'Students info system', configuration: 'global-config' } })\r\n  .attribute({ name: 'session timeout', old: '5', new: '25' })\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z');\r\n\r\nmessage.logPrepare(function (err) {\r\n  message.logSuccess(function (err) { });\r\n  // or\r\n  message.logFailure(function(err) { });\r\n});\r\n```\r\n\r\n* `configurationChange` - takes a JavaScript object which identifies the object which contains the data being configured. Should have `type` and `id` properties.\r\n* `attribute(attribute)` - takes an object which describes an attribute. Should have a `name`, `old` and `new` properties. It is **mandatory** to provide at least one attribute.\r\n* `by` - takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**.\r\n* `tenant` - takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `logPrepare` - Used to log that a user has started a configuration change operation.\r\n* `logSuccess` - Used to log that the operation has been completed successfully.\r\n* `logFailure` - Used to log that the operation has not been completed successfully.\r\n\r\n### General security messages\r\n\r\n#### Standard Plan (deprecated)\r\n\r\n```js\r\nauditLog.securityMessage('%d unsuccessful login attempts', 3)\r\n  .externalIP('127.0.0.1')\r\n  .tenant('tenantId')\r\n  .by('John Doe')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(function (err) {\r\n\r\n  });\r\n```\r\n\r\n* `securityMessage` - takes a formatted string as in [util.format()](https://nodejs.org/api/util.html#util_util_format_format_args).\r\n* `externalIP` - states the IP of the machine that contacts the system. Specifying it is optional, but if provided, should be either IPv4 or IPv6.\r\n* `by` - takes a string which identifies the *user* performing the action. This is **mandatory**.\r\n* `tenant` - takes a string which specifies the tenant id.\r\n* `at(time)` - sets a custom timestamp for event time.\r\n* `log` - logs the message.\r\n\r\n#### OAuth2 Plan\r\n\r\n```js\r\nauditLog.securityMessage('%d unsuccessful login attempts', 3)\r\n  .externalIP('127.0.0.1')\r\n  .tenant('$PROVIDER') // or .tenant('$SUBSCRIBER', subdomain)\r\n  .by('$USER')\r\n  .at(42 || new Date() || '1970-01-01T00:00:00.042Z')\r\n  .log(function (err) {\r\n\r\n  });\r\n```\r\n\r\n* `securityMessage` - takes a formatted string as in [util.format()](https://nodejs.org/api/util.html#util_util_format_format_args).\r\n* `externalIP` - states the IP of the machine that contacts the system. Specifying it is optional, but if provided, should be either IPv4 or IPv6.\r\n* `by` -  takes a fixed string '$USER' that is a placeholder replaced by the service. This is **mandatory**. `subdomain` is an optional value used only with '$SUBSCRIBER'.\r\n* `tenant` -  takes a specific string placeholder ('$PROVIDER' or '$SUBSCRIBER') that is replaced by the service. This is **mandatory**.\r\n* `at(time)` - sets a custom timestamp for event time.f\r\n* `log` - logs the message.\r\n\r\n## OAuth2 User Token Exchange\r\n\r\nIn order to make full use of the OAuth2, you will need to provide a **SecurityContext** to the library to be able to exchange user tokens to create auditlog entries on their behalf. To understand how to create a **SecurityContext**, please review [*@sap/xssec* library](https://www.npmjs.com/package/@sap/xssec).\r\n\r\n### v1\r\n\r\n```js\r\nvar xssec = require('@sap/xssec');\r\nlet auditlog;\r\n\r\n// access_token = user access token.\r\n\r\nxssec.createSecurityContext(access_token, xsuaa, function(error, securityContext, tokenInfo) {\r\n    if (error) {\r\n        console.log('Security Context creation failed');\r\n        return;\r\n    }\r\n    auditlog = require('@sap/audit-logging')(auditLogCreds, securityContext)\r\n});\r\n```\r\n\r\n### v2\r\n\r\n```js\r\nvar xssec = require('@sap/xssec');\r\nvar auditLogging = require('@sap/audit-logging');\r\nlet auditlog;\r\n\r\n// access_token = user access token.\r\n\r\nxssec.createSecurityContext(access_token, xsuaa, function(error, securityContext, tokenInfo) {\r\n    if (error) {\r\n        console.log('Security Context creation failed');\r\n        return;\r\n    }\r\n    auditLogging.v2(auditLogCreds, securityContext, (err, auditlog) => {\r\n      auditLog = auditlog;\r\n    })\r\n});\r\n```\r\n\r\n## Local development\r\n\r\n### Without Audit log service\r\n\r\n```js\r\nvar credentials = {\r\n  logToConsole: true\r\n};\r\nvar auditLog = require('@sap/audit-logging')(credentials);\r\n\r\n// or\r\n\r\nrequire('@sap/audit-logging').v2(credentials, function (err, auditLog) {\r\n\r\n});\r\n```\r\n\r\nWhen `logToConsole` is `true` the library will ignore other credential properties and will not use the Audit log service,\r\nbut will write the messages to the console.\r\n\r\n**Hint:** If you use the *@sap/xsenv* package, you can pass the credentials through the *default-services.json* file\r\nor `VCAP_SERVICES` environment variable.\r\n\r\n### With Audit log service\r\n\r\nIf your application is not deployed in Cloud Foundry or XS Advanced,\r\nbut you have a running Audit log service somewhere, you should set the `VCAP_APPLICATION` environment variable to a string like\r\n`{ \"application_name\" : \"my-app\", \"organization_name\" : \"my-org\", \"space_name\" : \"my-space\" }`\r\n\r\n**Hint:** If you use the *@sap/xsenv* package, you can set environment variables like this:\r\n\r\n```js\r\nvar xsenv = require('@sap/xsenv');\r\n\r\nxsenv.loadEnv();\r\nvar credentials = xsenv.getServices({ auditlog: 'auditlog-instance-name' }).auditlog;\r\nvar auditLog = require('@sap/audit-logging')(credentials);\r\n```\r\n\r\n*default-env.json* file:\r\n\r\n```json\r\n{\r\n  \"VCAP_APPLICATION\": {\r\n    \"application_name\" : \"my-app\",\r\n    \"organization_name\" : \"my-org\",\r\n    \"space_name\" : \"my-space\"\r\n  },\r\n\r\n  \"VCAP_SERVICES\" : {\r\n    \"auditlog\" : [ {\r\n      \"name\" : \"auditlog-instance-name\",\r\n      \"credentials\" : {\r\n        \"password\" : \"password\",\r\n        \"user\" : \"user\",\r\n        \"url\" : \"https://host:port\"\r\n      }\r\n    } ]\r\n  }\r\n}\r\n```\r\n"}]