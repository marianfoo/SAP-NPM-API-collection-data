[{"name":"CHANGELOG.md","content":"## 4.4.1\r\nFeatures:\r\n- use @sap/hana-client@2.13.13\r\n- use hdb@0.19.3\r\n- use @sap/xsenv@3.3.2\r\n\r\n## 4.4.0\r\nFeatures:\r\n- added option --use-hdb to enable using hdb client instead of @sap/hana-client for connecting to the database\r\n- use @sap/hana-client@2.12.25\r\n\r\n## 4.3.3\r\nFeatures:\r\n- use @sap/hdi@4.3.1\r\n- use @sap/hana-client@2.12.20\r\n- use async@3.2.3\r\n\r\nFixes :\r\n- handle empty user-provided services\r\n\r\n## 4.3.2\r\nFixes:\r\n- maintain shrinkwrap with minimist@1.2.6\r\n\r\n## 4.3.1\r\nFeatures:\r\n- added support for retrieving credentials from kubernetes\r\n- use @sap/hdi@4.3.0\r\n- use @sap/hana-client@2.11.20\r\n\r\nFixes:\r\n- log long lists without truncation\r\n- fixed passing arbitrary parameters to @sap/hana-client\r\n\r\n## 4.3.0\r\nFeatures:\r\n- allow passing arbitrary parameters to @sap/hana-client\r\n- use @sap/hdi@4.2.0\r\n- use @sap/hana-client@2.10.20\r\n\r\n## 4.2.3\r\nFeatures:\r\n- allow pattern negations in the undeploy.json file\r\n\r\n## 4.2.2\r\nFixes:\r\n- removed extraneous packages in shrinkwrap\r\n\r\n## 4.2.1\r\nFeatures:\r\n- added option `--hana-client-trace` to enable tracing for the SAP HANA client interactions with the SAP HANA server\r\n- added option `--hana-client-packet-trace` to enable packet tracing for the SAP HANA client interactions with the SAP HANA server\r\n- added custom listeners to handle SIGBUS errors\r\n\r\nFixes:\r\n- log client messages and errors to structured log\r\n\r\n## 4.2.0\r\nFeatures:\r\n- allow wildcard paths in the undeploy.json file to enable the undeployment of a set of files without having to specify every single file\r\n- added, modified, deleted and \"treated as modified\" files are logged during deployment\r\n- use @sap/hdi@4.1.0\r\n- use @sap/hana-client@2.9.28\r\n- Node 16.x support\r\n\r\nRemoved:\r\n- Node 8.x and 10.x support\r\n\r\n## 4.1.0\r\nFeatures:\r\n- provide `--validate-external-dependencies` option to always start a make, even if no files are in the deploy/undeploy sets\r\n- change wording for `\"whitelist\"` to `\"allowlist\"`\r\n- use @sap/hdi@4.0.2\r\n- use @sap/hana-client@2.8.20\r\n- added support for reading a `.env` file in the absence of `default-env.json` file\r\n\r\nFixes:\r\n- with `--trace`, ensure that the complete VCAP_SERVICES are logged\r\n\r\n## 4.0.6\r\nFeatures:\r\n- with `--trace`, log target credentials before checking server version\r\n\r\n## 4.0.5\r\nFixes:\r\n- updated handlebars to 4.7.7\r\n\r\n## 4.0.4\r\nFeatures:\r\n- use @sap/hdi@4.0.1\r\n- use @sap/hana-client@2.7.26\r\n\r\nFixes:\r\n- corrected improper representation of time in log\r\n\r\n## 4.0.3\r\nFixes:\r\n- ensure all the messages returned by library.js are structured\r\n- stricter tag validation\r\n\r\n## 4.0.2\r\nFeatures:\r\n- use @sap/hdi@3.0.2\r\n- use @sap/hana-client@2.7.21\r\n- log start and end time of deployments\r\n\r\n## 4.0.1\r\nFixes:\r\n- use @sap/xsenv@3.1.0 for full node 14 support\r\n\r\n## 4.0.0\r\nFeatures:\r\n- use @sap/hdi@3.0.1\r\n- use @sap/hana-client@2.7.16\r\n- Node 14.x support\r\n\r\nRemoved:\r\n- Node 6.x support\r\n\r\n## 3.11.15\r\nFixes:\r\n- set default for --delete-timeout and --write-timeout to 15 minutes instead of 15 seconds\r\n\r\n## 3.11.14\r\nFeatures:\r\n- introduce options --delete-timeout and --write-timeout, that can be used to set a timeout for the DELETE and WRITE HDI calls.\r\n\r\n## 3.11.13\r\nFeatures:\r\n- better logging of WRITE/DELETE calls\r\n\r\nFixes:\r\n- update dependencies\r\n- only handle \"CDS METADATA\" on non-HANA Cloud systems\r\n- always log errors to the parent process when using library.js\r\n- gracefully handle \"trace\":false via HDI_DEPLOY_OPTIONS\r\n\r\n## 3.11.12\r\nChanges:\r\n- segfault-handler is no longer installed as a optional dependency - needs to be provided via parallel installation if required\r\n\r\nFixes:\r\n- check the return code of HDI API calls to correctly detect errors\r\n\r\n## 3.11.11\r\nFixes:\r\n- close all connections before calling process.exit() to work around sporadic segmentation fault\r\n\r\n## 3.11.10\r\nFixes:\r\n- fixed a memory leak with `--live-messages`\r\n\r\n## 3.11.9\r\nFeatures:\r\n- node 12 support\r\n\r\nFixes:\r\n- updated dependencies\r\n- gracefully handle a missing grantor service when using library.js\r\n\r\n## 3.11.8\r\nFixes:\r\n- specify segfault-handler as an optional dependency\r\n\r\n## 3.11.7\r\nFixes:\r\n- better debugging capabilities for segmentation faults\r\n\r\n## 3.11.6\r\nFixes:\r\n- remove duplicate messages when using the deployer as a library\r\n- update dependencies\r\n\r\n## 3.11.5\r\nFixes:\r\n- when used as a library, do not exit until all messages have been sent to the parent process\r\n\r\nFeatures:\r\n- use hana-client 2.4.162\r\n\r\n## 3.11.4\r\nFixes:\r\n- update handlebars\r\n\r\n## 3.11.3\r\nFeatures:\r\n- update dependencies\r\n\r\nFixes:\r\n- correctly handle SQL grantors\r\n\r\n## 3.11.2\r\nFeatures:\r\n- update dependencies\r\n\r\n## 3.11.1\r\nFeatures:\r\n- node 10 support\r\n- updated dependencies\r\n\r\n## 3.11.0\r\nFeatures:\r\n- added option `--liveness-ping` to periodically send a signal that notifies the user that the deployer is still working\r\n- added option `--live-messages` to display the make messages while the make is still in progress\r\n- added function `clean-env` to `library.js` to allow cleaning a passed environment of all deployer-related variables\r\n\r\nFixes:\r\n- `library.js` would sometimes return with `exitCode` null because of unexpected closing of the child process\r\n- update dependencies\r\n- add missing options to HDI_DEPLOY_OPTIONS\r\n\r\n## 3.10.0\r\nFeatures:\r\n- passwords can be split over multiple services\r\n\r\n## 3.9.4\r\nFixes:\r\n- update handlebars\r\n\r\n## 3.9.3\r\nFixes:\r\n- add full support for .hdbmigrationtable files by adding the --[no-]migrationtable-development-mode flag\r\n\r\n## 3.9.2\r\nFixes:\r\n- the private key used for mutual authentication was logged if tracing is enabled\r\n- mutual auth was missing on some database connections\r\n- some database connections were not closed correctly\r\n\r\n## 3.9.1\r\nFixes:\r\n- revert changes to hdi actions that could possibly cause a behavior change\r\n\r\n## 3.9.0\r\nFeatures:\r\n- allow passing ssl connection parameters in service binding\r\n- allow mutual auth via parameters in service binding\r\n- set session variable APPLICATION on all HANA connections\r\n- support path parameters for HDI\r\n- allow development debug role similar to the default access role\r\n- update @sap/hdi dependency\r\n- better handling of invalid undeploy.json files\r\n- improved timestamps in logging output\r\n- check ownership of objects in the container via --treat-wrong-ownership-as-errors\r\n- allow logging of additional application data\r\n\r\nFixes:\r\n- issue with schema privileges and global roles in the same .hdbgrants file\r\n\r\n## 3.8.2\r\n\r\nFeatures:\r\n- introduced .hdbrevokes as a counterpart to .hdbgrants\r\n- automatically find target service: if only one HDI service is bound, TARGET_CONTAINER does not have to be set \r\n- print timestamp of HDI messages\r\n- print the status of the last build\r\n- fallback to the .hdiconfig in src/ if it is missing in cfg/\r\n- switch to @sap/hdi 2.1.2\r\n- switch from hdb to @sap/hana-client\r\n- check if the container supports locking and skip it if not\r\n\r\nFixes:\r\n- support \\n and \\r\\n as line endings in .hdiignore files\r\n- correctly process grantor files in ZDM mode\r\n- fix 'Maximum call stack size exceeded' in ZDM mode\r\n- don't escape schema names in .hdbgrants\r\n\r\n## 3.7.0\r\n\r\nFeatures:\r\n- warning messages will now be prepended with \"WARNING:\"\r\n- error messages in case of a bad service binding now offer more detail on what caused the error\r\n- now supports comments in JSON files like default services file\r\n- allow file patterns in --deploy option\r\n- added new options --exclude-filter and .hdiignore file that basically work like .gitignore\r\n- improved error reporting when using the deployer as a library\r\n\r\nFixes:\r\n- correctly handle component names of system privileges in .hdbgrants files\r\n- handle empty privilege objects\r\n- filter client files like .hdbgrants before deploying\r\n\r\n## 3.6.0\r\n\r\nFeatures:\r\n- support ZDM deployment of HDI artifacts modeled in data/ and access/ folders inside db module\r\n- support ZDM deployment of .hdbrole files in access schema\r\n- target service is logged during deployment\r\n\r\n## 3.5.1\r\n\r\nFeatures:\r\n- support ZDM deployment\r\n- added warning message when using .hdbsysnonymtemplate or .hdbsynonymgrantor\r\n\r\n## 3.4.1\r\n\r\nFeatures:\r\n- update dependencies\r\n\r\n## 3.4.0\r\n\r\nFeatures:\r\n- provide `--treat-unmodified-as-modified` option to schedule also unmodified for deploy\r\n- support procedure-type granting services\r\n- improve Readme\r\n\r\nFixes:\r\n- fix handling of grantor services which have a `db_hosts` value, but no `host` value\r\n- fix occasional 'Callback was already called' error in case of deployment failures\r\n\r\n## 3.3.0\r\n\r\nFeatures:\r\n- provide library.js to fork the deployer from a node.js app for a given content directory including support for stdio callbacks\r\n\r\nFixes:\r\n- don't look at server folders outside cfg/, src/, and lib/\r\n\r\n## 3.2.0\r\n\r\nFeatures:\r\n- support for @sap/hdi-dynamic-deploy\r\n\r\n## 3.1.2\r\n\r\nFixes:\r\n- use `db_hosts` from `VCAP_SERVICES` if it exists\r\n- transform paths from `--include-filter`, `--deploy`, `--undeploy`, `--working-set` to the server format where reusable modules are located at `lib/` instead of `node_modules/`\r\n\r\n## 3.1.1\r\n\r\nFixes:\r\n- support @-scoped reusable modules\r\n\r\n## 3.1.0\r\n\r\nFeatures:\r\n- support `--parameter` option to pass key-value parameters to the deployment\r\n\r\nFixes:\r\n- use non-sync write to stdout (and stderr), and on exit, wait until stdout is drained to avoid loss of log output in case of crashes, etc.\r\n- container locking is available since server version 2.0.1.0, not 2.0.0.0\r\n\r\n## 3.0.0\r\n\r\nFeatures:\r\n- check `src/defaults/default_access_role.hdbrole` file against the working set\r\n- check `.hdbgrants` files against the working set\r\n- show the processing of individual `.hdbgrants` files\r\n- on newer server versions, acquire the container lock while working with the container\r\n- support `--lock-container-timeout <ms>` option for setting the number of milliseconds to wait for the container lock, defaults to 120.000 ms\r\n- also support grantor services with only `\"user\"`, `\"password\"`, `\"schema\"`; and take `\"host\"`, `\"port\"`, `\"certificate\"` from the target container\r\n- in `.hdbgrants` files, use the first non-undefined schema value (`\"schema\"`, `\"reference\"`, `\"schema\"` from grantor service); `\"reference\"` is only used for `\"schema_privileges\"`\r\n- support schema roles in `.hdbgrants` files\r\n- reject explicit delta detection of files outside the working set\r\n- switch to Node.js 6.9.1 as minimal Node.js version\r\n- provide `--working-set` option to restrict the set of files which can be modified in the container\r\n- support global roles with admin option in `.hdbgrants` files\r\n- support system privileges with admin option in `.hdbgrants` files\r\n- support `--connection-timeout <ms>` option for setting the number of milliseconds to wait for the database connection(s)\r\n\r\nFixes:\r\n- lock the container before showing the `synchronizing` message\r\n- support `.hdbgrants` files without a name (`folder/.hdbgrants`)\r\n- support the string-array style in schema_roles, too\r\n- support typed global object privileges in `.hdbgrants` files\r\n- correctly pass certificate to hdi client\r\n\r\n## 2.3.0\r\n\r\nFeatures:\r\n- rename module to @sap/hdi-deploy\r\n\r\n## 2.2.0\r\n\r\nFixes:\r\n- fix schema name handling to allow schema names with special characters\r\n- fix handling of more than 1 privilege in a single element in `.hdbgrants` files\r\n- fix trace handling for VCAP_SERVICES and connection data\r\n\r\n## 2.1.0\r\n\r\nFeatures:\r\n- detect server version; provide `--[no-]detect-server-version` option\r\n- invert client feature version numbers if they are not available due to the detected server version\r\n- support `server` in `--info`\r\n- generalize handling of configuration file templating for `cfg/**/*config` files\r\n- provide `--structured-log` option to send messages in a JSON-structured format into a log file\r\n- provide `--[no-]verbose` option to suppress detailed messages at the console output\r\n- allow consumption of reusable database modules via `package.json` and `npm install`\r\n- provide `--simulate-make` option to enable server-side feature for simulating the make activities\r\n- provide `--treat-warnings-as-errors` option to enable server-side feature for treating warnings as errors\r\n- provide `--deploy` option to explicitly include a set of files in the deploy set\r\n- provide `--undeploy` option to explicitly include a set of files in the undeploy set\r\n\r\nFixes:\r\n- reject `--simulate-make` and `--treat-warnings-as-errors` if the server doesn't support these features\r\n- consider the root path when looking for reuse modules\r\n- throw an error if we find a nested node_modules folder inside a reuse module\r\n\r\n## 2.0.1\r\n\r\nFixes:\r\n- pass the certificate from the service binding down to the database (`certificate` field in the binding, `ca` field in the database connection)\r\n- fix handling of file templating in `cfg/` folder and include-filter handling on Windows\r\n- fix handling of multiple roles in `container_roles` elements in `.hdbgrants` files\r\n- fix handling of `.hdbgrants` files with more than 1 grantors inside\r\n\r\n## 2.0.0\r\n\r\nFeatures:\r\n- allow `.hdbgrants` as suffix for privilege grants / grantor mechanism files\r\n- apply consistency check on file `src/defaults/default_access_role.hdbrole`\r\n- show information about used service replacements\r\n- reworked reporting of hdideploy.js errors and HDI errors/warnings\r\n- refactored JSON parser handling\r\n- automatic assignment of the deployed role `default_access_role` if the file `src/defaults/default_access_role.hdbrole` is in the processing file set\r\n- provide `--info` option to show supported features\r\n- provide timing information for certain actions, e.g. time spent for collecting files, time spent for synchronizing files with the server, etc.\r\n- provide `--include-filter` option to define a filter for restricting the set of files which are processed by the deployer app for deploy/undeploy\r\n- allow the indirection of service names via a `SERVICE_REPLACEMENTS` environment variables\r\n- provide a generic templating mechanism for `cfg/**/*config` files, replacing the `hdbsynonymtemplate` files\r\n- support `default-services.json` and `default-env.json` for local development\r\n- show information about the effects of the `undeploy.json` file\r\n- always show application name plus version number; for support cases\r\n- always consider all deploy directories, even if they do not exist locally\r\n- write the log message `Application can be stopped.` only once\r\n- ignore errors when deleting non-existing directories\r\n- show information about the steps that are performed\r\n- provide `--[no-]strip-cr-from-csv` option to [not] strip carriage return characters from CSV files; not enabled by default anymore\r\n\r\nFixes:\r\n- don't report a missing `undeploy.json` file as an error\r\n\r\n## 1.1.0\r\n\r\nFeatures:\r\n- replace `--autoUndeploy` with `--auto-undeploy`; keep `--autoUndeploy` for backwards compatibility\r\n- provide `--no-auto-undeploy` option to revert `--auto-undeploy`\r\n- provide `--root` option\r\n- provide `--exit` and `--no-exit` options\r\n- allow to pass options via JSON structured `HDI_DEPLOY_OPTIONS` environment variable\r\n"},{"name":"README.md","content":"@sap/hdi-deploy\r\n===============\r\n\r\n`@sap/hdi-deploy` is a [Node.js](https://nodejs.org)-based deployment module for SAP HANA DI (HDI)-based persistence models, HDI Deployer for short. The HDI Deployer can be used in XS Advanced (XSA) and in SAP Business Technology Platform (SAP BTP)/Cloud Foundry (CF), and it is also used by the SAP Web IDE for interactive development scenarios. It can also be used in scenarios without XSA (or SAP BTP), e.g. for deploying HDI persistence models into a SAP HANA database where no XSA is installed.\r\n\r\nFor more information about SAP HANA DI, please check the [SAP HANA Developer Guide](https://help.sap.com/viewer/4505d0bdaf4948449b7f7379d24d0f0d/2.0.03/en-US/eaa4e37394ea4efba8148d595d025261.html) and the [SAP HANA Administration Guide](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.03/en-US/3ef0ee9da11440e4b01708455b8497a9.html).\r\n\r\nUsually, the HDI Deployer is packaged into a database module, a `db` module, as part of a Multi-Target Application (MTA) and is used to deploy HDI design-time artifacts of the `db` module to the respective HDI container. When an MTA is deployed via the Deploy Service, the `db` module is pushed first so that it can \"prepare\" the SAP HANA persistence; by the time defined services are started, the HDI container is ready for use.\r\n\r\nThe HDI Deployer can also be used without the Deploy Service and MTAs, without XSA, and also for interactive scenarios or automation scripts.\r\n\r\nFor an MTA with different modules, e.g. a `db` module, a Node.js module, etc., this looks as follows:\r\n\r\n```\r\n  +-----------------+    +-----------------+    +-----------------+\r\n  | db module       |    | Node.js module  |    | ... module      |\r\n  | w/ HDI Deployer |    |                 |    |                 |\r\n  +-----------------+    +-----------------+    +-----------------+\r\n\r\n           |                      |                      |\r\n           |                      |                      |\r\n \\/ deploy persistence       \\/ read/write/extend persistence      \r\n           |                      |                      |\r\n           |                      |                      |\r\n\r\n  +---------------------------------------------------------------+\r\n  | HDI container                                                 |\r\n  |                                                               |\r\n  +---------------------------------------------------------------+\r\n```\r\n\r\nIn an SAP HANA-Service-Broker-based HDI setup, each module of the MTA is equipped with it's own technical database user for accessing the runtime schema of the HDI container.\r\n\r\nThe following diagram illustrates the different users who are involved in this setup with regard to privileges: the application users user1 and user2 who are bound to one of the modules each, and the HDI container's object owner (the #OO user) who is the owner of the objects in the database persistence of the MTA which are managed by HDI:\r\n\r\n```\r\n  +-----------------+    +-----------------+    +-----------------+\r\n  | db module       |    | Node.js module  |    | ... module      |\r\n  | w/ HDI Deployer |    |                 |    |                 |\r\n  +-----------------+    +-----------------+    +-----------------+\r\n\r\n                                  |                      |            o\r\n                                  | --------------------------------- X application user user1\r\n                                  |                      |       o\r\n                                  |                      | ----- X application user user2\r\n                                  |                      |\r\n\r\n  +---------------------------------------------------------------+\r\n  | HDI container                                                 |\r\n  |                              db object 1      db object 2     |\r\n  +-------------------------------------\\-------------/-----------+\r\n                                         \\           /\r\n                                      o   \\         /\r\n                                      X object owner (#OO user)\r\n```\r\n\r\nThe HDI Deployer is packaged into the `db` module of the MTA. So, in order to use a new HDI Deployer, you need to reference a new version of the HDI Deployer in the `db` module's `package.json` file.\r\n\r\nThe HDI Deployer supports SAP HANA 1 SPS11/SPS12 and SAP HANA 2. The HDI Deployer assumes that for newer versions of SAP HANA, a corresponding version of the SAP HANA Service Broker is used to create the CF/XSA service bindings.\r\n\r\nNote: The HDI Deployer assumes ownership of the `src/`, `cfg/`, and `lib/` folders in the bound target HDI container. Binding more than 1 instance of the HDI Deployer to the same HDI container as the target container, e.g. the `db` modules of 2 MTAs or 2 applications are bound to the same HDI container as the target container, is not supported and results in undefined behavior.\r\n\r\n## README.md\r\n\r\n**Installation**:\r\n- [Integration into a Database Module](#integration-into-a-database-module)\r\n- [Database Connection Details](#database-connection-details)\r\n- [Deployment via Push and Tasks](#deployment-via-push-and-tasks)\r\n- [Deployment via Local Run](#deployment-via-local-run)\r\n\r\n**The Database Module**:\r\n- [A Database Module's File System Structure](#a-database-modules-file-system-structure)\r\n- [Delta Deployment and Undeploy Allowlist](#delta-deployment-and-undeploy-allowlist)\r\n- [The default_access_role Role](#the-default_access_role-role)\r\n- [The development_debug_role Role](#the-development_debug_role-role)\r\n- [Reusable Database Modules](#reusable-database-modules)\r\n- [Configuration File Templating](#configuration-file-templating)\r\n- [Permissions to Container-External Objects](#permissions-to-container-external-objects)\r\n\r\n**Configuration and Reconfiguration**:\r\n- [Environment Variables for Applications](#environment-variables-for-applications)\r\n- [Environment Variables for Infrastructure / Development Tools](#environment-variables-for-infrastructure--development-tools)\r\n- [Options for Interactive Scenarios](#options-for-interactive-scenarios)\r\n- [Ignore List](#ignore-list)\r\n- [Supported Features](#supported-features)\r\n\r\n**Dynamic Deployment**:\r\n - [Deployment via hdi-dynamic-deploy](#deployment-via-hdi-dynamic-deploy)\r\n \r\n**Library Usage**:\r\n - [Using hdi-deploy as a Node.js library](#using-hdi-deploy-as-a-nodejs-library)\r\n\r\n\r\n## Integration into a Database Module\r\n\r\nUsually, `@sap/hdi-deploy` gets installed via a `package.json`-based dependency inside your application's `db` module:\r\n\r\n`db/package.json`:\r\n\r\n```\r\n{\r\n  \"name\": \"deploy\",\r\n  \"dependencies\": {\r\n    \"@sap/hdi-deploy\": \"4.4.1\"\r\n  },\r\n  \"scripts\": {\r\n    \"start\": \"node node_modules/@sap/hdi-deploy/\"\r\n  }\r\n}\r\n```\r\n## Database Connection Details\r\n\r\nConnection details for the database, e.g. host, port, credentials, certificates, hostname_in_certificate, encrypt and validate_certificate, are looked up by the HDI Deployer from the standard CF/XSA `VCAP_SERVICES` environment variable which contains the bound services.\r\n\r\nSince version 4.3.1 of hdi-deploy supports reading credentials from a secret volume for Kubernetes.\r\n\r\nIn order to use mutual authentication, `client_authentication_private_key` and `client_authentication_certificate` can be supplied via the service binding.\r\n\r\nFor local testing, the HDI Deployer supports default configurations via the following configuration files:\r\n\r\n- `default-env.json`: a JSON file which contains a set of environment variables and their values\r\n- `.env`: a dot env file which contains a set of environment variables and their values. This file is used in the absence of `default-env.json`.   \r\n- `default-services.json`: a JSON file which contains a set of service bindings\r\n\r\nDetails of a bound service from an SAP HANA-Service-Broker-based service binding in CF/XSA usually look as follows:\r\n\r\n``` JSON\r\n{\r\n  \"name\" : \"foo\",\r\n  \"label\" : \"hana\",\r\n  \"tags\" : [ \"hana\", \"database\", \"relational\" ],\r\n  \"plan\" : \"hdi-shared\",\r\n  \"credentials\" : {\r\n    \"schema\" : \"FOO\",\r\n    \"user\" : \"FOO_345999596729_RT\",\r\n    \"password\" : \"<password>\",\r\n    \"hdi_user\" : \"FOO_645927945801_DT\",\r\n    \"hdi_password\" : \"<password>\",\r\n    \"host\" : \"srv1234567.host.name\",\r\n    \"port\" : \"30115\",\r\n    \"db_hosts\" : [ {\r\n      \"port\" : 30115,\r\n      \"host\" : \"srv1234567.host.name\"\r\n    } ],\r\n    \"url\" : \"jdbc:sap://srv1234567.host.name:30115/?currentschema=FOO\",\r\n    \"driver\" : \"com.sap.db.jdbc.Driver\"\r\n  }\r\n}\r\n```\r\n\r\nHere, the credentials section contains all the data which is needed by the HDI Deployer for connecting to the database. The HDI Deployer uses the `hdi_user`/`hdi_password` credentials from a direct service binding. The `hdi_user` should be minimal, i.e. only have the privileges required to fulfill the deployment. In most cases, access to a container FOO's API in the FOO#DI schema is sufficient.\r\n\r\n### Splitting passwords across services\r\n\r\nThe `password` property and the `hdi_password` property can also be specified as a combination of passwords from other bound services. Consider the following service binding:\r\n\r\n``` JSON\r\n{\r\n    \"hana\" : [],\r\n    \"user-provided\" : [ \r\n      {\r\n      \"name\" : \"split_password_service\",\r\n      \"label\" : \"user-provided\",\r\n      \"tags\" : [],\r\n      \"credentials\" : {\r\n        \"user\" : \"user\",\r\n        \"schema\": \"schema\",\r\n        \"password\": [\"password_and_hdi_password_service\", \"password_only_service\"],\r\n        \"hdi_password\": [\"password_and_hdi_password_service\", \"hdi_password_only_service\"],\r\n        \"tags\" : [ \"hana\" ]\r\n      }\r\n    },\r\n    {\r\n      \"name\" : \"password_and_hdi_password_service\",\r\n      \"label\" : \"user-provided\",\r\n      \"tags\" : [],\r\n      \"credentials\" : {\r\n        \"password\" : \"PASSWORD\",\r\n        \"hdi_password\": \"HDI_PASSWORD\",\r\n        \"tags\" : [ \"password\" ]\r\n      }\r\n    },\r\n    {\r\n      \"name\" : \"hdi_password_only_service\",\r\n      \"label\" : \"user-provided\",\r\n      \"tags\" : [],\r\n      \"credentials\" : {\r\n        \"hdi_password\": \"123\",\r\n        \"tags\" : [ \"password\" ]\r\n      }\r\n    },\r\n    {\r\n      \"name\" : \"password_only_service\",\r\n      \"label\" : \"user-provided\",\r\n      \"tags\" : [],\r\n      \"credentials\" : {\r\n        \"password\" : \"456\",\r\n        \"tags\" : [ \"password\" ]\r\n      }\r\n    } ]\r\n  }\r\n```\r\n\r\nWhen the service `shared_password_service` is used, the services specified in `password` and/or `hdi_password` will be checked and their `password` and/or `hdi_password` will be concatenated. The services will be accessed in the order they are defined. The resulting `shared_password_service` would have the `password` \"PASSWORD456\" and the `hdi_password` \"HDI_PASSWORD123\".\r\n\r\n0 to n services can be specified, specifying 0 services results in the `password`/`hdi_password` ''.\r\n\r\n### VCAP_SERVICES\r\n\r\nConnection details for the database are stored in the following format in the [`VCAP_SERVICES`](http://docs.cloudfoundry.org/devguide/deploy-apps/environment-variable.html#VCAP-SERVICES) environment variable:\r\n\r\n`VCAP_SERVICES`:\r\n```\r\n{\r\n  \"hana\" : [\r\n    <hana-service-binding-1>,\r\n    <hana-service-binding-2>,\r\n    ...\r\n    <hana-service-binding-n>\r\n  ],\r\n  \"user-provided\" : [\r\n    <user-provided-service-binding-1>,\r\n    <user-provided-service-binding-2>,\r\n    ...\r\n    <user-provided-service-binding-m>\r\n  ]\r\n}\r\n'\r\n```\r\n\r\n### default-env.json\r\n\r\nA `default-env.json` file can contain a set of environment variables and their values. The HDI Deployer will pick up these settings on startup:\r\n\r\n`default-env.json:`\r\n```\r\n{\r\n  \"TARGET_CONTAINER\" : \"<name-of-the-service-instance-to-use-as-deployment-target>\",\r\n  \"VCAP_SERVICES\" : {\r\n    \"hana\" : [\r\n      <hana-service-binding-1>,\r\n      <hana-service-binding-2>,\r\n      ...\r\n      <hana-service-binding-n>\r\n    ],\r\n    \"user-provided\" : [\r\n      <user-provided-service-binding-1>,\r\n      <user-provided-service-binding-2>,\r\n      ...\r\n      <user-provided-service-binding-m>\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n`default-env.json` example file with a target container binding and a user-provided service:\r\n\r\n```\r\n{\r\n  \"TARGET_CONTAINER\" : \"target-service\",\r\n  \"VCAP_SERVICES\" : {\r\n    \"hana\" : [ {\r\n     \"name\" : \"target-service\",\r\n      \"label\" : \"hana\",\r\n      \"tags\" : [ \"hana\", \"database\", \"relational\" ],\r\n      \"plan\" : \"hdi-shared\",\r\n      \"credentials\" : {\r\n        \"schema\" : \"SCHEMA\",\r\n        \"hdi_user\" : \"USER_DT\",\r\n        \"hdi_password\" : \"PASSWORD_DT\",\r\n        \"certificate\" : \"-----BEGIN CERTIFICATE-----\\nABCD...1234\\n-----END CERTIFICATE-----\\n\",\r\n        \"host\" : \"host\",\r\n        \"port\" : \"30015\"\r\n      }\r\n    } ],\r\n    \"user-provided\" : [ {\r\n      \"name\" : \"GRANTING_SERVICE\",\r\n      \"label\" : \"user-provided\",\r\n      \"tags\" : [ ],\r\n      \"credentials\" : {\r\n        \"schema\" : \"SYS\",\r\n        \"user\" : \"GRANT_USER\",\r\n        \"password\" : \"PASSWORD\",\r\n        \"procedure_schema\" : \"PRIVILEGE_PROCEDURE_GRANTOR_DEFINER\",\r\n        \"procedure\" : \"GRANT\",\r\n        \"type\" : \"procedure\",\r\n        \"tags\" : [ \"hana\" ]\r\n      }\r\n    } ]\r\n  }\r\n}\r\n```\r\n### .env\r\n\r\nA `.env` file can contain a set of environment variables and their values. The HDI Deployer will pick up these settings on startup:\r\n\r\n\r\n`.env` example file:\r\n\r\n```\r\n\r\n  VCAP_SERVICES={\"hana\" : [ { \"name\" : \"target-service\", \"label\" : \"hana\", \"tags\" : [ \"hana\", \"database\", \"relational\" ], \"plan\" : \"hdi-shared\", \"credentials\" : { \"schema\" : \"SCHEMA\", \"hdi_user\" : \"USER_DT\", \"hdi_password\" : \"PASSWORD_DT\", \"certificate\" : \"-----BEGIN CERTIFICATE-----\\nABCD...1234\\n-----END CERTIFICATE-----\\n\", \"host\" : \"host\", \"port\" : \"30015\" } } ] }\r\n  \r\n```\r\n## Deployment via Push and Tasks\r\n\r\nThere are two ways of using the HDI Deployer as an application:\r\n\r\n- Push the application with one instance. The application will then start and do the HDI deployment of the data model. After a successful deployment, the application will enter an idle loop and can be stopped.\r\n- Push the application with zero instances and then trigger a task on the application which does the HDI deployment of the data model. After deployment of the data model, the task will be completed. An instance of the application is only running while the task is being executed.\r\n\r\nFor both scenarios, ensure that the `health-check-type` in the manifest is set to `process`, instead of the default, `port`-based health check.\r\n\r\nIn order to push the application with zero instances, the application can either be pushed with the `--no-start` option or the number of instances can be set to zero in the `manifest.yml` file via `instances: 0`.\r\n\r\nThe deployment task can be started via `xs run-task <app> deployment-task \"npm run start -- --exit\" --wait-for-completion` on XSA. The task will run and the call will propagate the success/failure of the deployment task. On CF, the `--wait-for-completion` option is not available and the status of the task needs to be checked periodically.\r\n\r\n## Deployment via Local Run\r\n\r\nAn HDI deployment can also be triggered without using an application. In this case, the HDI Deployer will be run locally and directly connects to the database. This is possible in the following scenarios: the database is accessible locally from a network point of view or a network tunnel with a local endpoint was established, e.g. a `cf ssh`-based tunnel is set up in CF.\r\n\r\nApply the following steps to run the HDI Deployer locally: run `npm install` in the db module's folder to install the HDI Deployer module, then create a `default-env.json` file in the db module's folder which contains the required service bindings and the `TARGET_CONTAINER` setting, then run `npm run start -- --exit` in the db module's folder to trigger the deployment of the data model.\r\n\r\nIf the database uses SSL/TLS encryption, please ensure that the `hostname_in_certificate` value is set up correctly in the service bindings, because the network tunnel's local endpoint (e.g. localhost:9000) doesn't match the hostname in the SSL/TLS certificate.\r\n\r\n## A Database Module's File System Structure\r\n\r\nThe HDI Deployer expects the following file system structure for the HDI content in your `db` module:\r\n\r\n- `src/`: folder which contains your HDI source artifacts\r\n- `cfg/`: optional folder with HDI configuration artifacts\r\n- `package.json`: this file is used by npm (the Node.js package manager) to bootstrap and start the application\r\n\r\nOther files in the root directory will be ignored by `@sap/hdi-deploy`.\r\n\r\nPlease note that the `cfg/` folder also might need a `.hdiconfig` file, e.g. in case `.hdbsynonymconfig` files are placed there.\r\n\r\nIn combination with reusable database modules, the HDI Deployer will also consider database modules which are located in the `node_modules/` folder and which will be mapped to a corresponding sub-folder hierarchy in the container's `lib/` folder.\r\n\r\nNote: The design-time files should be protected against unauthorized modifications to guard against unwanted undeployments or deployment of foreign objects. For applications running on XSA or Cloud Foundry, this is taken care of by the platform.\r\n\r\n## Delta Deployment and Undeploy Allowlist\r\n\r\nThe HDI Deployer implements a delta-based deployment strategy:\r\n\r\nOn startup, the HDI Deployer recursively scans the local `src/` and `cfg/` folders, processes config templates, looks at the HDI container at the server-side and calculates the set of added, modified, and deleted files based on the difference between the local file system state and the deployed file system state of the server-side HDI container.\r\n\r\nIn normal operation, the HDI Deployer will schedule only the set of added and modified files for deployment. The set of deleted files is not scheduled for undeployment.\r\n\r\nIn order to undeploy deleted files, an application needs to include an undeploy allowlist via an `undeploy.json` file in the root directory of the `db` module (right beside the `src/` and `cfg/` folders). The undeploy allowlist `undeploy.json` file is a JSON document with a top-level array of file names. \r\n\"real\" paths, path patterns and path negations are supported.\r\n\r\n`undeploy.json`:\r\n\r\n    [\r\n        \"src/Table.hdbcds\",\r\n        \"src/Procedure.hdbprocedure\",\r\n        \"src/*.hdbtable\",\r\n        \"**/*.hdbtable\",\r\n        \"!**/temp/*.hdbtable\"\r\n    ]\r\n\r\nThe file must list all artifacts which should be undeployed. The file path of the artifacts must be relative to the root directory of the `db` module, must use the HDI file path delimiter '/', and must be based on the HDI server-side folder structure. In case of reusable database modules, the server-side top-level folder `lib/` needs to be used instead of the local folder `node_modules/`.\r\n\r\nFor interactive scenarios, it's possible to pass the `auto-undeploy` option to the HDI Deployer, e.g.\r\n\r\n    node deploy --auto-undeploy\r\n\r\nIn this case, the HDI Deployer will ignore the undeploy allowlist `undeploy.json` file and will schedule all deleted files in the `src/` and `cfg/` folders for undeployment.\r\n\r\n## The default_access_role Role\r\n\r\nWhen an HDI container service instance is created by the SAP HANA Service Broker, for example, service instance `foo` with schema name `FOO`, the broker creates an HDI container named `FOO` (consisting of the run-time schema `FOO` , the HDI metadata and API schema `FOO#DI` , and the object owner `FOO#OO`) and, in addition, the following roles, which are assigned to the application user:\r\n\r\n- FOO::access_role\r\n  A global access role for the run-time schema. This access role is assigned a set of default permissions for the run-time schema: SELECT, INSERT, UPDATE, DELETE, EXECUTE, CREATE TEMPORARY TABLE, and SELECT CDS METADATA on the run-time schema `FOO`.\r\n\r\n- FOO::external_privileges_role\r\n  A role that grants the application user the privileges required to enable access to schemas and objects outside the HDI container, for example, the run-time container `BAR`.\r\n\r\nNote : The roles exist as long as the HDI container exists; they are not lost when the application binding user changes. New binding users are automatically assigned these roles by the broker.\r\n\r\nEvery time the service instance is bound to an application, the service broker creates two new users that are specific to this binding. The first user is the application user who is named user in the instance's credentials. This user is used by the application to access the HDI container's run-time schema `FOO`. This user is assigned the service instance's global access role `FOO::access_role` and the role `FOO::external_privileges_role`. The second user is the HDI API user - named `hdi_user` in the credentials. This user is equipped with privileges for the container's APIs in the `FOO#DI` schema.\r\n\r\nThe following diagram illustrates the binding-specific application users and the role of the global access role (the HDI API users and the bindings for the HDI Deployer are not shown for simplicity):\r\n\r\n```\r\n  +-----------------+    +-----------------+    +-----------------+\r\n  | db module       |    | Node.js module  |    | ... module      |\r\n  | w/ HDI Deployer |    |                 |    |                 |\r\n  +-----------------+    +-----------------+    +-----------------+\r\n\r\n                                  |                      |            o\r\n                                  | --------------------------------- X application user user1\r\n                                  |                      |       o                        \\\r\n                                  |                      | ----- X application user user2  \\\r\n                                  |                      |                           \\      \\\r\n                                                                                      \\      \\\r\n  +---------------------------------------------------------------+           role FOO::access_role\r\n  | HDI container FOO                                             |                   /\r\n  |                                                               | SELECT/INSERT/... on schema FOO\r\n  +---------------------------------------------------------------+\r\n```\r\n\r\nExemplary service binding:\r\n\r\n```\r\n{\r\n   \"hana\" : [ {\r\n     \"name\" : \"foo\",\r\n     \"label\" : \"hana\",\r\n     \"tags\" : [ \"hana\", \"database\", \"relational\" ],\r\n     \"plan\" : \"hdi-shared\",\r\n     \"credentials\" : {\r\n       \"schema\" : \"FOO\",\r\n       \"user\" : \"FOO_345999596729_RT\",\r\n       \"password\" : \"<password>\",\r\n       \"hdi_user\" : \"FOO_645927945801_DT,\r\n       \"hdi_password\" : \"<password>\",\r\n       \"host\" : \"srv1234567.host.name\",\r\n       \"port\" : \"30115\",\r\n       \"db_hosts\" : [ {\r\n         \"port\" : 30115,\r\n         \"host\" : \"srv1234567.host.name\"\r\n       } ],\r\n       \"url\" : \"jdbc:sap://srv1234567.host.name:30115/?currentschema=FOO\",\r\n       \"driver\" : \"com.sap.db.jdbc.Driver\"\r\n     }\r\n   } ]\r\n}\r\n```\r\n\r\nIn order to assign roles from the HDI content to the application binding users (the `user` users), the HDI Deployer implements an automatic assignment of the `default_access_role` role if it is present in the deployed content:\r\n\r\nIf a role definition file exists at the path `src/defaults/default_access_role.hdbrole`, and this file defines a role named `default_access_role`, and this file is included in the deployment (e.g. not excluded via `include-filter`), then the HDI Deployer grants the deployed `default_access_role` role to the service instance's global access role (e.g. `FOO::access_role`). In addition, the HDI Deployer revokes all default permissions (e.g. `SELECT`, `INSERT`, `UPDATE`, `DELETE`, `EXECUTE`, `CREATE TEMPORARY TABLE`, and `SELECT CDS METADATA` (not on SAP HANA Cloud) on the runtime schema `FOO`) from the global access role. If the `default_access_role` is undeployed, the default permission set for the runtime schema will be restored.\r\n\r\nNote:  If you use a `.hdinamespace` file in `src/` which defines a real namespace prefix for subfolders, then you need to put a `.hdinamespace` file with the empty namespace `\"name\" : \"\"` at `src/defaults/` to ensure that the role can be named `default_access_role`.\r\n\r\nThe following diagram illustrates the binding-specific application users, the role of the global access role, and the container-specific default access role:\r\n\r\n```\r\n  +-----------------+    +-----------------+    +-----------------+\r\n  | db module       |    | Node.js module  |    | ... module      |\r\n  | w/ HDI Deployer |    |                 |    |                 |\r\n  +-----------------+    +-----------------+    +-----------------+\r\n\r\n                                  |                      |            o\r\n                                  | --------------------------------- X application user user1\r\n                                  |                      |       o                        \\\r\n                                  |                      | ----- X application user user2  \\\r\n                                  |                      |                           \\      \\\r\n                                                                                      \\      \\\r\n  +---------------------------------------------------------------+           role FOO::access_role\r\n  | HDI container FOO                                             |                      /\r\n  |                                role default_access_role ----------------------------+\r\n  |                                       /         \\             |\r\n  |                                role role1     role role2      |\r\n  |                                   /              /   \\        |\r\n  |                 structured privileges       DCL role 1 / 2    |   \r\n  +---------------------------------------------------------------+\r\n```\r\n\r\nNote: The `default_access_role` is assumed to be an \"umbrella\" role which aggregates other roles.\r\n\r\nA role with the default permission set which is granted by the SAP HANA Service Broker on container creation looks as follows:\r\n\r\n`default_permissions_role.hdbrole`:\r\n\r\n```\r\n{\r\n   \"role\":{\r\n      \"name\":\"default_permissions_role\",\r\n      \"schema_privileges\":[\r\n         {\r\n            \"privileges\":[\r\n               \"SELECT\",\r\n               \"INSERT\",\r\n               \"UPDATE\",\r\n               \"DELETE\",\r\n               \"EXECUTE\",\r\n               \"CREATE TEMPORARY TABLE\",\r\n               \"SELECT CDS METADATA\"\r\n            ]\r\n         }\r\n      ]\r\n   }\r\n}\r\n```\r\n\r\nOn SAP HANA Cloud, \"SELECT CDS METADATA\" is not granted.\r\n\r\n## The development_debug_role Role\r\n\r\nSimilarly to the default_access_role, a development_debug_role can be used to add additional privileges to the access role. This is only intended for development and debugging, not for productive use!\r\n\r\nIf a role definition file exists at the path `src/defaults/development_debug_role.hdbrole`, and this file defines a role named `development_debug_role`, and this file is explicitly included in the deployment via the `--deploy` option, then the HDI Deployer grants the deployed `development_debug_role` role to the service instance's global access role (e.g. `FOO::access_role`).\r\n\r\nIn order to remove the privileges granted this way, the file has to be undeployed.\r\n\r\n## Reusable Database Modules\r\n\r\nIn order to allow that an application uses (parts of) the database persistence of a reusable component inside its own persistence model, the HDI Deployer allows to link/include the design-time files of reusable components in a consuming application in an automated way. This mechanism is based on the Node.js package management mechanism for defining, publishing, and consuming reusable database modules which also supports versioning based on the semantic versioning concepts (cf. http://semver.org).\r\n\r\nA reusable database module is considered to have the same `src/` and `cfg/` folder structure as a normal database module. The `src/.hdiconfig` file is mandatory and used by the module mechanism as an indicator that the `src/` and `cfg/` folders belong to a consumable, reusable database module. In addition, the reusable database module needs to have a `package.json` file which defines the module's name, the module's version, etc.\r\n\r\nA complete reusable database module looks as follows:\r\n\r\n```\r\n/\r\n+-- src/\r\n|   +-- .hdiconfig\r\n|   +-- <source files ...>\r\n+-- cfg/\r\n|   +-- <optional configuration files ...>\r\n+-- package.json\r\n```\r\n\r\nThe `package.json` file contains the module’s name, description, version, repository URL, and the set of files which belong to the module:\r\n\r\n`package.json`:\r\n\r\n```\r\n{\r\n  \"name\": \"module1\",\r\n  \"description\": \"A set of reusable database objects\",\r\n  \"version\": \"1.3.1\",\r\n  \"repository\": {\r\n    \"url\": \"git@your.gitserver:modules/module1.git\"\r\n  },\r\n  \"files\": [\r\n    \"src\",\r\n    \"cfg\",\r\n    \"package.json\"\r\n  ]\r\n}\r\n```\r\n\r\nThe reusable database module should be published to a Node.js package management compliant object repository.\r\n\r\nConsumption of a reusable database module is done by adding a dependency in the consuming module's `package.json` file, right beside the dependency to `@sap/hdi-deploy`:\r\n\r\n```\r\n{\r\n  \"name\": \"deploy\",\r\n  \"dependencies\": {\r\n    \"@sap/hdi-deploy\": \"4.4.1\",\r\n    \"module1\": \"1.3.1\",\r\n    \"module2\": \"1.7.0\"\r\n  },\r\n  \"scripts\": {\r\n    \"start\": \"node node_modules/@sap/hdi-deploy/\"\r\n  }\r\n}\r\n```\r\n\r\nHere, the consuming module requires `module1` in version `1.3.1` and `module2` in version `1.7.0`.\r\n\r\nWhen running `npm install` to download and install the dependencies which are listed in the dependencies section of the `package.json` file, `npm` will also download the reusable database modules and places them into the `node_modules/` folder of the consuming module. For each module a separate subfolder is created with the name of the module.\r\n\r\nWhen the HDI Deployer is triggered to do the actual deployment of the (consuming) database module, it scans the `node_modules/` folder and virtually integrates the `src/` and `cfg/` folders of found reusable database modules into the (consuming) database module’s `lib/` folder. Reusable database modules are identified by the mandatory `src/.hdiconfig` file.\r\n\r\nOn successful deployment, the HDI container will contain the consumed modules below the root-level `lib/` folder, e.g.\r\n\r\n```\r\n/\r\n+-- src/\r\n+-- cfg/\r\n+-- lib/\r\n|   +-- module1/\r\n|   |   +-- src/\r\n|   |   +-- cfg/\r\n|   +-- module2/\r\n|       +-- src/\r\n|       +-- cfg/\r\n```\r\n\r\nFor the time being, it’s not allowed to recursively include reusable database modules.\r\n\r\nThe `cfg/` folders of reusable database modules are also subject to configuration file templating.\r\n\r\n## Configuration File Templating\r\n\r\nThe HDI Deployer implements a templating mechanism for HDI configuration files, e.g. configuration files for synonyms, projection views, etc., based on services which are bound to the `db` module application. By means of this templating mechanism, it is possible to configure synonyms, projection views, etc. to point to the right database schema without knowing the schema name at development time.\r\n\r\nOn startup, the HDI Deployer recursively scans the local `cfg/` folder and picks up all files with a `.*config` suffix, e.g. all `.hdbsynonymconfig`, `.hdbvirtualtableconfig`, etc. files. For all collected files which contain `.configure` markers in their content, it applies the configuration templating and creates transient configuration files which are then deployed to the HDI container.\r\n\r\nFor a synonym configuration file `cfg/LOCAL_TARGET.hdbsynonymconfig`\r\n\r\n    {\r\n        \"LOCAL_TARGET\" : {\r\n            \"target\" : {\r\n                \"schema.configure\"    : \"logical-external-service/schema\",\r\n                \"database.configure\"  : \"logical-external-service/database\",\r\n                \"object\"              : \"TARGET\"\r\n            }\r\n        }\r\n    }\r\n\r\nthe section\r\n\r\n                \"schema.configure\"    : \"logical-external-service/schema\",\r\n                \"database.configure\"  : \"logical-external-service/database\",\r\n                \"object\"              : \"TARGET\"\r\n\r\nwill be transformed by the templating mechanism into\r\n\r\n                \"schema\"              : \"THE_SCHEMA\",\r\n                \"database\"            : \"THE_DATABASE\",\r\n                \"object\"              : \"TARGET\"\r\n\r\nwhere `THE_SCHEMA` and `THE_DATABASE` are the values for the `schema` and `database` fields of the bound service `logical-external-service`, which are denoted by the path expressions`logical-external-service/schema` and `logical-external-service/database`.\r\n\r\nIf a field in the service is missing, it will not be configured and will be removed instead, e.g. `database` might be optional.\r\n\r\nThe names of the services are subject to the service replacements mechanism, which can be used to map a real service, e.g. `real-external-service`, to a logical service name which is used in the configuration files, e.g. `logical-external-service`.\r\n\r\nIt's not always applicable to use `schema.configure`, `database.configure`, etc. in the configuration template files. Therefore, the HDI Deployer provides a generic way of copying a set of properties from the bound service, e.g. schema, database, remote source, etc. if they are present, although the template file doesn't mention them.\r\n\r\nFor the configuration file `cfg/LOCAL_TARGET.hdbsynonymconfig` this could looks as follows:\r\n\r\n    {\r\n        \"LOCAL_TARGET\" : {\r\n            \"target\" : {\r\n                \"*.configure\"         : \"logical-external-service\",\r\n                \"object\"              : \"TARGET\"\r\n            }\r\n        }\r\n    }\r\n\r\nWhen the HDI Deployer encounters a `*.configure` entry, it simply copies all well-known fields which are present in the bound service into the configuration file. The well-known fields are currently `remote`, `database`, and `schema`.\r\n\r\nThe HDI Deployer also supports old-style `.hdbsynonymtemplate` template files: If a `.hdbsynonymtemplate` file is found in the `cfg/` or `src/` folder, then it is processed as a configuration template file and a transient file with the suffix  `.hdbsynonymconfig` is created. A field `grantor` is replaced with the `schema` value from the referenced service; so, a `grantor` field is equivalent to a `\"schema.configure\" : \"the-service/schema\"` entry in a configuration template file.\r\n\r\n## Permissions to Container-External Objects\r\n\r\nAn HDI container is by default equipped with nearly zero database privileges, e.g. the object owner (`#OO` user) is mainly equipped with the `CREATE ANY` privilege on the container's runtime schema (e.g. schema `FOO` for an HDI container `FOO`). Since SAP HANA 2 SPS00, the object owner is equipped with an additional restricted set of privileges for system views in the database's `SYS` schema, e.g. `SYS.VIEWS` or `SYS.TABLES`. These system views apply an additional row-level filter based on the object owner's other privileges, e.g. the object owner can only see metadata in `SYS.VIEWS` for views he has privileges on. So, without additional privileges, the object owner can only see metadata for the objects in his container schema.\r\n\r\nIn order to access database objects inside other database schemata or other HDI containers, and in order to deploy synonyms into the HDI container which point to these container-external objects, at least the object owner needs additional privileges, e.g. for an object `object` in schema `X` `SELECT` privileges on `X.object`:\r\n\r\n```\r\n  +---------------------------------------------------------------+      +------------------------+\r\n  | HDI container FOO                                             |      | other schema X         |\r\n  |                                                synonym ------------------------> object       |\r\n  +---------------------------------------------------/-----------+      +-------------\\----------+\r\n                                                     /                                  \\\r\n                                      o             /                                    \\\r\n                                      X object owner FOO#OO -------------------- SELECT on X.object\r\n```\r\n\r\nPlease also refer to the official [Using Synonyms to Access External Schemas and Objects in XS Advanced](https://help.sap.com/viewer/4505d0bdaf4948449b7f7379d24d0f0d/2.0.02/en-US/bdc9f7ae66134c279a5f3683bba9b361.html) guide.\r\n\r\n#### .hdbrevokes Files\r\n\r\nStarting with version 3.8, the deployer now allows revoking rights. Anything that can be granted via .hdbgrants can be revoked via .hdbrevokes. Both files, .hdbgrants and .hdbrevokes use the same structure.\r\nFor more information on the structure of these files, see the section about [.hdbgrants Files](#hdbgrants-files).\r\n\r\nThe .hdbrevokes file will be processed before the .hdbgrants file.\r\n\r\n#### .hdbgrants Files\r\n\r\nIn order to automatically assign privileges to the object owner and/or the application binding users, the HDI Deployer provides `.hdbgrants` files with a syntax similar to `.hdbrole` files:\r\n\r\nAn `.hdbgrants` file has the following structure:\r\n\r\n`granting-service.hdbgrants`:\r\n\r\n```\r\n{\r\n  \"granting-service\": {\r\n    \"object_owner\": {\r\n      <privileges>\r\n    },\r\n    \"application_user\": {\r\n      <privileges>\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe top-level keys define the names of the bound services which \"grant\" the privileges, these are the \"grantors\", e.g. `granting-service` in the example. The next level defines to which users the privileges will be granted, these are the \"grantees\": `object_owner` is used for the HDI container's object owner, and `application_user` marks the application users which are bound to the application modules, e.g. the Node.js module. The third level defines the set of privileges in a `.hdbrole`-like structure.\r\n\r\nOn startup, the HDI Deployer looks for `.hdbgrants` files and processes them as follows: For each grantor in the file, the HDI Deployer looks up a bound service with the name (subject to service replacements), connects to the database with the service's credentials, and grants the specified privileges to the grantees. If the `schema` field is omitted for a privilege, then the grantor's `schema` property is used. If the `name` field in a `global_object_privileges` element of type `REMOTE SOURCE` is omitted, then the grantor's `remote` property is used.\r\n\r\nFor backwards compatibility, also the suffix `.hdbsynonymgrantor` is supported.\r\n\r\nExample of a `cfg/external-access.hdbgrants` file with some privileges for the object owner:\r\n\r\n```\r\n{\r\n  \"external-access\": {\r\n    \"object_owner\": {\r\n      \"system_privileges\" : [\r\n        {\r\n          \"privileges\" : [ \"SYSTEM_PRIVILEGE_1\" ],\r\n          \"privileges_with_admin_option\" : [ \"SYSTEM_PRIVILEGE_2\", \"SYSTEM_PRIVILEGE_3\" ]\r\n        }\r\n      ],\r\n      \"global_roles\" : [\r\n        {\r\n          \"roles\" : [ \"GLOBAL_ROLE_1\", \"GLOBAL_ROLE_2\" ],\r\n          \"roles_with_admin_option\" : [ \"GLOBAL_ROLE_3\", \"GLOBAL_ROLE_4\" ]\r\n        }\r\n      ],\r\n      \"schema_privileges\" : [\r\n        {\r\n          \"privileges\" : [ \"INSERT\", \"UPDATE\" ],\r\n          \"privileges_with_grant_option\" : [ \"SELECT\" ]\r\n        }\r\n      ],\r\n      \"schema_roles\" : [\r\n        {\r\n          \"roles\" : [ \"SCHEMA_ROLE_1\", \"SCHEMA_ROLE_2\" ],\r\n          \"roles_with_admin_option\" : [ \"SCHEMA_ROLE_3\", \"SCHEMA_ROLE_4\" ]\r\n        }\r\n      ],\r\n      \"object_privileges\" : [\r\n        {\r\n          \"name\": \"AN_OBJECT\",\r\n          \"privileges\": [ \"INSERT\", \"UPDATE\" ],\r\n          \"privileges_with_grant_option\" : [ \"SELECT\" ]\r\n        }\r\n      ],\r\n      \"global_object_privileges\" : [\r\n        {\r\n          \"name\" : \"A_REMOTE_SOURCE\",\r\n          \"type\" : \"REMOTE SOURCE\",\r\n          \"privileges\" : [ \"CREATE VIRTUAL TABLE\" ],\r\n          \"privileges_with_grant_option\" : [ \"CREATE VIRTUAL PROCEDURE\" ]\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe following elements and keys are supported for backwards compatibility or for compatibility with `.hdbrole`:\r\n\r\n- `container_roles`: grant roles from an HDI container; superseded by `schema_roles` which works for normal schemas and HDI containers\r\n```\r\n      \"container_roles\" : [ \"SCHEMA_ROLE_1\", \"SCHEMA_ROLE_2\" ]\r\n```\r\n- `roles`: grant global roles; superseded by `global_roles`:\r\n```\r\n      \"roles\" : [ \"GLOBAL_ROLE_1\", \"GLOBAL_ROLE_2\" ]\r\n```\r\n- string-array-style roles and `names` key (maps to the non-grant/admin-option variant):\r\n```\r\n      \"global_roles\" : [\r\n        \"GLOBAL_ROLE_1\",\r\n        {\r\n          \"roles\" : [ \"GLOBAL_ROLE_1\", \"GLOBAL_ROLE_2\" ]\r\n        },\r\n        {\r\n          \"names\" : [ \"GLOBAL_ROLE_1\", \"GLOBAL_ROLE_2\" ]\r\n        },\r\n        {\r\n          \"roles_with_admin_option\" : [ \"GLOBAL_ROLE_3\", \"GLOBAL_ROLE_4\" ]\r\n        },\r\n        \"GLOBAL_ROLE_2\"\r\n      ]\r\n```\r\n\r\nIf any non-container privileges are used, then the object owner (`#OO` user) will need to be given these privileges WITH GRANT option by a user-defined granting-service. Otherwise it won't be able to grant these privileges to e.g. a role in the container.\r\n\r\n#### Creating a Granting Service\r\n\r\nThe HDI Deployer supports the following types of granting-services:\r\n\r\n- `sql`: a technical database user with GRANT privileges for the required object privileges, roles, system privileges, etc.\r\n- `hdi`: an HDI container with access to the container's GRANT APIs. An HDI container can only grant roles from the container, without admin option.\r\n- `procedure`: a technical database user with EXECUTE privileges on a stored procedure which has GRANT privileges for the required object privileges, roles, system privileges, etc.\r\n- `ignore`: grants were already given at the database-level and the HDI Deployer will ignore the content of the `.hdbgrants` file.\r\n\r\nFor the HDI container case, the corresponding service can simply be bound to the db module application. The HDI Deployer recognizes the bound service by its `hdi_user` value in the credentials section and calls the container's API procedures to grant the privileges from the `.hdbgrants` file.\r\n\r\nIn case a technical database user is used, a 'user-defined service' must be created for this purpose in the same space as the container. The service needs to be set up with the permissions of a specified database user to connect to the database and to grant the privileges specified in the `.hdbgrants` files during application deployment.\r\n\r\nSuch a user-provided service can be created as follows:\r\n\r\n- Open a command shell and log on to XSA:\r\n`xs login`\r\n- Change to the target space where you want to create the user-defined service:\r\n`xs target -s <SPACE>`\r\n- Create the user-defined service (e.g. `grantor-service`):\r\n`xs cups grantor-service -p '{ \"host\": \"host.acme.com\", \"port\": \"30015\", \"certificate\": \"<myCertificate>\", \"user\": \"TARGET_USER\", \"password\": \"Grant_123\", \"schema\": \"TARGET_SCHEMA\", \"tags\": [ \"hana\" ] }'`\r\n  - `\"host\"/\"port\"`: Required for the connection to the database: port is the SQL port of the index server.\r\n  - `\"certificate\"`: If the database is configured to only accept secure connections, then the granting-service requires an SSL certificate that must be included in the user-provided service, for example, using the \"certificate\":\"<myCertificate>\" parameter.\r\n  - `\"user\"/\"password\"`: Connection details for a database user that has grant permissions for the objects in the schema.\r\n  - `\"schema\"`: The database schema that contains the objects to which access is to be granted.\r\n  - `\"type\"`: The type of the grantor mechanism; valid values are `\"hdi\"`, `\"sql\"`, or `\"procedure\"`. If the type is not specified, then the type is auto-sensed (see details below).\r\n- Use the command `xs services` to display a list of services available in the current space; the 'grantor-service' service should be visible.\r\n\r\nFor Cloud Foundry, use the corresponding `cf` commands.\r\n\r\nNote: Starting with version 3.0.0 of the HDI Deployer, the `\"host\"`, `\"port\"`, and `\"certificate\"` parameters are no longer required since they can be obtained from the target container binding. In this case, you must only specify the `\"user\"`, `\"password\"`, and `\"schema\"` when creating the user-provided service, e.g. `xs cups grantor-service -p '{ \"user\": \"TARGET_USER\", \"password\": \"Grant_123\", \"schema\": \"TARGET_SCHEMA\", \"tags\": [ \"hana\" ] }'`.\r\n\r\nIf the `\"type\"` is not specified, then the type is selected based on the following rule: if the field `hdi_user` is present, then the type is auto-sensed as `hdi`; otherwise, the type is set to `sql`.\r\n\r\nIf the technical database user does not have GRANT privileges by its own, but only EXECUTE privileges on a stored procedure which can grant the privileges, then the following settings are required:\r\n\r\n- At the database, a GRANT procedure must exist (or be visible) in the schema which is used in the user-provided service; an example is shown below.\r\n- The technical database user must have EXECUTE privileges on the GRANT procedure.\r\n- The name of the GRANT procedure must be specified in the user-provided service in the `\"procedure\"` field, e.g. `\"procedure\": \"GRANT\"`.\r\n- The scheme name of the GRANT procedure can be specified in the user-provided service in the `\"procedure_schema\"` field, e.g. `\"procedure_schema\": \"A_SCHEMA\"`.\r\n- The user-provided service must contain a `\"type\"` field with the value `\"procedure\"`.\r\n\r\nFor the different types of privileges, the following fields are passed to the GRANT procedure:\r\n\r\n| PRIVILEGE_TYPE | PRIVILEGE_NAME | OBJECT_SCHEMA | OBJECT_NAME | OBJECT_TYPE | GRANTEE_SCHEMA | GRANTEE_NAME | GRANTABLE |\r\n| --- | --- | --- | --- | --- | --- | --- | --- |\r\n| SCHEMA_OBJECT_PRIVILEGE | privilege | schema | object | NULL | NULL | grantee | TRUE/FALSE |\r\n| GLOBAL_OBJECT_PRIVILEGE | privilege | NULL | object | type | NULL | grantee | TRUE/FALSE |\r\n| SCHEMA_ROLE | NULL | schema | role | NULL | NULL | grantee | TRUE/FALSE |\r\n| GLOBAL_ROLE | NULL | NULL | role | NULL | NULL | grantee | TRUE/FALSE |\r\n| SCHEMA_PRIVILEGE | privilege | NULL | schema | NULL | NULL | grantee | TRUE/FALSE |\r\n| SYSTEM_PRIVILEGE | privilege | NULL | NULL | NULL | NULL | grantee | TRUE/FALSE |\r\n\r\nNote: This procedure does not work for SAP HANA1 SPS11, since `REPLACE_REGEXPR` is not supported. Please use the sample procedure provided with older releases of the deployer.\r\nThe old sample procedure does not correctly handle component names of system privileges in .hdbgrants files.\r\n\r\nExample of a GRANT procedure:\r\n\r\n```\r\nCREATE PROCEDURE GRANT(\r\n  IN PRIVILEGES TABLE (\r\n    PRIVILEGE_TYPE NVARCHAR(128), -- 'SCHEMA_OBJECT_PRIVILEGE'\r\n                                  -- 'GLOBAL_OBJECT_PRIVILEGE'\r\n                                  -- 'SCHEMA_ROLE'\r\n                                  -- 'GLOBAL_ROLE'\r\n                                  -- 'SCHEMA_PRIVILEGE'\r\n                                  -- 'SYSTEM_PRIVILEGE'\r\n    PRIVILEGE_NAME NVARCHAR(256), -- cf. SYS.PRIVILEGES\r\n    OBJECT_SCHEMA NVARCHAR(256),  -- NULL or schema\r\n    OBJECT_NAME NVARCHAR(256),\r\n    OBJECT_TYPE NVARCHAR(128),    -- NULL or 'REMOTE SOURCE'\r\n    GRANTEE_SCHEMA NVARCHAR(256), -- NULL or schema\r\n    GRANTEE_NAME NVARCHAR(256),\r\n    GRANTABLE NVARCHAR(5)         -- 'TRUE' or 'FALSE'\r\n  )\r\n)\r\nLANGUAGE SQLSCRIPT\r\nSQL SECURITY DEFINER\r\nAS\r\nBEGIN\r\n  DECLARE ERROR CONDITION FOR SQL_ERROR_CODE 10000;\r\n  DECLARE CURSOR PRIVILEGES_CURSOR FOR SELECT * FROM :PRIVILEGES;\r\n\r\n  -- TODO: add checks for valid grantees, e.g. check with _SYS_DI#<group>.M_CONTAINER_SCHEMAS\r\n  --       or with SYS.USERS and creator and grantee like '%#OO'\r\n  -- TODO: keep only functionality that should be allowed, e.g. only allow to grant schema-local\r\n  --       roles, but no object privileges, etc.\r\n\r\n  FOR PRIVILEGE AS PRIVILEGES_CURSOR\r\n  DO\r\n    DECLARE TO_GRANTEE_CLAUSE NVARCHAR(512);\r\n    DECLARE GRANTABLE_CLAUSE NVARCHAR(512) = '';\r\n\r\n    IF PRIVILEGE.GRANTEE_SCHEMA IS NULL THEN\r\n      TO_GRANTEE_CLAUSE = ' TO \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.GRANTEE_NAME) || '\"';\r\n    ELSE\r\n      TO_GRANTEE_CLAUSE = ' TO \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.GRANTEE_SCHEMA)\r\n                                  || '\".\"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.GRANTEE_NAME) || '\"';\r\n    END IF;\r\n\r\n    IF PRIVILEGE.GRANTABLE = 'TRUE' THEN\r\n      IF PRIVILEGE.PRIVILEGE_TYPE = 'SYSTEM_PRIVILEGE' OR\r\n         PRIVILEGE.PRIVILEGE_TYPE = 'GLOBAL_ROLE' OR\r\n         PRIVILEGE.PRIVILEGE_TYPE = 'SCHEMA_ROLE' THEN\r\n        GRANTABLE_CLAUSE = ' WITH ADMIN OPTION';\r\n      ELSE\r\n        GRANTABLE_CLAUSE = ' WITH GRANT OPTION';\r\n      END IF;\r\n    ELSEIF PRIVILEGE.GRANTABLE != 'FALSE' THEN\r\n      SIGNAL ERROR SET MESSAGE_TEXT = 'unsupported value for GRANTABLE: '\r\n                                      || PRIVILEGE.GRANTABLE;\r\n    END IF;\r\n\r\n    IF PRIVILEGE.PRIVILEGE_TYPE = 'SCHEMA_OBJECT_PRIVILEGE' THEN\r\n      EXEC 'GRANT \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.PRIVILEGE_NAME) || '\"'\r\n        || ' ON \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_SCHEMA)\r\n                   || '\".\"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_NAME) || '\" '\r\n        || TO_GRANTEE_CLAUSE\r\n        || GRANTABLE_CLAUSE;\r\n    ELSEIF PRIVILEGE.PRIVILEGE_TYPE = 'GLOBAL_OBJECT_PRIVILEGE' THEN\r\n      IF PRIVILEGE.OBJECT_TYPE = 'REMOTE SOURCE' THEN\r\n        EXEC 'GRANT \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.PRIVILEGE_NAME) || '\"'\r\n          || ' ON ' || PRIVILEGE.OBJECT_TYPE || ' \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_NAME) || '\" '\r\n          || TO_GRANTEE_CLAUSE\r\n          || GRANTABLE_CLAUSE;\r\n      ELSE\r\n        SIGNAL ERROR SET MESSAGE_TEXT = 'unsupported value for OBJECT_TYPE for GLOBAL_OBJECT_PRIVILEGE: '\r\n                                        || PRIVILEGE.OBJECT_TYPE;\r\n      END IF;\r\n    ELSEIF PRIVILEGE.PRIVILEGE_TYPE = 'SCHEMA_ROLE' THEN\r\n      EXEC 'GRANT \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_SCHEMA)\r\n                     || '\".\"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_NAME) || '\" '\r\n        || TO_GRANTEE_CLAUSE\r\n        || GRANTABLE_CLAUSE;\r\n    ELSEIF PRIVILEGE.PRIVILEGE_TYPE = 'GLOBAL_ROLE' THEN\r\n      EXEC 'GRANT \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_NAME) || '\" '\r\n        || TO_GRANTEE_CLAUSE\r\n        || GRANTABLE_CLAUSE;\r\n    ELSEIF PRIVILEGE.PRIVILEGE_TYPE = 'SCHEMA_PRIVILEGE' THEN\r\n      EXEC 'GRANT \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.PRIVILEGE_NAME) || '\"'\r\n        || ' ON SCHEMA \"' || ESCAPE_DOUBLE_QUOTES(PRIVILEGE.OBJECT_NAME) || '\" '\r\n        || TO_GRANTEE_CLAUSE\r\n        || GRANTABLE_CLAUSE;\r\n    ELSEIF PRIVILEGE.PRIVILEGE_TYPE = 'SYSTEM_PRIVILEGE' THEN\r\n      EXEC 'GRANT \"' || REPLACE_REGEXPR('\\.' IN ESCAPE_DOUBLE_QUOTES(PRIVILEGE.PRIVILEGE_NAME) WITH '\".\"') || '\"'\r\n        || TO_GRANTEE_CLAUSE\r\n        || GRANTABLE_CLAUSE;\r\n    ELSE\r\n      SIGNAL ERROR SET MESSAGE_TEXT = 'unsupported value for PRIVILEGE_TYPE: '\r\n                                      || PRIVILEGE.PRIVILEGE_TYPE;\r\n    END IF;\r\n  END FOR;\r\nEND;\r\n```\r\n\r\n#### Defining the Granting Service in the mta[d].yaml\r\n\r\nIf the container needs a granting-service, then besides the service itself, the Application Development Descriptor mta.yaml needs to be adjusted for the deployer to be able to find the service. The mta.yaml must be modified to:\r\n\r\n1. The container of the `db` module needs to get a `TARGET_CONTAINER` property to mark the service that corresponds to the container\r\n2. A new entry in `requires` is added for the granting-service\r\n3. A new entry in `resources` is added for the granting-service\r\n\r\nExample:\r\n`mta.yaml`:\r\n\r\n```\r\nschema-version: '2.0'\r\nID: granting-service-example\r\nversion: 0.0.1\r\n\r\nmodules:\r\n  - name: db\r\n    type: hdb\r\n    path: db\r\n    requires:\r\n      - name: hdi-container\r\n        properties:                                     # 1.\r\n          TARGET_CONTAINER: ~{hdi-container-service}    # 1.\r\n          \r\n      - name: granting-service                          # 2.\r\n          \r\nresources:\r\n  - name: hdi-container\r\n    type: com.sap.xs.hdi-container\r\n    properties:\r\n      hdi-container-service: ${service-name}        \r\n\r\n  - name: granting-service                              # 3.\r\n    type: org.cloudfoundry.existing-service             # 3.\r\n```\r\n\r\n## Environment Variables for Applications\r\n\r\n`@sap/hdi-deploy` supports (re-)configuration via the following environment variables which are exposed to applications, e.g. via the CF/XSA `manifest.yml` or the MTA descriptor `mta.yaml`:\r\n\r\n- `TARGET_CONTAINER`: (optional) service name that specifies the HDI target container (needed, if more than one HDI service is bound to the HDI Deployer)\r\n- `SERVICE_REPLACEMENTS`: (optional) JSON-structured list of service replacements, e.g. `[ { \"key\": \"logical-service-name-1\", \"service\":\"real-service-name-1\"}, { \"key\": \"logical-service-name-2\", \"service\":\"real-service-name-2\"} ]`, where the logical service names refer to the names in the HDI content and the real service names refer to the services which are bound to the HDI Deployer via `VCAP_SERVICES`; if the HDI content references a service name which is not listed in the replacements, then this name is used as a real service name\r\n\r\nThe structure of the `SERVICE_REPLACEMENTS` environment variable is based on the MTA specification in order to enable MTA group assignments.\r\n\r\nExample `manifest.yml`:\r\n\r\n    applications:\r\n    - name: app-db\r\n      path: db\r\n      health-check-type: process\r\n      services:\r\n        - app-database\r\n        - real-grantor-service\r\n        - real-external-service\r\n      env:\r\n        TARGET_CONTAINER: app-database\r\n        SERVICE_REPLACEMENTS: >\r\n        [\r\n          {\r\n            \"key\"     : \"logical-grantor-service\",\r\n            \"service\" : \"real-grantor-service\"\r\n          },\r\n          {\r\n            \"key\"     : \"logical-external-service\",\r\n            \"service\" : \"real-external-service\"\r\n          }\r\n        ]\r\n\r\n## Environment Variables for Infrastructure / Development Tools\r\n\r\n`@sap/hdi-deploy` supports (re-)configuration via the following environment variables for infrastructure / development tools like the Deploy Service or internal build tools of the WEB IDE\r\n\r\n- `EXIT`: (optional) if set, the HDI Deployer will exit when the deployment is done; using the environment variable is equivalent to passing a `--exit` on the command line\r\n- `DEPLOY_ID`: (optional) if set, the given id will be written to the final application log entry (custom id, to support processes in parsing log output\r\n- `HDI_DEPLOY_OPTIONS`: (optional) JSON-structured set of options for the HDI Deployer, e.g. `{ \"auto_undeploy\" : true, \"exit\" : true, \"root\" : \"/volumes/A/workspaces/B/db/\", \"include_filter\" : [ \"src/\", \"cfg/\" ] }`; command line options can be translated to `HDI_DEPLOY_OPTIONS` options by replacing the `-`s in the option names with `_`s; options which can accept multiple values require a JSON array with the values, e.g. path options like the include-filter option.\r\n- `APPLICATION_ID`: (optional, fallback `SAP_HDI`) this will be used, in conjunction with the `space_name` and the `organization_name` of the `VCAP_APPLICATION` to set the session variable `APPLICATION` for all connections to the database. This setting may only be used by applications from SAP.\r\n- `APPLICATION_VERSION_INFO`: (optional) this will be logged to the command line, to allow logging of some additional information about the application.\r\n\r\nOptions from `HDI_DEPLOY_OPTIONS` override options which are passed on the command line.\r\n\r\n## Ignore List\r\nThe hdi deployer supports ignoring certain files via an `.hdiignore` file. The file has to be placed at the root of the project folder, just like the `undeploy.json`.\r\nThe file has a structure similar to a `.gitignore` file, simply lines of texts specifying the paths to exclude. Both \"real\" paths and path patterns are supported.\r\n```\r\nsrc/table_1.hdbtable\r\nsrc/*_2.hdbtable\r\n```\r\n\r\nThe file works just like the `--exclude-filter` option and they can be used at the same time.\r\n\r\n## Options for Interactive Scenarios\r\n\r\n`@sap/hdi-deploy` supports the following options for interactive deployment scenarios, e.g. for orchestration via the WEB IDE or for CI scripts:\r\n\r\n- `--version`: print version and exit\r\n- `-t, --trace`: enable tracing\r\n- `--use-hdb`: enable the \"hdb\" client to connect to the database instead of \"@sap/hana-client\"; by default \"@sap/hana-client\" is used\r\n- `--hana-client-trace`: enable tracing for the SAP HANA client; All interactions with the SAP HANA server will be traced which can lead to a large amount of trace information to be written\r\n- `--hana-client-packet-trace`: enable PACKET tracing for the SAP HANA client; Must only be used in combination with --hana-client-trace\r\n- `--[no-]verbose`: [don't] print detailed log messages to the console\r\n- `--structured-log <file>`: write log messages as JSON objects into the given file; messages are appended if the file already exists\r\n- `--[no-]exit`: [don't] exit after deployment of artifacts\r\n- `--[no-]lock-container`: [don't] acquire the container lock while working with the container\r\n- `--root <path>`: use the given root path for artifacts\r\n- `--working-set [<path> ..]`: define the given paths (directories and files) as the working set; a non-default working set applies additional restrictions, e.g. other options might be disallowed\r\n- `--include-filter [<path> ..]`: only include the given paths (directories and files) during delta detection\r\n- `--deploy [<file> ..]`: explicitly schedule the given files for deploy; extends the `include-filter` for collecting local files. Instead of a real path, a path pattern like src/**/*.hdbtable can be used as well.\r\n- `--[no-]treat-unmodified-as-modified`: [don't] treat unmodified files during delta detection as modified files\r\n- `--undeploy [<file> ..]`: explicitly schedule the given files for undeploy\r\n- `--parameter [<key>=<value> ..]`: pass the given list of key-value parameters to the deployment\r\n- `--path-parameter [<path>:<key>=<value> ..]`: pass the given list of path-key-value parameters to the deployment\r\n- `--[no-]auto-undeploy`: [don't] undeploy artifacts automatically based on delta detection and ignore the `undeploy.json` file\r\n- `--[no-]treat-warnings-as-errors`: [don't] treat warnings as errors\r\n- `--[no-]validate-external-dependencies`: [don't] start a make, even if no files are in the deploy/undeploy sets; all deployed synonyms, projection views, and virtual tables in the container will be checked for changes to referenced objects and redeployed, if a change is detected.\r\n- `--[no-]simulate-make`: [don't] simulate the make and skip post-make activities; pre-make activities still take effect, e.g. grants\r\n- `--connection-timeout <ms>`: number of milliseconds to wait for the database connection(s)\r\n- `--delete-timeout <ms>`: number of milliseconds to wait for the DELETE call\r\n- `--write-timeout <ms>`: number of milliseconds to wait for the WRITE call\r\n- `--lock-container-timeout <ms>`: number of milliseconds to wait for the container lock\r\n- `--exclude-filter [<path> ..]`: exclude the given paths during: file walk, delta detection and when explicitly scheduled via --(un)deploy\r\n- `--[no-]treat-wrong-ownership-as-errors`: [don't] treat wrong ownership of objects as errors, not enabled by default\r\n- `--[no-]migrationtable-development-mode`: [don't] pass the development mode flag for migration tables to HDI, if the parameter is supported by the server, not enabled by default\r\n- `--[no-]liveness-ping`: [don't] send a sign of life from time to time, by default, a sign of life will be sent\r\n- ` --[no-]live-messages`: [don't] display the make messages while the make is still in progress, by default, the messages will be displayed while the make is in progress\r\n\r\nSee `--help` for details and defaults.\r\n\r\nOptions can also be passed to `@sap/hdi-deploy` via the `HDI_DEPLOY_OPTIONS` environment variable.\r\n\r\n## Supported Features\r\n\r\n`@sap/hdi-deploy` exposes its set of features via the `info` option, which can be passed as `--option` or via `HDI_DEPLOY_OPTIONS`, e.g.\r\n\r\n    node deploy --info [<component> [<component> [...]]]\r\n\r\nwhere a list of components can be specified.\r\n\r\nThe `info` option allows to pass multiple components. The `info` request for these components is optional, e.g. if the HDI Deployer doesn't support the component, then it will not throw an error, but simply not return information for that component. The special component `all` will return the information for all known components; `all` is the default if no component is specified. For certain future components, e.g. `server`, the HDI Deployer might need to connect to the HDI container in the database and retrieve feature information from there.\r\n\r\nExamples:\r\n\r\n```\r\nnode deploy --info all\r\nnode deploy --info client server\r\n```\r\n\r\nThe result of an `info` call is a JSON document where the top-level objects correspond to the requested components. Each component should at least report its name, its version, and the set of supported features with name and version number (version numbers are simple numbers (no dots, no double-dots)).\r\n\r\nIf a version number is negative, then the feature is supported by the client, but not supported by the server.\r\n\r\nFor a `--info client` call, the document looks as follows:\r\n\r\n```\r\n{\r\n    \"client\": {\r\n        \"name\": \"@sap/hdi-deploy\",\r\n        \"version\": \"4.4.1\",\r\n        \"features\": {\r\n            \"info\": 2,\r\n            \"verbose\": 1,\r\n            \"structured-log\": 1,\r\n            \"lock-container\": 1,\r\n            \"default-access-role\": 1,\r\n            \"grants\": 4,\r\n            \"working-set\": 1,\r\n            \"include-filter\": 1,\r\n            \"deploy\": 1,\r\n            \"treat-unmodified-as-modified\": 1,\r\n            \"undeploy\": 1,\r\n            \"parameter\": 1,\r\n            \"path-parameter\": 1,\r\n            \"treat-warnings-as-errors\": 1,\r\n            \"validate-external-dependencies\": 1,\r\n            \"simulate-make\": 1,\r\n            \"service-replacements\": 1,\r\n            \"modules\": 2,\r\n            \"config-templates\": 2,\r\n            \"environment-options\": 1,\r\n            \"undeploy-allowlist\": 1\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nFor the `server` component, the document would also contain the following data:\r\n\r\n```\r\n{\r\n...\r\n    \"server\": {\r\n        \"name\": \"sap-hana-database\",\r\n        \"version\": \"1.00.120.04.0000000000\",\r\n        \"features\": {}\r\n    }\r\n}\r\n```\r\n\r\n\r\n## Deployment via hdi-dynamic-deploy\r\n\r\nThe standard XSA/CF way for deploying HDI content at runtime is to make use of @sap/hdi-dynamic-deploy instead of @sap/hdi-deploy directly. The @sap/hdi-dynamic-deploy app is an http server that calls @sap/hdi-deploy when it receives a corresponding HTTP POST request. See the @sap/hdi-dynamic-deploy module for more information.\r\n\r\n## Using hdi-deploy as a Node.js library\r\n\r\nSince version 3.3.0 of @sap/hdi-deploy it is also possible to use it as a Node.js library. By requiring the library.js file from the project root it is possible to start the deployer app from within another Node.js app. The module exports the function\r\n\r\n```\r\nfunction deploy(contentDir, deployerEnv, callback, io)\r\n```\r\n\r\nwith the following parameters:\r\n\r\n- `contentDir`: string containing a path pointing to the root of the db module to be deployed\r\n- `deployerEnv`: javascript object containing the OS environment for the call to the deployer (e.g. containing VCAP_SERVICES)\r\n- `callback`: a standard callback of the form (errors, result), where result is the result of the call to the deployer of the form:\r\n\r\n```\r\n{\r\n  messages: [<list of result messages from the di server>],\r\n  exitCode: <exit code of the call to the deployer app, one of -1, 0, 1.>,\r\n  signal: <signal that the child process was closed with>\r\n}\r\n```\r\n  \r\n- `io` (optional): javascript object containing two callback functions `io.stdoutCB` and `io.stderrCB` of the form `function(data)` for streaming stdout and stderr of the call to the deployer, defaults to piping stdout and stderr of the deployer to stdout and stderr of the calling Node.js app\r\n\r\nThe exit codes have different meanings:\r\n\r\n- -1: The child process was most likely killed externally, check the signal property for details.\r\n- 0: Deployment done succesfully.\r\n- 1: Deployment failed, errors occurred.\r\n\r\nThe signal property is only set, if exitCode is -1.\r\n"}]