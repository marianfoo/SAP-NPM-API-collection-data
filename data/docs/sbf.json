[{"name":"CHANGELOG.md","content":"# Change Log\r\nAll notable changes to this project will be documented in this file.\r\n\r\nThis project adheres to [Semantic Versioning](http://semver.org/).\r\n\r\nThere are _incompatible changes_ between _major_ versions.\r\nSee the [migration guide](migration.md) how to adapt.\r\n\r\nThe format is based on [Keep a Changelog](http://keepachangelog.com/).\r\n\r\n<a name=\"6.4.10\"></a>\r\n## 6.4.10 - 2022-06-18\r\n\r\n### Fixed\r\n- dependencies version update.\r\n\r\n<a name=\"6.4.9\"></a>\r\n## 6.4.9 - 2022-06-02\r\n\r\n### Changed\r\n- Relevant for XSUAA scenarios: `authorities` provided by the consumer are ignored and overriden by `extend_xssecurity`. If `extend_xssecurity` is not provided, SBF will pass an empty `authorities` array. <br/>Set the new `secureUAAScopes` option (or environment variable `SBF_SECURE_UAA_SCOPES`) **explicitly** to `false`, in order to pass the authorities array provided by the consumer as is. **This behavior and environment variable form an incompatible change**.\r\n\r\n### Fixed\r\n- Fixed leaking of headers in logged messages in XSUAA scenarios.\r\n- Fixed support for clientx509enabled for K8S apps, where XSUAA credentials are mounted as files.\r\n\r\n<a name=\"6.4.8\"></a>\r\n## 6.4.8 - 2022-05-24\r\n\r\n### Fixed\r\n- support error response with different struct   \r\n \r\n<a name=\"6.4.7\"></a>\r\n## 6.4.7 - 2022-05-18\r\n\r\n### Changed\r\n- Switch from deprecated Request package to Axios Package\r\n\r\n### Removed\r\n- Remove npm-shrinkwrap.json\r\n\r\n<a name=\"6.4.6\"></a>\r\n## 6.4.6 - 2022-04-17\r\n\r\n### Fixed\r\n- Updates to dependency versions \r\n\r\n<a name=\"6.4.5\"></a>\r\n## 6.4.5 - 2022-03-21\r\n\r\n### Added\r\n- Updates to dependency versions \r\n\r\n<a name=\"6.4.4\"></a>\r\n## 6.4.4 - 2022-01-24\r\n\r\n### Added\r\n- Updates to dependency versions \r\n\r\n<a name=\"6.4.3\"></a>\r\n## 6.4.3 - 2022-01-19\r\n\r\n### Added\r\n- Updates to dependency versions \r\n\r\n<a name=\"6.4.2\"></a>\r\n## 6.4.2 - 2021-11-25\r\n\r\n### Added\r\n- Get certurl field from xsuaa binding \r\n\r\n<a name=\"6.4.1\"></a>\r\n## 6.4.1 - 2021-11-10\r\n\r\n### Added\r\n- mTls fixes\r\n\r\n<a name=\"6.4.1\"></a>\r\n## 6.4.0 - 2021-09-26\r\n\r\n### Added\r\n- Out-of-the-Box mTLS\r\n- Customized mTLS \r\n\r\n\r\n<a name=\"6.3.1\"></a>\r\n## 6.3.1 - 2021-08-22\r\n\r\n### Added\r\n- fix for auditlog oauth2 plan\r\n\r\n<a name=\"6.3.0\"></a>\r\n## 6.3.0 - 2021-08-22\r\n\r\n### Added\r\n- Updating audit-logging to support oauth2 plan\r\n- Adapt to XSUAA's new mtls (x.509) security descriptor\r\n\r\n<a name=\"6.2.13\"></a>\r\n## 6.2.13 - 2021-08-13\r\n\r\n### Added\r\n- fix ambiguity error when SBF_CREDENTIALS_PROVIDER_SERVICE is set\r\n- allow brokers to be configured with tls and no basic authentication\r\n\r\n<a name=\"6.2.12\"></a>\r\n## 6.2.12 - 2021-07-25\r\n\r\n### Added\r\n- Allow specification of x509 parameters when binding\r\n\r\n<a name=\"6.2.11\"></a>\r\n## 6.2.11 - 2021-06-22\r\n\r\n### Added\r\n- fix to instance parameters endpoint\r\n\r\n<a name=\"6.2.10\"></a>\r\n## 6.2.10 - 2021-05-05\r\n\r\n### Added\r\n- fetch instance parameters endpoint and hook\r\n\r\n<a name=\"6.2.9\"></a>\r\n## 6.2.9 - 2021-03-16\r\n\r\n### Added\r\n- update prepareRelease command\r\n\r\n<a name=\"6.2.8\"></a>\r\n## 6.2.8 - 2021-03-15\r\n\r\n### Added\r\n- Add --production flag to npm shrinkwrap \r\n\r\n<a name=\"6.2.7\"></a>\r\n## 6.2.7 - 2021-03-04\r\n\r\n### Added\r\n- Updates to dependency versions\r\n\r\n<a name=\"6.2.6\"></a>\r\n## 6.2.6 - 2021-03-02\r\n\r\n### Added\r\n- Updates to dependency versions\r\n\r\n<a name=\"6.2.5\"></a>\r\n## 6.2.5 - 2021-02-03\r\n\r\n### Added\r\n- Updates to dependency versions\r\n\r\n<a name=\"6.2.4\"></a>\r\n## 6.2.4 - 2021-01-11\r\n\r\n### Added\r\n- Support Node v14\r\n\r\n<a name=\"6.2.3\"></a>\r\n## 6.2.3 - 2020-12-16\r\n\r\n### Added\r\n- Support IAS authentication in node-sbf\r\n\r\n<a name=\"6.2.2\"></a>\r\n## 6.2.2 - 2020-09-24\r\n\r\n### Fixed\r\n- Updates to dependency versions\r\n\r\n<a name=\"6.2.1\"></a>\r\n## 6.2.1 - 2020-07-30\r\n\r\n### Fixed\r\n- Updates to dependency versions\r\n\r\n<a name=\"6.2.0\"></a>\r\n## 6.2.0 - 2020-04-30\r\n\r\n### Added\r\n- Support for XSUAA clone update\r\n- Expose `tenantId` in `onProvision` and `onUpdate` hooks via the `xsuaa` property\r\n- `callXsuaa` - add `baseUrlProperty` option to specify base URL\r\n\r\n### Fixed\r\n- Properly filter `access_token` information in debug log\r\n\r\n<a name=\"6.1.0\"></a>\r\n## 6.1.0 - 2020-03-12\r\n\r\n### Added\r\n- Built-in health HTTP endpoint\r\n\r\n<a name=\"6.0.0\"></a>\r\n## 6.0.0 - 2020-01-17\r\n\r\n### Added\r\n- Support authentication using X.509 client certificates (externally managed)\r\n- Support running on K8S\r\n\r\n### Removed\r\n- Support for Node.js 6.x\r\n\r\n### Fixed\r\n- User friendlier error message for XSUAA timeouts\r\n- Removed deprecated XSUAA endpoint from tests\r\n- Updated @sap/xsenv to v2.2.0\r\n\r\n<a name=\"5.1.1\"></a>\r\n## 5.1.1 - 2019-07-11\r\n\r\n### Fixed\r\n- Updated `lodash` to 4.17.13\r\n\r\n<a name=\"5.1.0\"></a>\r\n## 5.1.0 - 2019-06-14\r\n\r\n### Added\r\n- Support authentication using X.509 client certificates (certificates managed by XSUAA).\r\n\r\n### Fixed\r\n- Updated dependencies.\r\n\r\n<a name=\"5.0.0\"></a>\r\n## 5.0.0 - 2019-05-21\r\n\r\n### Changed\r\n- Setting the provider tenant (see *Added* section) is mandatory when a broker is running on Cloud Foundry and audit logging is enabled.\r\nThe value is automatically detected (no error will be thrown if not explicitly provided) in case `autoCredentials` is `true` and the broker is using XSUAA as credentials provider.\r\n\r\n### Fixed\r\n- Duplicate `app_host_id`s are removed in a response to a bind request.\r\n- Remove the catalog suffix from `service_id` and `plan_id` for update instance requests (part of [`previous_values`](https://github.com/openservicebrokerapi/servicebroker/blob/v2.14/spec.md#previous-values-object)).\r\n\r\n### Added\r\n- `SBF_TENANT_ID` environment variable and `tenantId` option for providing a tenant (of the provider) for audit logging.\r\n- Node.js 10 support. **Note**: To use SBSS on HANA with Node.js 10, a version of `@sap/hdbext` (a peer dependency) that supports Node 10 should be added to application's dependencies. Refer to the *package.json* file of the corresponding `@sap/sbss` version for the version range of `@sap/hdbext`.\r\n\r\n<a name=\"4.2.0\"></a>\r\n## 4.2.0 - 2019-03-27\r\n\r\n### Added\r\n- Improvements in documentation.\r\n- Possibility to add/extend `app_host_id` in the `onBind` hook.\r\n- Return `sap.cloud.service.alias` property from the service metadata as part of the credentials.\r\n- Support for multiple 'html5-apps-repo' service bindings from the environment.\r\n\r\n### Fixed\r\n- Search in the environment for 'html5-apps-repo' instances by the 'html5-apps-repo-dt' tag instead of 'html5-apps-repo-rt'.\r\n- Updated dependencies.\r\n\r\n<a name=\"4.1.0\"></a>\r\n## 4.1.0 - 2019-01-30\r\n\r\n### Added\r\n- Expose credential providers\r\n\r\n### Fixed\r\n- Docu: add `SBF_SBSS_RESTRICTED_USER_SERVICE` to the list of environment variables\r\n\r\n<a name=\"4.0.0\"></a>\r\n## 4.0.0 - 2019-01-18\r\n\r\n### Changed\r\n- _@sap/sbf_ now depends on _@sap/sbss_ v4 which no longer brings the _@sap/hdbext_ package by default.\r\nBrokers that use SBSS on HANA need to explicitly specify _@sap/hdbext_ as a dependency.\r\n\r\n### Fixed\r\n- Added Node 8 to list of supported versions\r\n\r\n<a name=\"3.3.1\"></a>\r\n## 3.3.1 - 2019-01-11\r\n\r\n### Fixed\r\n- Typo: property `saasregistryenable` is now renamed to `saasregistryenabled`\r\n\r\n<a name=\"3.3.0\"></a>\r\n## 3.3.0 - 2019-01-08\r\n\r\n### Added\r\n- Support for `subaccount_id` in SBSS on PostgreSQL\r\n\r\n### Fixed\r\n- Using empty string as user name during audit logging on Kubernetes\r\n\r\n<a name=\"3.2.0\"></a>\r\n## 3.2.0 - 2018-12-04\r\n\r\n### Added\r\n- Support for Business Service\r\n- Improvements in documentation\r\n\r\n<a name=\"3.1.0\"></a>\r\n## 3.1.0 - 2018-10-25\r\n\r\n### Added\r\n- Utility function to make HTTP calls to XSUAA\r\n- Specify catalog.json file via `SBF_CATALOG_FILE` environment variable\r\n- Improvements in documentation\r\n\r\n## 3.0.0 - 2018-09-20\r\n\r\n### Changed\r\n- Version 4 of the _@sap/logging_ package is now used. The `requestId` property is no longer available in `params.req.loggingContext` (in custom hooks). Use the `correlationId` for correlating log entries from different components involved in a broker operation.\r\n\r\n### Added\r\n- Support for CF Log format (via adopting _@sap/logging_ v4).\r\n- Provisioning with XSUAA credentials provider: use `subaccount_id` if provided.\r\n\r\n### Fixed\r\n- Validation of update requests.\r\n- Updated dependencies.\r\n\r\n## 2.1.2 - 2018-08-14\r\n\r\n### Fixed\r\n - Updated dependencies\r\n - Validation of provision and bind requests\r\n\r\n## 2.1.1 - 2018-07-27\r\n\r\n### Fixed\r\n - Update 'request' to v2.87.0\r\n\r\n## 2.1.0 - 2018-06-07\r\n\r\n### Added\r\n - 'user_id' and 'originating_identity' properties are available in custom hooks\r\n - 'req' object is available in custom hooks\r\n - New \"Audit logging\" section in README.md\r\n - Support for OSB API context\r\n\r\n### Fixed\r\n - Enhanced example applications\r\n - Propagate some XSUAA errors to the client\r\n - Updated dependencies\r\n\r\n## 2.0.0 - 2018-04-12\r\n\r\nSee the [migration guide](migration.md) how to adapt to incompatible changes.\r\n\r\n### Changed\r\n- Audit log service integration (**Incompatible**)\r\n- PostgreSQL restricted user support (**Incompatible**)\r\n- Reverse the order of operations during unbind and deprovision (**Incompatible**)\r\n- X-Broker-API-version header is now mandatory (**Incompatible**)\r\n\r\n### Removed\r\n- The old format where `xsappname` and the other security properties appear on root level is removed when creating a service instance (**Incompatible**)\r\n\r\n### Added\r\n- Enforce secure outgoing connections via environment variable `SBF_SECURE_OUTGOING_CONNECTIONS`\r\n- Configure timeout for requests to XSUAA via environment variable `SBF_UAA_TIMEOUT`\r\n- New \"Error handling\" section in README.md\r\n- Memory consumption sizing guide\r\n- Documented how to limit heap size\r\n\r\n## 1.5.0 - 2017-12-12\r\n\r\n### Added\r\n- Allow to set scopes/authorities per service/plan with environment variable\r\n- New section in the readme about asynchronous broker operations\r\n\r\n### Fixed\r\n- Propagate some XSUAA errors to the client side\r\n- Change X-Broker-Api-Version check in order to work with XSA\r\n\r\n## 1.4.0 - 2017-10-25\r\n\r\n### Added\r\n- Add support for hashed broker password\r\n- Script for generating hashed broker password\r\n- Allow to embed SBF in an express.js application\r\n- Support new SBSS version\r\n- Script for generating unique ids in service catalog\r\n- Pass generated credentials to the `onBind` hook\r\n- Java examples\r\n- Added \"Security\" section in README.md\r\n- Verify service catalog for consistency\r\n- Log warning if broker password is shorter than 15 characters\r\n\r\n### Fixed\r\n- Deprovision does not fail if UAA cloning is already deleted (Allow to retry deprovision operation)\r\n- Properly encode URL parameters in outbound requests\r\n\r\n## 1.3.0 - 2017-08-16\r\n\r\n### Added\r\n- Allow for custom parameters in create service operation\r\n- New section in the readme about providing custom parameters\r\n- Simple example to register the broker automatically with MTA descriptor\r\n\r\n## 1.2.0 - 2017-08-03\r\n\r\n### Added\r\n- Troubleshooting section in the readme\r\n- New section in the readme about extending the service broker\r\n- Example for OAuth authentication with client credentials grant\r\n- Example for OAuth authentication with user token grant\r\n- Example using MTA and deploy service\r\n- Provide catalog suffix via broker URL\r\n\r\n## 1.1.0 - 2017-06-02\r\n\r\n### Added\r\n- OAuth authentication with UAA\r\n\r\n## 1.0.1 - 2017-05-18\r\n\r\n### Fixed\r\n- Broker will fail if `serviceConfig` contains service that is not defined in *catalog.json*\r\n- Only `onBind` hook is required to be implemented if `autoCredentials: false`\r\n"},{"name":"migration.md","content":"# Migration Guide\r\n\r\n## Version 4 ==> Version 5\r\n\r\nWhen a broker is running on Cloud Foundry, audit logging is enabled and SBSS is used as credentials provider or `autoCredentials` is `false`,\r\nthe provider tenant should be explicitly set for audit logging purposes.\r\nProviding a value when a broker is running on XS advanced is optional.\r\n\r\n## Version 3 ==> Version 4\r\n\r\n### Dependency to _@sap/sbss_\r\n\r\n_@sap/sbf_ now depends on _@sap/sbss_ v4 which no longer brings the _@sap/hdbext_ package by default.\r\nBrokers that use SBSS on HANA need to explicitly specify _@sap/hdbext_ as a dependency.\r\nRefer to the _package.json_ file of _@sap/sbss_, property _peerDependencies_\r\nfor the accepted version range for _@sap/hdbext_.\r\n\r\n## Version 2 ==> Version 3\r\n\r\n### Log context provided in hooks\r\n\r\nThe `params` provided to hooks contain a `req` property to which _@sap/logging_ attaches a `loggingContext`.\r\nNow _@sap/sbf_ uses v4 of the logging library and there are several incompatibilities in the `loggingContext`.\r\n`requestId` has been removed. Use the `correlationId` for correlating log entries produced by\r\ndifferent components involved in a broker operation.\r\nMore information is available in the documentation of the _@sap/logging_ package.\r\n\r\n## Version 1 ==> Version 2\r\n\r\n\r\n### Order of operations\r\n\r\nThe order of operations during unbind and deprovision is reversed. For more information see hooks section in [README.md](README.md#hooks)\r\n\r\n### Mandatory Audit log service\r\n\r\nAudit log service binding is required in order to start the SBF. See [README.md](README.md#create-audit-log-service-instance)\r\nIt can be disabled by explicitly setting the environment variable `SBF_ENABLE_AUDITLOG` or via `enableAuditLog` option of `ServiceBroker` constructor.\r\n\r\n```js\r\n  ...\r\n  let broker = new ServiceBroker({\r\n    enableAuditLog: false\r\n  });\r\n  ...\r\n  let server = broker.start();\r\n```\r\n\r\n### Mandatory X-Broker-API-Version header\r\n\r\nSBF will reject any request without `X-Broker-API-Version` header. Both Cloud Foundry and SAP HANA XSA runtime send this header, so this should not require any changes in service brokers in productive environment. Still you may need to adapt your tests.\r\n\r\n### Restricted user required for SBSS on Postgres\r\n\r\nThe SBF requires an additional user-provided service with a restricted Postgres user. If not provided, the SBF will fail to start.\r\nFor more information see [README.md](README.md#sbss-on-postgresql)\r\n\r\n### Change format of parameters for instance creation\r\n\r\n**This is applicable only for XSUAA**\r\n\r\nThe old format where `xsappname` and the other security properties appear on root level is removed.\r\n\r\nIf in the previous version a parameters.json was structured as:\r\n\r\n*parameters.json*:\r\n```\r\n{\r\n  ...\r\n  \"xsappname\": \"my-app\",\r\n  ...\r\n}\r\n```\r\n\r\nNow it should be:\r\n```\r\n{\r\n  ...\r\n  \"xs-security\": {\r\n    \"xsappname\": \"my-app\",\r\n    ...\r\n  }\r\n  /* other custom parameters */\r\n  ...\r\n}\r\n```\r\n\r\nCustom parameters can be specified on top-level, without setting `xs-security` property. In this case the SBF will use service instance id for `xsappname`.\r\n\r\n*parameters.json*:\r\n```\r\n{\r\n  ...\r\n  \"custom-property\": \"value\"\r\n  ...\r\n}\r\n```\r\n\r\n\r\n### Enforced secure outgoing connections\r\n\r\nBy default SBF will fail to start if XSUAA connection is not encrypted. This can be disabled via environment variable `SBF_SECURE_OUTGOING_CONNECTIONS` or via `secureOutgoingConnections` option.\r\n\r\n```js\r\n  ...\r\n  let broker = new ServiceBroker({\r\n    secureOutgoingConnections: false\r\n  });\r\n  ...\r\n  let server = broker.start();\r\n```\r\n\r\nBy default XSUAA service provides an HTTPS url, so this should not require any changes in service brokers.\r\n**Note:** due to platform limitations, PostgreSQL service provides only unencrypted connections.\r\n"},{"name":"README.md","content":"# @sap/sbf\r\nA Node.js framework to create a service broker in SAP Business Technology Platform (SAP BTP)\r\n\r\nThe Service Broker Framework (SBF) implements the [Open Service Broker API](https://www.openservicebrokerapi.org/).\r\nIt can be used in the Cloud Foundry environment of SAP Cloud Platform or on-premise in SAP HANA XS advanced model.\r\n\r\n**Note**: SBF rejects requests for which the `X-Broker-API-Version` header is not set or its value is outside the supported interval [2.4, 3).\r\n\r\nSBF can generate service credentials for the following authentication mechanisms:\r\n* Basic authentication for technical users (via SBSS)\r\n* OAuth2 authentication with JSON Web Tokens (JWT) (via XSUAA _broker_ plan)\r\n  * Named user via *user_token* flow\r\n  * Technical user via *client_credentials* flow\r\n\r\nAfter adding the necessary configuration, the SBF can be started directly as a service broker.\r\nIf necessary, it can be extended with custom JavaScript code.\r\n\r\nAll the information here is valid also for XS advanced, unless explicitly stated otherwise.\r\nIn the shell commands below replace `cf` with `xs` when working on XS advanced.\r\n\r\n**Table of contents**\r\n\r\n<!-- toc -->\r\n\r\n- [Usage](#usage)\r\n  * [Create a simple service broker](#create-a-simple-service-broker)\r\n    + [Prerequisites](#prerequisites)\r\n    + [Create a Node.js application](#create-a-nodejs-application)\r\n    + [Add the Service Broker Framework](#add-the-service-broker-framework)\r\n    + [Add the start command](#add-the-start-command)\r\n    + [Create the service catalog](#create-the-service-catalog)\r\n    + [Create XSUAA service instance](#create-xsuaa-service-instance)\r\n    + [Create an instance of the Audit Log service](#create-an-instance-of-the-audit-log-service)\r\n    + [Generate a secure broker password](#generate-a-secure-broker-password)\r\n    + [Create an application manifest](#create-an-application-manifest)\r\n    + [Push the broker application](#push-the-broker-application)\r\n    + [Register the service broker](#register-the-service-broker)\r\n    + [Use the service broker](#use-the-service-broker)\r\n  * [Extend the service broker](#extend-the-service-broker)\r\n  * [Asynchronous broker operations](#asynchronous-broker-operations)\r\n  * [Service broker as middleware](#service-broker-as-middleware)\r\n  * [Health HTTP endpoint](#health-http-endpoint)\r\n  * [Custom parameters](#custom-parameters)\r\n    + [Create service with custom parameters](#create-service-with-custom-parameters)\r\n    + [Update service with custom parameters](#update-service-with-custom-parameters)\r\n    + [Bind service with custom parameters](#bind-service-with-custom-parameters)\r\n  * [Credentials providers](#credentials-providers)\r\n    + [SBSS](#sbss)\r\n      - [SBSS on SAP HANA](#sbss-on-sap-hana)\r\n      - [SBSS on PostgreSQL](#sbss-on-postgresql)\r\n    + [XSUAA](#xsuaa)\r\n      - [Creating reuse service instances](#creating-reuse-service-instances)\r\n      - [Updating reuse service instances](#updating-reuse-service-instances)\r\n      - [Authentication with X.509 client certificates](#authentication-with-x509-client-certificates)\r\n        * [XSUAA managed certificates](#xsuaa-managed-certificates)\r\n        * [Externally managed certificates](#externally-managed-certificates)\r\n            * [XSUAA broker instance](#1-xsuaa-broker-instance)\r\n            * [Reuse service instance](#2-reuse-service-instance)\r\n    + [IAS](#ias)\r\n      - [Prerequisites](#prerequisites-1)\r\n      - [Creating an IAS instance](#creating-an-ias-instance)\r\n      - [Binding an IAS instance to the broker application](#binding-an-IAS-instance-to-the-broker-application)\r\n      - [Unsupported Features](#unsupported-features)\r\n  * [Unique service broker](#unique-service-broker)\r\n  * [Secure outgoing connections](#secure-outgoing-connections)\r\n  * [Stateless](#stateless)\r\n  * [Memory usage](#memory-usage)\r\n  * [User Interface](#user-interface)\r\n  * [Security](#security)\r\n    + [HTTPS](#https)\r\n    + [Authentication](#authentication)\r\n    \t- [Basic Authentication](#basic-authentication)\r\n    \t\t* [Service Broker Plain-Text Credentials](#service-broker-credentials)\r\n    \t\t* [Service Broker Hashed Credentials](#service-broker-hashed-credentials)\r\n    \t- [mTLS Authentication](#mtls-authentication)\r\n    \t\t* [Out-of-the-Box mTLS](#out-of-the-box-mtls)\r\n    \t\t* [Customized mTLS](#customized-mtls)\r\n    + [Password rotation](#password-rotation)\r\n  * [Audit logging](#audit-logging)\r\n    + [Auditlog Viewer](#auditlog-viewer)\r\n      - [Running on XSA](#running-on-xsa)\r\n      - [Providing the tenant ID](#providing-the-tenant-id)\r\n- [Reference](#reference)\r\n  * [Class: ServiceBroker](#class-servicebroker)\r\n    + [new ServiceBroker([options])](#new-servicebrokeroptions)\r\n    + [ServiceBroker.start()](#servicebrokerstart)\r\n    + [ServiceBroker.app](#servicebrokerapp)\r\n    + [ServiceBroker.callXsuaa(req, options, callback)](#servicebrokercallxsuaareq-options-callback)\r\n    + [(static) ServiceBroker.createCredentialsProvider(credentials)](#static-servicebrokercreatecredentialsprovidercredentials)\r\n  * [Service Catalog](#service-catalog)\r\n  * [Additional Service Configuration](#additional-service-configuration)\r\n  * [Automatic Credentials Generation](#automatic-credentials-generation)\r\n  * [Credentials Provider Service](#credentials-provider-service)\r\n  * [Business Service Support](#business-service-support)\r\n  * [Hooks](#hooks)\r\n    + [`verifyClientCertificate(params, callback)`](#verifyclientcertificateparams-callback)\r\n    + [`onProvision(params, callback)`](#onprovisionparams-callback)\r\n    + [`onUpdate(params, callback)`](#onupdateparams-callback)\r\n    + [`onDeprovision(params, callback)`](#ondeprovisionparams-callback)\r\n    + [`onLastOperation(params, callback)`](#onlastoperationparams-callback)\r\n    + [`onBindLastOperation(params, callback)`](#onbindlastoperationparams-callback)\r\n    + [`onFetchInstanceParams(params, callback)`](#onfetchinstanceparamsparams-callback)\r\n    + [`onBind(params, callback)`](#onbindparams-callback)\r\n    + [`onUnbind(params, callback)`](#onunbindparams-callback)\r\n    + [`params` details](#params-details)\r\n      - [`req`](#req)\r\n      - [`XSUAA clone info`](#xsuaa-clone-info)\r\n    + [Error handling](#error-handling)\r\n  * [Environment variables](#environment-variables)\r\n  * [`gen-catalog-ids`](#gen-catalog-ids)\r\n  * [`hash-broker-password`](#hash-broker-password)\r\n- [Troubleshooting](#troubleshooting)\r\n  * [Increase the log level](#increase-the-log-level)\r\n  * [@sap/sbf not found](#sapsbf-not-found)\r\n  * [Cannot execute start-broker script](#cannot-execute-start-broker-script)\r\n  * [Create service fails with \"Client already exists\"](#create-service-fails-with-client-already-exists)\r\n\r\n<!-- tocstop -->\r\n\r\n## Usage\r\n\r\nYou can find the examples that demonstrate the usage and consumption of the service broker framework in the [examples](https://github.wdf.sap.corp/xs2/node-sbf-examples) directory.\r\n\r\n### Create a simple service broker\r\nFor simple use cases, you don't need to write any JavaScript code. You can start this package directly by providing it with the necessary configuration.\r\n\r\nThe following sections describe the steps to create a simple service broker application by using this framework.\r\n\r\n#### Prerequisites\r\nYou need the following:\r\n- [Node.js](https://nodejs.org) v10 or later\r\n- Cloud Foundry [CLI](https://github.com/cloudfoundry/cli#downloads)\r\n- Access to a Cloud Foundry installation where you can log in via CLI and push applications\r\n\r\n#### Create a Node.js application\r\nCreate a new directory and run the following command in it:\r\n```sh\r\nnpm init\r\n```\r\nYou are prompted to answer several questions. Upon completion, this command creates a _package.json_ file in the current directory. The presence of this file, tells Cloud Foundry that this is a Node.js application.\r\n\r\n#### Add the Service Broker Framework\r\nDownload the _@sap/sbf_ package and add it to your service broker by executing the following command:\r\n```sh\r\nnpm install @sap/sbf\r\n```\r\n\r\n#### Add the start command\r\nEdit the _package.json_ file and add the `start` command in section `scripts`:\r\n```json\r\n{\r\n  \"scripts\": {\r\n    \"start\": \"start-broker\"\r\n  }\r\n}\r\n```\r\n\r\n#### Specify a required Node.js version\r\nAdd the following property in the _package.json_ file to inform Cloud Foundry that the service broker requires Node.js v10:\r\n```json\r\n  \"engines\": {\r\n    \"node\": \"^10\"\r\n  }\r\n```\r\n\r\n#### Create the service catalog\r\nThe service catalog describes the services offered by this service broker.\r\nIt is defined in a JSON format as described in [Cloud Foundry documentation](https://docs.cloudfoundry.org/services/api.html#catalog-management).\r\n\r\nCreate a file called _catalog.json_ in the current directory and describe in it the service catalog.\r\nFor example:\r\n```json\r\n{\r\n  \"services\": [{\r\n    \"name\": \"my-service\",\r\n    \"description\": \"A simple service\",\r\n    \"bindable\": true,\r\n    \"plans\": [{\r\n      \"name\": \"my-plan\",\r\n      \"description\": \"The only plan\"\r\n    }]\r\n  }]\r\n}\r\n```\r\n\r\nExecute the following command to generate unique IDs for the services and their plans in the _catalog.json_ file:\r\n```sh\r\nnpx gen-catalog-ids\r\n```\r\n\r\n#### Create XSUAA service instance\r\nThe service broker can use different services to generate and store credentials needed later on by applications to access your reusable service. In this example we use the XSUAA service as a credentials provider.\r\n\r\nCreate an XSUAA service instance of plan _broker_:\r\n```sh\r\ncf create-service xsuaa broker xsuaa-broker\r\n```\r\nHere `xsuaa-broker` is the service instance name. You can use an arbitrary name here. Make sure to use the same name in the subsequent commands.\r\n\r\n#### Create an instance of the Audit Log service\r\nThe service broker is configured by default to audit log every operation. It needs information to connect to the Audit log service.\r\n\r\nCreate Audit log service with the following command:\r\n```sh\r\ncf create-service auditlog oauth2 broker-audit\r\n```\r\nYou can also use the standard plan. It was deprecated, however still supported:\r\n```sh\r\ncf create-service auditlog standard broker-audit\r\n```\r\n\r\n#### Generate a secure broker password\r\n```sh\r\nnpx hash-broker-password -b\r\n```\r\nThis command generates a random password and hashes it.\r\n\r\n#### Create an application manifest\r\nYou can deploy the service broker in Cloud Foundry as a regular application.\r\nAn easy way to do that is via an [application manifest](https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html).\r\nCreate a _manifest.yml_ file in the current directory with the following content:\r\n```yaml\r\n---\r\napplications:\r\n  - name: my-broker\r\n    memory: 128M\r\n    services:\r\n      - xsuaa-broker\r\n      - broker-audit\r\n    health-check-type: http\r\n    health-check-http-endpoint: /health\r\n    env:\r\n      SBF_BROKER_CREDENTIALS_HASH: >\r\n        {\r\n          \"broker-user\": \"<broker-password-hash>\"\r\n        }\r\n      SBF_SERVICE_CONFIG: >\r\n        {\r\n          \"my-service\": {\r\n            \"extend_credentials\": {\r\n              \"shared\": {\r\n                \"uri\": \"https://my-service.example.com\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n```\r\n\r\n`my-broker` is the name of the broker application. You can use an arbitrary name.\r\n\r\nSome configurations are not known in advance and they need to be set at the time of deployment via the environment variables.\r\n\r\nOne such configuration is the credentials configuration used to call the service broker.\r\nThis configuration is provided via the environment variable *SBF_BROKER_CREDENTIALS_HASH*.\r\nHere you can use arbitrary credentials.\r\nReplace `<broker-password-hash>` with the hashed credentials from the previous step.\r\nJust make sure to use matching credentials when you register the broker and don't commit these in source control.\r\n\r\nAnother configuration done during the deployment is the service URL. You can provide it via the environment variable *SBF_SERVICE_CONFIG*.<br/> See [Additional Service Configuration](#additional-service-configuration) for details.\r\n\r\n#### Push the broker application\r\nPush the broker application to Cloud Foundry by running the following command:\r\n```sh\r\ncf push\r\n```\r\nBy default, Cloud Foundry uses the name of the application as the host name.<br/> If this name is already taken, you can specify a different host via the `host` property in the manifest. Alternatively you can use a random host with the following command:\r\n```sh\r\ncf push --random-route\r\n```\r\n\r\n#### Register the service broker\r\nFor productive use a service broker is [registered globally](https://docs.cloudfoundry.org/services/managing-service-brokers.html#register-broker) so you can use it throughout Cloud Foundry, but this requires administrative permissions.<br/> During development and testing you can register the service broker only in your space. You do this with the following command:\r\n```sh\r\ncf create-service-broker my-broker-name broker-user <plain-broker-password> <broker-url> --space-scoped\r\n```\r\nReplace here `<plain-broker-password>` with the plaintext password generated by _hash-broker-password_ script.\r\n\r\nYou can get the broker URL via the command `cf apps`.\r\n\r\nHere `my-broker-name` is an arbitrary name used to distinguish this service broker from the rest.\r\nIt is independent from the broker application name.\r\n\r\n#### Use the service broker\r\nNow you can use your service broker within the same space.\r\nFor example, you can now see its services and plans via the `cf marketplace` command.\r\nYou can use the new services as regular [services](https://docs.cloudfoundry.org/devguide/services/) in Cloud Foundry.\r\n\r\nYou can also create a service instance via `cf create-service`.\r\nThen you can bind it to your application via `cf bind-service`.<br/> After that the application gets the URL and the credentials for your service from the environment variable [VCAP_SERVICES](https://docs.cloudfoundry.org/devguide/deploy-apps/environment-variable.html).\r\nYou can see them via the `cf env` command.\r\n\r\nYou can also create a service key (`cf create-service-key`) and print its content (`cf service-key`) to see the credentials to access the service instance.\r\n\r\nYou can also register the service broker in another space and use it there.\r\nTo do that append a unique suffix to the broker URL:\r\n```sh\r\ncf create-service-broker my-broker-name broker-user broker-password <broker-url>/<unique-suffix> --space-scoped\r\n```\r\nUse a different suffix for each broker registration.\r\n\r\n### Extend the service broker\r\n\r\nSome service brokers need to perform custom actions during standard broker operations.\r\nFor example, special actions might be necessary to provision a new service instance.\r\nTo do that, you can create a custom Node.js application for your service broker.\r\nThis application can use the service broker framework as a normal Node.js package.\r\nThen you can register [custom callbacks](#hooks) to be invoked during each broker operation.\r\n\r\nCreate a Node.js application and add a _@sap/sbf_ dependency as described [above](#create-a-nodejs-application). \r\n\r\nCreate the start script of your broker application, e.g. _start.js_:\r\n```js\r\nconst Broker = require('@sap/sbf');\r\n\r\nlet broker = new Broker({\r\n  hooks: {\r\n    onProvision: (params, callback) => {\r\n      console.log('Provision service %s with plan %s', params.service_id, params.plan_id);\r\n      // custom provision actions\r\n      callback();\r\n    },\r\n    onDeprovision: (params, callback) => {\r\n      console.log('Deprovision service instance %s', params.instance_id);\r\n      // custom deprovision actions\r\n      callback();\r\n    }\r\n  }\r\n});\r\nlet server = broker.start();\r\n```\r\n\r\nEdit the _package.json_ file and set the `start` command to execute your start script:\r\n```json\r\n  \"scripts\": {\r\n    \"start\": \"node start.js\"\r\n  }\r\n```\r\n\r\nSee [examples/node.js/custom-hooks](https://github.wdf.sap.corp/xs2/node-sbf-examples/tree/master/node.js/custom-hooks) for a complete example.\r\n\r\n### Asynchronous broker operations\r\n\r\nBy default, service broker operations like provisioning and deprovisioning are synchronous,\r\ni.e. HTTP response is returned when the operation is complete.\r\nSo that long-running operations are also supported, some platforms, like Cloud Foundry, support also asynchronous operations.\r\nSee [Synchronous and Asynchronous Operations](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#synchronous-and-asynchronous-operations)\r\nin the Open Service Broker API specifications.\r\n\r\n**Note:** currently the XS advanced runtime does not support asynchronous operations.\r\n\r\nTo perform an asynchronous operation you implement several [hooks](#hooks).\r\nFirst, check if your platform supports asynchronous operations.\r\nIf it does, start the operation in the background and return `async: true` in the `reply`:\r\n```js\r\nfunction onProvision(params, callback) {\r\n  if (params.accepts_incomplete !== 'true') {\r\n    let error = new Error('Cannot provision service instance synchronously');\r\n    error.statusCode = 422; // Unprocessable Entity\r\n    return callback(error);\r\n  }\r\n  let operationId;\r\n  // start the operation in the background ...\r\n  // and assign operationId ...\r\n  callback(null, {\r\n    async: true, // indicate that operation was started asynchronously\r\n    operation: operationId // later the same operationId will be passed to onLastOperation\r\n  });\r\n}\r\n```\r\nThe same applies also to `onUpdate` and `onDeprovision` hooks.\r\n\r\nNext, the platform polls in regular intervals for the status of the operation.\r\nEach time it sends the same `operation` string to identify the operation.\r\nThis is useful if multiple asynchronous operations are running in parallel, e.g. multiple service instances are created at the same time.\r\nTo provide the current status of the operation, you implement the [`onLastOperation`](#onlastoperationparams-callback) hook:\r\n```js\r\nfunction onLastOperation(params, callback) {\r\n  let operationId = params.operation; // for which operation to return status\r\n  // get operation status ...\r\n  callback(null, {\r\n    state: 'in progress', // or 'succeeded' or 'failed'\r\n    description: 'progress 50%' // Some user-facing message, what is going on\r\n  });\r\n}\r\n```\r\n\r\n**Note:** With [IAS as a credentials provider](#ias) all requests are proxied to the IAS Broker, which manages the statuses of last operations. If you choose to implement a hook, do it with caution because you could override the original status received from the IAS Broker.  \r\n\r\n**Note:** If several instances of the service broker are running, it is very likely that the start of an asynchronous operation and subsequent polling via [onLastOperation](#onlastoperationparams-callback) will be handled by different broker instances.\r\nSo make sure that all broker instances see the same state.\r\n\r\n### Service broker as middleware\r\nYou can create a custom Node.js application and add the service broker as a middleware. The *Broker* class has property `app` which is an express application.\r\nExample:\r\n```javascript\r\nconst express = require('express');\r\nconst Broker = require('@sap/sbf');\r\n\r\nlet app = express();\r\nlet broker = new Broker();\r\n\r\napp.get('/custom-endpoint', (req, res) => {\r\n  res.send('custom-response');\r\n});\r\napp.use('/broker', broker.app);\r\n\r\napp.listen(process.env.PORT);\r\n```\r\n\r\nThen to register the broker use url: `https://<app-url>/broker`.\r\n\r\n### Health HTTP endpoint\r\n\r\nSBF provides an HTTP endpoint (on path `/health`) whose purpose is to serve as a health check endpoint.\r\nIt does not require authentication and can process HTTP GET requests only.\r\nCurrently, it returns a static response with the status `200` and body `OK`.\r\n\r\nBy default, Cloud Foundry uses `port` as a health check type ([documentation for health check types](https://docs.cloudfoundry.org/devguide/deploy-apps/healthchecks.html#types)). To use the health endpoint provided by SBF:\r\n- Configure the health check type to `http`. In `manifest.yml`, you do this via the property `health-check-type`.\r\n- Configure the path of the health endpoint, by default it's `/`. In `manifest.yml`, you do this via the property `health-check-http-endpoint`.\r\n\r\nSee an example [here](#create-application-manifest).\r\n\r\n### Custom parameters\r\n\r\nCustom parameters can be passed to the service broker in several locations.\r\nThe parameters are passed as a JSON object. It can have arbitrary content and is not interpreted by Cloud Foundry.\r\n\r\n#### Create service with custom parameters\r\n\r\n```sh\r\ncf create-service <service> <plan> <service-instance> -c parameters.json\r\n```\r\nThe content of _parameters.json_ is passed to the service broker and can be accessed in the [`onProvision`](#onprovisionparams-callback) hook via the `params.parameters` argument.\r\n\r\n**Note**: When using XSUAA for authentication, the parameters JSON should contain `xs-security` property to avoid confusion with custom parameters.\r\nSee [XSUAA](#xsuaa) for details.\r\n\r\n#### Update service with custom parameters\r\n\r\n```sh\r\ncf update-service <service-instance> -c parameters.json\r\n```\r\nThe content of _parameters.json_ is passed to the service broker and can be accessed in [`onUpdate`](#onupdateparams-callback) hook via `params.parameters` argument.\r\n\r\n#### Bind service with custom parameters\r\n\r\n```sh\r\ncf bind-service <application> <service-instance> -c parameters.json\r\n```\r\nThe content of _parameters.json_ is passed to the service broker and can be accessed in [`onBind`](#onbindparams-callback) hook via `params.parameters` argument.\r\n\r\nThe same goes for CF service-keys:\r\n```sh\r\ncf create-service-key <service-instance> <key-name> -c parameters.json\r\n```\r\n\r\n**Note**: Binding for reuse service instace when XSUAA is the credentials' provider, allows for specific configuration in order to support certificate credentials, as specified here: [Authentication with X.509 client certificates](#authentication-with-x509-client-certificates)\r\n\r\n### Credentials providers\r\n\r\nBy default, this modul searches for a bound service instance which is responsible for generating credentials for the services offered by a service broker. The framework attempts to find a suitable service with the following properties in the following order:\r\n1. SAP HANA Service Instance (A service with label `hana` and plan `sbss`)\r\n2. PostgreSQL Service Instance (A service with label `postgresql` and tag `sbss`)\r\n3. XSUAA Service Instance (A service with label `xsuaa` and plan `broker`)\r\n4. IAS Service Instance (A service with the label `identity` and plan `application`)\r\n\r\nIf no such service is found in the environment of the broker, an error is returned.\r\n\r\nYou can disable this behavior by [setting the credentials provider service explicitly](#credentials-provider-service). When running on K8S you must always set the credentials provider service explicitly.\r\n\r\n\r\nDepending on the type of the service that provides credentials: SBSS (for SAP HANA and PostgreSQL), XSUAA, or IAS, this module generates credentials and merges them to the `credentials` object received in the response to *bind* operation.\r\nThe same object will appear also in the `credentials` section for the respective service in the `VCAP_SERVICES` environment variable in bound applications. You can find some examples below.\r\n\r\n#### SBSS\r\n\r\nSBSS (Service Broker Security Support) can generate, store, and verify usernames and passwords in a secure way. It is accessed via the SQL API.\r\n\r\n##### SBSS on SAP HANA\r\n\r\nCreate SBSS service instance (example):\r\n```sh\r\ncf create-service hana sbss hana-sbss\r\n```\r\nHere `hana-sbss` is an arbitrary service instance name.\r\n\r\nGenerated credentials example:\r\n```json\r\n{\r\n  \"username\": \"SBSS_00536748842276225491856140796794258250872406624126918117591330539\",\r\n  \"password\": \"Aa_12905484905134285946159829260519429913717511989397057274381675342\",\r\n}\r\n```\r\n\r\n**Note**: Since version 4 of _@sap/sbf_, broker applications that use SBSS on HANA need to explicitly specify\r\na dependency to the _@sap/hdbext_ package.\r\n\r\n##### SBSS on PostgreSQL\r\n\r\nSBSS on PostgreSQL credentials provider requires 2 services to be bound to the service broker application. One is the actual PostrgeSQL service instance and additional user-provided service containing restricted DB user to be used for credentials generation.\r\n\r\nCreate SBSS service instance (example):\r\n```sh\r\ncf create-service postgresql v9.4-dev pg-sbss -t sbss\r\n```\r\nHere `pg-sbss` is an arbitrary service instance name. Notice that the command attaches the tag `sbss` to the service instance. **This tag is mandatory.** It can also be set after the service instance has been created like this:\r\n```sh\r\ncf update-service pg-sbss -t sbss\r\n```\r\n\r\nCreate restricted DB user service (example):\r\n```sh\r\ncf create-user-provided-service sbss-configuration -p \"{\\\"tag\\\":\\\"sbss-config\\\",\\\"restricted-dbuser-name\\\":\\\"<dbuser>\\\",\\\"restricted-dbuser-password\\\":\\\"<dbpassword>\\\"}\"\r\n```\r\nHere you can use arbitrary values for `restricted-dbuser-name` and `restricted-dbuser-password`.\r\nYou should bind the same service instance to SBSS installer application when deploying SBSS on Postgres.\r\nFor details see the SBSS documentation.\r\n\r\n**Note:** You should bind _both_ service instances to the service broker application.\r\n\r\n#### XSUAA\r\n\r\nCreate XSUAA instance of plan _broker_ (example):\r\n```sh\r\ncf create-service xsuaa broker <service-instance> -c xs-security.json\r\n```\r\n\r\n##### Creating reuse service instances\r\n\r\nLater on, you can create instances of the reuse service:\r\n```sh\r\ncf create-service my-service my-plan <service-instance> -c parameters.json\r\n```\r\nHere we assume that service `my-service` with plan `my-plan` is defined in the service catalog of the broker.\r\n\r\n*parameters.json*:\r\n```\r\n{\r\n  \"xs-security\": {\r\n    \"xsappname\": \"my-app\",\r\n    ...\r\n  },\r\n  \"customProperty1\": 1,\r\n  \"customProperty2\": \"2\",\r\n  ...\r\n}\r\n```\r\n\r\n`xs-security` object in *parameters.json* has the same structure as [xs-security.json] file.\r\nIt is sent to XSUAA to create an OAuth client for each instance of the reuse service.\r\n\r\n`xs-security` properties will be overwritten by any additional service configuration defined in the environment variable `SBF_SERVICE_CONFIG`.\r\nSee [Additional Service Configuration](#additional-service-configuration).\r\n\r\nOther top level properties are optional (e.g. `customProperty1` and `customProperty2`) and can be used to pass arbitrary parameters.\r\nThe whole *parameters.json* file is accessible via `params.parameters` in [`onProvision(params, callback)`](#onprovisionparams-callback) hook.\r\n\r\n**Note**: Custom parameters can be defined as root-level properties. If `xs-security` is not defined, the SBF generates a default value, where `xsappname` is set to the service instance id.\r\n\r\n**Note**: During reuse instance create/update, an `authorities` array can be passed to XSUAA. It is recommended to provide `extend_xssecurity` from the [Additional Service Configuration](#additional-service-configuration) and set `authorities` explicitly, to control the scopes exposed for the reuse instance. If no `authorities` section was provided in [Additional service configuration](#additional-service-configuration) (`extend_xssecurity`), by default SBF will pass an empty `authorities` array in create/update requests to XSUAA, and`authorities` provided by consumers are ignored. <br/>\r\nSet the secureUAAScopes option (or environment variable `SBF_SECURE_UAA_SCOPES`) **explicitly** to `false`, in order to pass the authorities array provided by the consumer as is.<br/>\r\n**This behavior and environment variable form an incompatible change from release v6.4.9**.\r\n\r\nGenerated credentials example:\r\n```json\r\n{\r\n  \"uaa\": {\r\n    \"clientid\": \"sb-my-app!b27|reuse-service!b27\",\r\n    \"clientsecret\": \"o7M5UE0S+Q498j9zNmAlAKdYrSo=\",\r\n    \"identityzone\": \"cc-sap\",\r\n    \"tenantid\": \"cc-sap\",\r\n    \"tenantmode\": \"dedicated\",\r\n    \"uaadomain\": \"authentication.sap.hana.ondemand.com\",\r\n    \"url\": \"https://cc-sap.authentication.sap.hana.ondemand.com\",\r\n    \"verificationkey\": \"-----BEGIN PUBLIC KEY----- ... -----END PUBLIC KEY-----\",\r\n    \"xsappname\": \"my-app!b27|reuse-service!b27\"\r\n  }\r\n}\r\n```\r\nAn application can use these credentials to call the UAA to fetch a proper JWT token. Then the application can call the reuse service using this token as authentication.\r\n\r\nAs it's seen the `clientid` and the `xsappname` properties hold some specific information. Here the string \"my-app\" corresponds to the _xsappname_ from the _security.json_ which was provided when creating the service instance which the service broker offers. The string \"reuse-service\" corresponds to the _xsappname_ in the _security.json_ which was used to create the XSUAA service instance with plan broker. More information can be found in the examples.\r\n\r\n##### Updating reuse service instances\r\n\r\nThe instance of the reuse service can be updated as follows:\r\n\r\n```\r\ncf update-service <service-instance> -p <new-plan> -c parameters.json\r\n```\r\n\r\nThe plan of the service instance can be optionally changed with the `-p` option.\r\nUpdating the plan of an instance to a different one from the catalog is possible only if the service is configured with `plan_updateable`.\r\nRefer to [the description of services](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#service-objects) in the catalog in the OSB specification.\r\n\r\nParameters are provided in the same manner as they are during service instance creation -\r\nXSUAA parameters are passed in the `xs-security` property.\r\nService specific parameters are provided on root level.\r\n`xs-security` properties will be overwritten by any additional service configuration defined in `extend_xssecurity` from the [Additional Service Configuration](#additional-service-configuration).\r\nThe whole *parameters.json* file is accessible via `params.parameters` in [`onUpdate(params, callback)`](#onupdateparams-callback) hook.\r\n\r\n**Note**: It is recommended to provide explicitly `xsappname` in `xs-security` when creating a service instance\r\ninstead of letting SBF set it automatically to the service instance id,\r\nbecause `xsappname` needs to be provided in every update operation on XSUAA clones.\r\nIn case the service instance id should be provided in the update operation,\r\nit can be retrieved for an instance with the following command: `cf service <name> --guid`.\r\n\r\n**Note**: If `xsappname` is provided in `xs-security` when creating a service instance,\r\nthe same `xsappname` should be provided in `xs-security` when updating a service instance.\r\nIf `xsappname` is not provided on provision, SBF by default will use the service instance id.\r\nThe same service instance id will also be used during instance update as value for `xsappname`.\r\n\r\n**Note**: If `xs-security` is not provided in *parameters.json* then no update of the XSUAA options will take place. If only `extend_xssecurity` from the [Additional Service Configuration](#additional-service-configuration) needs to be taken into account, `xs-security` can be provided as an empty object.\r\n\r\n**Note**: To enable SBF to use per plan `extend_xssecurity` from the [Additional Service Configuration](#additional-service-configuration),\r\nthe platform requesting the broker should provide a plan id.\r\nThe [OSB specification](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#body-4) does not mark any `plan_id` field as mandatory\r\n(neither on root level, nor in `previous_values`).\r\nSBF first checks the `plan_id` property on root level and if it is not available fallbacks to `previous_values.plan_id`.\r\nIf no plan id information is provided, and there is a `per_plan` configuration in `extend_xssecurity` from the [Additional Service Configuration](#additional-service-configuration), SBF will return an error.\r\nCloud Foundry provides both `plan_id` and `previous_values.plan_id`.\r\nAt the moment Service Catalog on Kubernetes does not support service instance update. Refer to the [CLI documentation](https://github.com/kubernetes-sigs/service-catalog/blob/master/docs/cli.md) for changes.\r\n\r\n##### Authentication with X.509 client certificates\r\n\r\nAuthentication with X.509 client certificates can be enabled with the following configuration provided in the _xs-security_ options:\r\n\r\n```json\r\n{ \r\n  \"xsappname\": \"...\", \r\n  \"oauth2-configuration\": {\r\n    \"credential-types\": [\"x509\"]\r\n  } \r\n}\r\n```\r\n\r\n`credential-types` is an array of allowed credential types, where allowed values are `instance-secret`, `binding-secret`, `x509`. <br><br>\r\nIf `x509` is not the only type in the array AND not the first item (e.g `\"credential-types\": [\"binding-secret\", x509\"]`), in order to enable X.509 authentication, you MUST specify it explicitly during bind (see below). \r\n\r\n**Note**: the old json format is deprecated, but still accepted by XSUAA:\r\n```json\r\n{\r\n  \"xsappname\": \"...\",\r\n  \"oauth2-configuration\": { \"grant-types\": [\"client_x509\"] }\r\n}\r\n```\r\n<br>\r\n\r\nX.509 client certificate authentication can be separately configured on **3 levels**:\r\n\r\n1. XSUAA instance of plan _broker_. This enables X.509 authentication between the **SBF based broker application** and XSUAA. <br>\r\n   * If `x509` is not the default `credential-type` that was configured during the XSUAA instance creation, it must be explicitly requested during bind: <br>\r\n    ```sh\r\n        cf bind-service <broker-application> <xsuaa-instance> -c parameters.json\r\n    ```\r\n    Where the relevant parameters.json format is:\r\n     ```json\r\n        {\r\n           \"credential-type\": \"x509\", \r\n           \"x509\": { \r\n               ...\r\n           } \r\n       }\r\n    ```\r\n   \r\n   * If you have created the instance using the **old json format**, there are no special bind instructions.\r\n\r\n2. Reuse service instance. The required configuration can be provided either via SBF's [additional service configuration](#additional-service-configuration) (property `extend_xssecurity`) or via the parameters during reuse service instance creation (_[parameters.json](#create-service-with-custom-parameters)_, property `xs-security`).\r\n\r\n3. Reuse service instance binding. The required configuration should be provided via the parameters during reuse service instance binding creation:\r\n   * If `x509` is not the default `credential-type` that was configured during the reuse instance creation, it must be explicitly requested during bind: <br> \r\n   ```sh\r\n    cf bind-service <application> <service-instance> -c parameters.json\r\n    ```\r\n   Where the relevant configuration must be wrapped with `xsuaa`. The exact format in which the configuration should be provided is:\r\n    ```json\r\n    {\r\n      \"xsuaa\": { \r\n           \"credential-type\": \"x509\", \r\n           \"x509\": { \r\n               ...\r\n           } \r\n       }\r\n   }\r\n   ```\r\n   The same goes for CF service-keys:\r\n   ```sh\r\n   cf create-service-key <service-instance> <key-name> -c parameters.json\r\n   ```\r\n   **Note**: currently only `credential-type` and `x509` (and `X.509` for [Externally managed certificates](#externally-managed-certificates)) fields are supported under `xsuaa`.\r\n    \r\n   * If you have created the instance using the **old json format**, there are no special bind instructions. <br>\r\n\r\n##### Certificate types:\r\nThe certificate-key pairs that will be used can either be automatically generated by XSUAA (_XSUAA managed certificates_) or\r\nexplicitly provided custom ones (_externally managed certificates_).\r\n\r\n##### XSUAA managed certificates\r\n\r\nThe configuration above is sufficient to use XSUAA managed certificates.\r\nThe credentials of the XSUAA _broker_ instance or/and the credentials of the reuse service instance will contain `certificate` and `key` properties that can be used for X.509 client certificate authentication.\r\n\r\n##### Externally managed certificates\r\n\r\nIn this case, the certificate should be provided in the parameters **during bind** of the XSUAA instnace.\r\n \r\n###### 1. XSUAA broker instance\r\nThe format in which the certificate should be provided is:\r\n\r\n```json\r\n{\r\n  \"credential-type\": \"x509\",\r\n  \"x509\": {\r\n    \"certificate\": \"-----BEGIN CERTIFICATE-----...-----END CERTIFICATE-----\",\r\n    \"ensure-uniqueness\": false,\r\n    \"certificate-pinning\": true\r\n  }\r\n}\r\n```\r\n\r\nIf you have created the instance using the old json format:\r\n```json\r\n{\r\n  \"xsappname\": \"...\",\r\n  \"oauth2-configuration\": { \"grant-types\": [\"client_x509\"] }\r\n}\r\n```\r\nThen pass the following bind parameters:\r\n```json\r\n{\r\n   \"X.509\": \"-----BEGIN CERTIFICATE-----\\nMIID1j ...\"\r\n}\r\n```\r\n\r\nThe resulting credentials will contain a `certificate` property.\r\nThe key should be provided to the broker application, so that it can be used in combination with the `certificate` from the binding. This is done through the `SBF_CLIENT_CERTIFICATE_KEY` environment variable or through the `clientCertificateKey` option. Format should be:\r\n\r\n```\r\nSBF_CLIENT_CERTIFICATE_KEY: -----BEGIN RSA PRIVATE KEY-----\r\nMIIEpA ...\r\n```\r\n\r\nIn order to set SBF_CLIENT_CERTIFICATE_KEY properly, linebreaks needs to be preserved as `\\n`. <br>\r\nThe following 2 options demonstrates how to configure this key in the **broker's `manifest.yaml`**:\r\n\r\n* Use the `pipe` charachter (`|`):\r\n```yaml\r\nSBF_CLIENT_CERTIFICATE_KEY: |\r\n        -----BEGIN RSA PRIVATE KEY-----\r\n        MIIEpAIBAAKCABCD+59YBTqEOvQaYWvc/hg+ixznh59qVBXxJKLH0jw85RSlGp\r\n        ...\r\n        asBsdfNfWvdf1FPf6QV+VWaRdQ6zneimsbkxjIg/cdfpW2HmVyTSnqw==\r\n        -----END RSA PRIVATE KEY-----\r\n```\r\n\r\n* Keep the `\\n` and wrap with quotation marks (\"...\"):\r\n```yaml\r\nSBF_CLIENT_CERTIFICATE_KEY: \"-----BEGIN RSA PRIVATE KEY-----\\nMIIEpAIBA ... VyTSnqw==\\n-----END RSA PRIVATE KEY-----\\n\"\r\n```\r\n\r\nWhen enabled, SBF uses X.509 certificates authentication with precedence over `clientid` and `clientsecret`.\r\n\r\n###### 2. Reuse service instance\r\nThe relevant configuration must be wrapped with `xsuaa`, that is:\r\n```json\r\n{\r\n  \"xsuaa\": {\r\n      \"credential-type\": \"x509\",\r\n      \"x509\": {\r\n        \"certificate\": \"-----BEGIN CERTIFICATE-----...-----END CERTIFICATE-----\",\r\n        \"ensure-uniqueness\": false,\r\n        \"certificate-pinning\": true\r\n      }\r\n  }\r\n}\r\n```\r\n\r\nIf you have created the instance using the old json format:\r\n```json\r\n{\r\n  \"xsuaa\" : {\r\n    \"X.509\": \"-----BEGIN CERTIFICATE-----\\nMIID1j ...\"\r\n  }\r\n}\r\n```\r\n**Note**: currently only `credential-type`, `x509` and `X.509` fields are supported under `xsuaa`.\r\n\r\nThe key should be provided (in the environment, for example) to the consumer application so that it can be used in combination with the `certificate` from the binding.\r\n\r\n#### IAS\r\n\r\nIAS (Identity and Authentication Service) is enabling service owners to maintain a service broker within IAS. \r\nTherefore, SBF with IAS as credentials provider acts as a proxy to the IAS Broker, while still allowing you to extend functionalities by using custom hooks (an ability IAS Broker doesn't support).\r\n\r\n##### Prerequisites\r\n\r\nYou can find the complete IAS Broker documentation [here](https://github.wdf.sap.corp/CPSecurity/Knowledge-Base/tree/master/08_Tutorials/iasbroker), along with prerequisites and procedures. \r\n\r\n##### Creating an IAS instance\r\nCreate an IAS instance of the plan _application_ (example):\r\n```sh\r\ncf create-service identity application <service-instance> -c catalog.json\r\n```\r\nHere, the catalog.json is passed to the IAS instance, as this instance represents a IAS Broker. Therefore, a file that contains the catalog should not be provided to the application (see [Service Catalog](#service-catalog)). \r\n\r\n##### Binding an IAS instance to the broker application\r\nBind an IAS instance (example):\r\n```sh\r\ncf bind-service <broker-app> <service-instance> -c '{\"credential-type\": \"X509_GENERATED\"}'\r\n```\r\nHere we use the IAS ability to generate X.509 client certificates for us. Refer to the [documentation](https://github.wdf.sap.corp/CPSecurity/Knowledge-Base/tree/master/08_Tutorials/iasbroker#service-binding-creation) for alternatives. \r\n\r\n**Note:** communication between the SBF-based broker application and the IAS broker is based on TLS authentication (X.509 client certificates). Make sure you create the binding properly by passing the parameters correctly. \r\nIn addition, arbitrary parameters are not supported in app manifests in cf CLI v6.x (see [here](https://docs.cloudfoundry.org/devguide/services/application-binding.html#bind-with-manifest)), therefore the binding cannot be declared in the manifest.yml file.\r\n\r\n#### Unsupported Features\r\nThe following [Additional Service Configuration](#additional-service-configuration) are not yet supported with IAS as credentials provider:\r\n1.  `extend_credentials`\r\n2. The following properties from the [Business Service Support](#business-service-support) section:\r\n    * `sap.cloud.service`\r\n    * `sap.cloud.service.alias`\r\n    * `saasregistryenabled`\r\n    \r\nYou can still choose to extend the response with these parameters within the [onBind hook](#onbindparams-callback).\r\n\r\n### Unique service broker\r\n\r\nSometimes for testing it is useful to register the same broker multiple times as if it were multiple different brokers.\r\n\r\nThe service broker framework can append a suffix to each service name, ID and plan ID to make them unique.\r\nThere are 3 options to provide this suffix (taken in the following order):\r\n1. append the suffix in the broker URL\r\n```sh\r\ncf create-service-broker broker-name user password https://broker.domain/suffix --space-scoped\r\n```\r\n2. broker's constructor option `catalogSuffix` (requires separate broker deployment)\r\n3. environment variable `SBF_CATALOG_SUFFIX` (requires separate broker deployment)\r\n\r\nIf this suffix is specified, it is used only in the communication with service broker clients like Cloud Controller.\r\nInternally this suffix is removed, so all hook functions will get IDs without the suffix, just like in the service catalog.\r\nStill in the marketplace the services will be visible with the suffix. So you will have to use the suffix in commands like `cf create-service`.\r\n\r\nThe URL suffix should not contain URL special characters (`/`, `?`, etc.).\r\n\r\nAssume you have pushed a service broker application and its URL is https://my-broker.domain.com/.\r\nThen you can register this broker using suffix `abc` in the URL:\r\n```sh\r\ncf create-service-broker my-broker-abc user password https://my-broker.domain.com/abc --space-scoped\r\n```\r\nThis will append the suffix \"abc\" to each service name, ID and plan ID in the catalog in this space.\r\n\r\nYou can also register the same broker with another suffix:\r\n```sh\r\ncf create-service-broker my-broker-xyz user password https://my-broker.domain.com/xyz --space-scoped\r\n```\r\nThis will append the suffix \"xyz\" to each service name, ID and plan ID in the catalog in that space.\r\n\r\n\r\n### Secure outgoing connections\r\n\r\nBy default all outgoing connections from the service broker must be encrypted or the broker will fail to start (this is not the case with SBSS connections).\r\nThis behavior can be changed using the `secureOutgoingConnections` option or the environment variable `SBF_SECURE_OUTGOING_CONNECTIONS`.\r\nIf one of them is set to *false*, unencrypted connections will be allowed.\r\n\r\n**Note:** This option does not apply for connections made by custom code (for example: [`hooks`](#hooks)).\r\n\r\n### Stateless\r\n\r\nA service broker can and should be scaled to run with several instances to achieve high availability and if necessary handle more load.\r\nFor this reason the service broker framework is designed to be stateless.\r\nSo it maintains no state between broker requests and provides no communication among broker instances.\r\nIf custom hooks introduce some state, they should take care to synchronize it across multiple broker instances.\r\n\r\nSpecial care should be taken for asynchronous operations which have inherent state.\r\nIt is very likely that the start of an asynchronous operation and subsequent polling via [onLastOperation](#onlastoperationparams-callback) will be handled by different broker instances.\r\n\r\n### Memory usage\r\n\r\nA non customized SBF application (without custom code) consumes around 52MB of memory in idle state.\r\nDuring light load (less then 10 concurrent requests) the memory consumption is around 110MB (depending on the requests type).\r\nDuring heavy load (100+ concurrent requests) the memory could reach 160MB.\r\nRecommendations:\r\n * For light load scenarios, deploy with memory limit at least 128MB.\r\n * For heavy load scenarios, deploy with memory limit at least 256MB.\r\n\r\nAlso, consider scaling out the broker application with multiple instances.\r\nThis will increase both the throughput and the fault tolerance (against app crashes).\r\n\r\nIf custom code is used (e.g. hooks or middleware), its memory usage should be taken into account when calculating the overall memory consumption.\r\n\r\nIn addition you should limit the Node.js heap size accordingly.\r\nThe general recommendation is to set it to 75% of the application memory limit.\r\nFor example (in manifest.yml):\r\n```\r\n  memory: 128M\r\n  env:\r\n    NODE_OPTIONS: --max-old-space-size=96\r\n```\r\n\r\n### User Interface\r\n\r\nThe service broker framework provides no user interface.\r\nIt implements only the standard [Service Broker API](https://docs.cloudfoundry.org/services/api.html).\r\n\r\nStill if your services provide a web-based management user interface, you can expose it via the `reply.dashboard_url` property in [`onProvision`](#onprovisionparams-callback) hook.\r\n\r\n### Security\r\nTo ensure ISO/SOC compliance, certain security requirements should be fulfilled:\r\n* Minimum password length of 15 characters (fulfilled by passwords generated by SBSS, XSUAA and deploy service)\r\n* Regular password rotation\r\n\r\n#### Password rotation\r\nYou can use this procedure to update the broker password without downtime.\r\n1. Deploy the broker with the new password as a new application\r\n2. Update the broker registration with the new password and URL\r\n```sh\r\ncf update-service-broker <broker-name> <broker-username> <broker-password> <broker-url>\r\n```\r\n3. Delete the old broker application\r\n\r\n#### HTTPS\r\nSince different credentials are transferred between the service broker and its client (Cloud Controller),\r\nthe communication should be encrypted. If the broker is deployed as an application in Cloud Foundry,\r\nno special configuration is required as the platform provides HTTPS support.\r\nIf the broker is deployed outside the platform then HTTPS should be enabled.\r\nThis section describes how to do that.\r\n\r\nCreate a custom start script, for example _broker.js_:\r\n```javascript\r\nconst https = require('https');\r\nconst fs = require('fs');\r\nconst Broker = require('@sap/sbf');\r\n\r\nconst broker = new Broker();\r\n\r\n// this is an example, you should provide your own key and certificate\r\nconst options = {\r\n  key: fs.readFileSync('server-key.pem'),\r\n  cert: fs.readFileSync('server-cert.pem')\r\n};\r\n\r\nhttps.createServer(options, broker.app).listen(process.env.PORT);\r\n```\r\nFor details how to configure HTTPS see [https.createServer](https://nodejs.org/api/https.html#https_https_createserver_options_requestlistener).\r\n\r\nUse your start script in the `start` command in _package.json_\r\n```json\r\n  \"scripts\": {\r\n    \"start\": \"node broker.js\"\r\n  }\r\n```\r\n\r\n### Authentication\r\nSBF supports Basic and mTLS authentication. Below you can find information about how to configure each type of authentication. \r\n#### Basic Authentication\r\nYou can configure SBF to use basic authentication. You need to configure username and password. You set the credentials either in plain text\r\nor hashed format.\r\n##### Service Broker Credentials\r\nCredentials in plain text format used by the Cloud Controller and other clients to call the service broker.\r\nIt is an object where each key is a user name and the value is the respective password. It may contain multiple credentials but at least one is required.\r\n\r\nExample:\r\n```json\r\n{\r\n  \"user1\": \"password1\",\r\n  \"user2\": \"password2\"\r\n}\r\n```\r\n\r\nThese credentials can be provided via the option `brokerCredentials` or the environment variable `SBF_BROKER_CREDENTIALS`.\r\n\r\n**Note:** Service broker credentials must be provided either in plain text or [hashed](#service-broker-hashed-credentials) format.\r\n\r\n##### Service Broker Hashed Credentials\r\nCredentials in hashed format used by the Cloud Controller and other clients to call the service broker.\r\nIt is an object where each key is a user name and the value is the respective password in format `sha256:<salt>:<hash-digest-of-salt+password>`.\r\nHere `<salt>` and `<hash-digest-of-salt+password>` are _base64_-encoded strings.\r\nIt may contain multiple credentials but at least one is required.\r\n\r\nExample:\r\n```json\r\n{\r\n  \"user1\": \"sha256:gVJILqx/97j4aWVQas5RbSUFpWzu7OpaHOt0O29CJOc=:4klnhxFY2YYwzHO7unYu7jc+HuikQLhF7Ebk8tjOJ9c=\",\r\n  \"user2\": \"sha256:0NRIb4Gzx1zFRTTs6qpElujmHuUE1TAIg3NbES219f0=:Gv1NMeIzxlbmOCLvY3q4DMbiDXamqF3xRfFivUdligo=\"\r\n}\r\n```\r\n\r\nThese credentials can be provided via the option `brokerCredentialsHash` or the environment variable `SBF_BROKER_CREDENTIALS_HASH`.\r\n\r\n**Note:** Service broker credentials must be provided either in [plain text](#servic-broker-plain-text-credentials) or hashed format. \r\n\r\n**Note:** To generate such hashed credentials, you can use the [hash-broker-password](#hash-broker-password) script.\r\n#### mTLS Authentication\r\n##### Out-of-the-Box mTLS\r\n***Note:*** Only available on public PaaS.\r\n\r\n\r\nYou can configure SBF broker to verify the Service Manager-issued client certificate each time the Service Manager communicates with the broker. \r\n\r\nFor that, you need to create your broker with the `secureIncomingConnections` option set to true, or set the environment variable `SBF_SECURE_INCOMING_CONNECTIONS` to true.\r\n\r\nYou also have to specify the Service Manager certificate's subject so that its identity can be verified.\r\nIf you don't specify the Service Manager certificate's subject the out-of-box validation is not performed. \r\n\r\n***Note:***\r\nIn such case, the only validation performed is the one that your provided with the implementation of the  [verifyClientCertificate](#verifyclientcertificateparams-callback) hook. \r\n\r\nIf the hook is also not implemented, the validation fails.  \r\n\r\nTo set the Service Manager certificate's subject, create the broker with the `serviceManagerCertificateSubject` parameter or set the `SBF_SERVICE_MANAGER_CERTIFICATE_SUBJECT` environment variable.\r\nYou can retrieve the Service Manager certificate's subject at `https://service-manager.cfapps.{landscape-domain}/v1/info` from the `service_manager_certificate_subject` field, where `{landscape-domain}` is the landscape in which you registered your broker. \r\n\r\nFor example, calling https://service-manager.cfapps.stagingaws.hanavlab.ondemand.com/v1/info, returns \r\n```\r\n{\r\n  \"token_issuer_url\": \"https://svcmgr.authentication.stagingaws.hanavlab.ondemand.com\",\r\n  \"token_basic_auth\": false,\r\n  \"service_manager_tenant_id\": \"svcmgr-cf-us10-staging\",\r\n  \"service_manager_subaccount_id\": \"svcmgr-cf-us10-staging\",\r\n  \"service_manager_certificate_subject\":\"/C=DE/O=SAP SE/OU=SAP Cloud Platform Clients/OU=Staging/OU=svcmgr-cf-us10-staging/L=service-manager/CN=service-manager\"\r\n}\r\n```\r\n\r\n\r\n You can enhance the out-of-box client certificate verification by implementing the [verifyClientCertificate](#verifyclientcertificateparams-callback) hook. \r\n \r\n With this hook, you can perform your own validations.\r\n\r\n##### Customized mTLS\r\nAlternatively, you can register your broker with your own certificate. \r\n\r\nOnce the service broker has been registered, it will send the client certificate you configured each time it communicates with SBF. \r\n\r\nTo enable this verification, make sure to create your broker with  the `secureIncomingConnections` option set to true, or set the `SBF_SECURE_INCOMING_CONNECTIONS` environment variable to true.\r\nYou have to implement  [verifyClientCertificate](#verifyclientcertificateparams-callback) hook to verify the received certificate.\r\n\r\n### Audit logging\r\n\r\n_@sap/sbf_ writes to audit log for every operation except for _catalog_\r\n(an instance of the Audit log service should be bound to the broker).\r\nThe user is taken from the first of the following that contains a valid value:\r\n- `X-Broker-API-Originating-Identity` header (if provided), property `user_id` (in case running on Cloud Foundry).\r\n- `X-Broker-API-Originating-Identity` header (if provided), property `uid` (in case running on Kubernetes).\r\n- `X-Broker-API-Originating-Identity` header (if provided), property `username` (in case running on Kubernetes).\r\n- The authenticated user that calls the service broker.\r\n\r\nIt is recommended to use the same user in hooks that also write audit messages.\r\nWhat the `X-Broker-API-Originating-Identity` header contains (if present) can be found\r\nin the `originating_identity` property of the `params` object passed to the hook.\r\nIf `originating_identity` is not available, then the `user_id` property can be used.\r\nIt contains the authenticated user that called the broker.\r\n\r\n#### Auditlog Viewer\r\n\r\nIn Cloud Foundry environment the [Auditlog Viewer](https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/e3baa5f1a0c64c44aac8ab3ea3d1b500.html) is the tool used for retrieving audit logs. The tool shows logs for concrete subaccount. In order for the SBF application to write auditlog messages properly it needs **tenant ID**.\r\n\r\n##### Running on XSA\r\nIn XSA environment the tenant ID can be provided but **it is not mandatory**, since the audit logs are viewed in the *SAP HANA Studio* and not in Auditlog viewer (it is deprecated).\r\n\r\n##### Providing the tenant ID\r\nThe value of the tenant ID can be taken from the *SAP CP Cockpit*. It is listed as `ID` in the Subaccount details for the subaccount that will deploy the SBF application.\r\nThen it can be provided to the SBF application:\r\n- manually by setting [`tenantId`](#new-servicebrokeroptions) in SBF options.\r\n- manually by setting [`SBF_TENANT_ID`](#environment-variables) environment variable.\r\n- automatically if XSUAA is used as credentials provider. It is part of the service instance binding.\r\n\r\nThe priority of the above settings is as follows:\r\n`tenantId` > `SBF_TENANT_ID` > *XSUAA service instance binding: credentials.tenantid*\r\n\r\nPlease be aware that if you are running in Cloud Foundry and Audit logging is ***enabled*** you **must provide *tenant ID*** for the broker application. Otherwise it will fail to start with error: `Audit logging is enabled and \"tenantId\" option or \"SBF_TENANT_ID\" environment variable must be provided for successful writing of audit log messages.`.\r\n\r\n## Reference\r\n\r\n### Class: ServiceBroker\r\nService broker class.\r\n\r\n#### new ServiceBroker([options])\r\nCreates a new ServiceBroker instance.\r\n\r\n* `options` *Object* Optional parameter containing the following properties:\r\n  * [`brokerCredentials`](#service-broker-credentials) *Object* The credentials for calling the service broker, if using the plain text format.\r\n  * [`brokerCredentialsHash`](#service-broker-hashed-credentials) *Object* The credentials for calling the service broker, if using the hashed format.\r\n  * [`catalog`](#service-catalog) *String|Object* This property holds the service catalog. If it is a *String*, it should be a path to a JSON file which contains the catalog information.\r\n  * [`serviceConfig`](#additional-service-configuration) *Object* Provides additional deploy-time configuration to extend the service catalog.\r\n  * [`hooks`](#hooks) *Object* Contains callback functions that can extend or customize service broker operations.\r\n  * [`autoCredentials`](#automatic-credentials-generation) *Boolean* Enable automatic credentials generation.\r\n  * [`credentialsProviderService`](#credentials-provider-service) *String* The name of the credentials provider service instance.\r\n  * [`sbssRestrictedUserService`](#credentials-provider-service) *String* The name of the service containing SBSS restricted user credentials.\r\n  * [`catalogSuffix`](#unique-service-broker) *String* Suffix which will be appended to each service name, ID and plan ID in the service catalog to make them unique across Cloud Foundry.\r\n  * [`enableAuditLog`](#audit-logging) *Boolean* Enable/Disable audit logging. Defaults to **true**.\r\n  * [`tenantId`](#auditlog-viewer) *String* Tenant ID of the broker application. It is used for audit logging. Mandatory if the broker is running on CF and audit logging is enabled.\r\n  * [`secureOutgoingConnections`](#secure-outgoing-connections) *Boolean* If *false*, unencrypted outgoing connections will be allowed. Default value is **true**.\r\n  * [`secureIncomingConnections`](#mtls-authentication) *Boolean* If set to *true*, secure connection is established and the custom hook [verifyClientCertificate](#verifyclientcertificateparams-callback) is called . For the automatic verification of the Service Manager certificate's subject, you also have to configure the `serviceManagerCertificateSubject`. Default value is **false**.\r\n  * [`serviceManagerCertificateSubject`](#out-of-the-box-mtls) *String* If `secureIncomingConnections` is set to true and `serviceManagerCertificateSubject` is configured to the Service Manager certificate's subject in the broker's landscape, the Service Manager [client certificate](#out-of-the-box-mtls) is verified in each public landscape.\r\n  * [`clientCertificateKey`](#authentication-using-x509-client-certificates) *String* the private key corresponding to the client certificate used for authentication with XSUAA.\r\n  * [`secureUAAScopes`](#xsuaa) *Boolean* Relevant for [XSUAA as a credentials provider](#xsuaa). When set to `true` and no `authorities` section was provided in [Additional service configuration](#additional-service-configuration) (`extend_xssecurity`), SBF will pass an empty `authorities` array in create/update requests to XSUAA, regardless of the `authorities` provided by the consumer. Default: `true`.<br/> **Note: This behavior and environment variable form an incompatible change from release v6.4.9**.\r\n  * [`k8sSecretsPath`](#credentials-providers) *String* the path to the mounted volume containing service secrets when running on K8S. Default is '/etc/secrets/sapcp/'.\r\n\r\n#### ServiceBroker.start()\r\nStarts the service broker.\r\n\r\n* _returns_ the [http.Server](https://nodejs.org/api/http.html#http_class_http_server) used by the service broker\r\n\r\nYou can attach handlers for 'error' and 'listening' events like this:\r\n```js\r\nlet broker = new ServiceBroker(options);\r\nlet server = broker.start();\r\nserver.on('error', err => console.error(err));\r\nserver.on('listening', () => console.log('Listening'));\r\n```\r\n\r\n#### ServiceBroker.app\r\nExpress application which you can use as a middleware. See [Service broker as middleware](#service-broker-as-middleware).\r\n\r\n#### ServiceBroker.callXsuaa(req, options, callback)\r\nUtility function to easily make HTTP calls to XSUAA. Authentication to XSUAA is performed internally.\r\n\r\n* `req` *Object* Details can be found [here](#req).\r\n* `options` *Object* Parameter containing the following properties:\r\n  * `baseUrlProperty` *String* Name of a property from the XSUAA credentials to be used as base URL. Defaults to `url`.\r\n  * `path` *String* XSUAA REST API endpoint. This path will be appended to the XSUAA base URL internally.\r\n  * The [options](https://github.com/request/request#requestoptions-callback) described in the documentation of the [request](https://www.npmjs.com/package/request) package.\r\n* `callback` *function(error, res, body)*\r\n  * The [parameters](https://github.com/request/request#requestoptions-callback) described in the documentation of the [request](https://www.npmjs.com/package/request) package.\r\n\r\nExample:\r\n```js\r\nconst Broker = require('@sap/sbf');\r\n\r\nlet broker = new Broker({\r\n  hooks: {\r\n    onProvision: (params, callback) => {\r\n      const encodedInstanceId = encodeURIComponent(params['instance_id']);\r\n      let options = {\r\n        path: `/sap/rest/broker/clones/${encodedInstanceId}`,\r\n        method: 'GET'\r\n      };\r\n      broker.callXsuaa(params.req, options, (err, res, body) => {\r\n        if (err) { return callback(err); }\r\n\r\n        if (res.statusCode !== 200) {\r\n          return callback(new Error(`Status code: ${res.statusCode}. Body: ${body}`));\r\n        }\r\n\r\n        try {\r\n          const cloneInfo = JSON.parse(body);\r\n          console.log('XSUAA clone info:', cloneInfo);\r\n          callback();\r\n        } catch (err) {\r\n          callback(new Error(`Failed to parse UAA response with status code ${res.statusCode} and body ${body}`));\r\n        }\r\n      });\r\n    }\r\n  }\r\n});\r\nlet server = broker.start();\r\n```\r\n\r\n#### (static) ServiceBroker.createCredentialsProvider(credentials)\r\n\r\nCreates a suitable [credentials provider](#credentials-providers) instance according to the passed `credentials`.\r\nDisabling [automatic credentials generation](#automatic-credentials-generation) and manually creating a credentials provider allows using multiple providers in the same broker and brings more flexibility when extending the broker with custom code.\r\n\r\n**Note**: This approach requires implementing the relevant hooks (`onProvision`, `onBind`, `onUnbind` and `onDeprovision`) and calling the respective method on the created provider.\r\n\r\n* `credentials` *Object* Credentials for a UAA or an SBSS service.\r\n\r\n**Note**: If using SBSS on PostgreSQL, the restricted user properties should be provided in the `restrictedUser` property of `credentials`. Example:\r\n\r\n```js\r\nconst credentials = xsenv.cfServiceCredentials('postgre-service-name');\r\ncredentials.restrictedUser = xsenv.cfServiceCredentials('restricted-user-service-name');\r\nconst provider = Broker.createCredentialsProvider(credentials);\r\n```\r\n\r\n* Returns a [credentials provider](#credentials-providers) instance.\r\n\r\nA credentials provider has the following methods:\r\n\r\n* `provision(req, callback)`\r\nPerforms operations associated with service provisioning.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `callback` *function(error, operationData)* An error is received in the callback in case of operations' failure. `operationData` (optional) *Object* Contains operation data provided by the credentials provider. In case XSUAA is used as a credentials provider `operationData` contains a property `xsuaa` which is an *Object* described [here](#xsuaa-clone-info).\r\n\r\n* `update(req, callback)`\r\nPerforms operations associated with service updating.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `callback` *function(error, operationData)* An error is received in the callback in case of operations' failure. `operationData` (optional) *Object* Contains operation data provided by the credentials provider. In case XSUAA is used as a credentials provider `operationData` contains a property `xsuaa` which is an *Object* described [here](#xsuaa-clone-info).\r\n\r\n* `bind(req, callback)`\r\nPerforms operations associated with service binding.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `callback` *function(error, credentials)* An error is received in the callback in case of operations' failure. `credentials` is an object containing the generated credentials.\r\n\r\n* `unbind(req, callback)`\r\nPerforms operations associated with service unbinding.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `callback` *function(error)* An error is received in the callback in case of operations' failure.\r\n\r\n* `deprovision(req, callback)`\r\nPerforms operations associated with service deprovisioning.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `callback` *function(error)* An error is received in the callback in case of operations' failure.\r\n\r\nIn addition, a UAA credentials provider has the following method:\r\n\r\n* `callXsuaa(req, options, callback)`\r\nSee [this section](#servicebrokercallxsuaareq-options-callback) for more information.\r\n\r\nExample:\r\n\r\n```js\r\nconst Broker = require('@sap/sbf');\r\n\r\n// Applications can have a single provider:\r\n// const provider = Broker.createCredentialsProvider({ /* ... */ })\r\n\r\n// or multiple providers, shown below\r\n\r\nlet broker = new Broker({\r\n  autoCredentials: false,\r\n  hooks: {\r\n    onProvision: (params, callback) => {\r\n      // validate request's params\r\n      const provider = Broker.createCredentialsProvider({ /* ... */ });\r\n      provider.provision(params.req, callback);\r\n    },\r\n    onBind: (params, callback) => {\r\n      const provider = Broker.createCredentialsProvider({ /* ... */ });\r\n      provider.bind(params.req, (err, credentials) => {\r\n        if (err) { return callback(err); }\r\n        credentials.url = '...';\r\n        callback(null, { credentials });\r\n      });\r\n    },\r\n    onUnbind: (params, callback) => {\r\n      const provider = Broker.createCredentialsProvider({ /* ... */ });\r\n      provider.unbind(params.req, callback);\r\n    },\r\n    onDeprovision: (params, callback) => {\r\n      const provider = Broker.createCredentialsProvider({ /* ... */ });\r\n      provider.deprovision(params.req, callback);\r\n    }\r\n  }\r\n});\r\nlet server = broker.start();\r\n```\r\n\r\n**Note**: Provision and bind are operations associated with creating a resource in the service used for credentials generation. If an error has occurred in a hook after the respective provider method has been called (i.e. `provider.provision` and `provider.bind`), it is recommended that hooks also call the opposite method (i.e. `provider.deprovision` and `provider.unbind`) to clean up the already created resources.\r\n\r\n### Service Broker Credentials\r\nCredentials in plain text format used by the Cloud Controller and other clients to call the service broker.\r\nIt is an object where each key is a user name and the value is the respective password. It may contain multiple credentials but at least one is required.\r\n\r\nExample:\r\n```json\r\n{\r\n  \"user1\": \"password1\",\r\n  \"user2\": \"password2\"\r\n}\r\n```\r\n\r\nThese credentials can be provided via the option `brokerCredentials` or the environment variable `SBF_BROKER_CREDENTIALS`.\r\n\r\n**Note:** Service broker credentials must be provided either in plain text or [hashed](#service-broker-hashed-credentials) format. The service broker will not work if credentials in neither or both formats are present.\r\n\r\n### Service Broker Hashed Credentials\r\nCredentials in hashed format used by the Cloud Controller and other clients to call the service broker.\r\nIt is an object where each key is a user name and the value is the respective password in format `sha256:<salt>:<hash-digest-of-salt+password>`.\r\nHere `<salt>` and `<hash-digest-of-salt+password>` are _base64_-encoded strings.\r\nIt may contain multiple credentials but at least one is required.\r\n\r\nExample:\r\n```json\r\n{\r\n  \"user1\": \"sha256:gVJILqx/97j4aWVQas5RbSUFpWzu7OpaHOt0O29CJOc=:4klnhxFY2YYwzHO7unYu7jc+HuikQLhF7Ebk8tjOJ9c=\",\r\n  \"user2\": \"sha256:0NRIb4Gzx1zFRTTs6qpElujmHuUE1TAIg3NbES219f0=:Gv1NMeIzxlbmOCLvY3q4DMbiDXamqF3xRfFivUdligo=\"\r\n}\r\n```\r\n\r\nThese credentials can be provided via the option `brokerCredentialsHash` or the environment variable `SBF_BROKER_CREDENTIALS_HASH`.\r\n\r\n**Note:** Service broker credentials must be provided either in [plain text](#service-broker-credentials) or hashed format. The service broker will not work if credentials in neither or both formats are present.\r\n\r\n**Note:** To generate such hashed credentials, you can use the [hash-broker-password](#hash-broker-password) script.\r\n\r\n### Service Catalog\r\nThis is a JSON object describing all services and plans offered by this service broker. Its structure is described in [Catalog Management](https://docs.cloudfoundry.org/services/api.html#catalog-management) in Cloud Foundry documentation.\r\n\r\nBy default the service catalog is loaded from *./catalog.json* file. Alternatively, the catalog file could be explicitly set via the `SBF_CATALOG_FILE` environment variable.\r\n\r\n**Note:** In case of IAS as a credentials provider, the catalog is provided to the IAS instance. Do not provide the *./catalog.json* file. See more in the [IAS](#ias) section.\r\n\r\n**Note:** Each service name, ID and plan ID in the catalog must be unique across Cloud Foundry.\r\nGUIDs are recommended for service ID and plan ID.\r\nSee [Unique service broker](#unique-service-broker).\r\n\r\n**Warnings for broker authors:**\r\n- Be cautious when removing services and plans from their catalogs, as platform marketplaces might have provisioned service instances of these plans. Consider your deprecation strategy.\r\n- Do not change the IDs of services and plans. This action is likely to be evaluated by a platform marketplace as a removal of one plan and addition of another. See above warning about removal of plans.\r\n\r\n**Note:** For the service image to display correctly in the cockpit it should be encoded as Base64 in the property `metadata.imageUrl` instead of a URL.\r\n\r\nService catalog example:\r\n```json\r\n{\r\n  \"services\": [{\r\n    \"name\": \"not-real-service\",\r\n    \"id\": \"acb56d7c-XXXX-XXXX-XXXX-feb140a59a66\",\r\n    \"description\": \"Just an example service\",\r\n    \"tags\": [\"no-sql\", \"relational\"],\r\n    \"requires\": [\"route_forwarding\"],\r\n    \"bindable\": true,\r\n    \"metadata\": {\r\n      \"provider\": {\r\n        \"name\": \"The name\"\r\n      },\r\n      \"listing\": {\r\n        \"imageUrl\": \"http://example.com/cat.gif\",\r\n        \"blurb\": \"Add a blurb here\",\r\n        \"longDescription\": \"A long time ago, in a galaxy far far away...\"\r\n      },\r\n      \"displayName\": \"The Fake Broker\"\r\n    },\r\n    \"dashboard_client\": {\r\n      \"id\": \"398e2f8e-XXXX-XXXX-XXXX-19a71ecbcf64\",\r\n      \"secret\": \"277cabb0-XXXX-XXXX-XXXX-7822c0a90e5d\",\r\n      \"redirect_uri\": \"http://localhost:1234\"\r\n    },\r\n    \"plan_updateable\": true,\r\n    \"plans\": [{\r\n      \"name\": \"fake-plan-1\",\r\n      \"id\": \"d3031751-XXXX-XXXX-XXXX-a42377d3320e\",\r\n      \"description\": \"Shared fake Server, 5tb persistent disk, 40 max concurrent connections\",\r\n      \"max_storage_tb\": 5,\r\n      \"metadata\": {\r\n        \"costs\":[\r\n            {\r\n               \"amount\":{\r\n                  \"usd\":99.0\r\n               },\r\n               \"unit\":\"MONTHLY\"\r\n            },\r\n            {\r\n               \"amount\":{\r\n                  \"usd\":0.99\r\n               },\r\n               \"unit\":\"1GB of messages over 20GB\"\r\n            }\r\n         ],\r\n        \"bullets\": [\r\n            \"Shared fake server\",\r\n            \"5 TB storage\",\r\n            \"40 concurrent connections\"\r\n        ],\r\n      }\r\n    }, {\r\n      \"name\": \"fake-plan-2\",\r\n      \"id\": \"0f4008b5-XXXX-XXXX-XXXX-dace631cd648\",\r\n      \"description\": \"Shared fake Server, 5tb persistent disk, 40 max concurrent connections. 100 async\",\r\n      \"max_storage_tb\": 5,\r\n      \"metadata\": {\r\n        \"costs\":[\r\n            {\r\n               \"amount\":{\r\n                  \"usd\":199.0\r\n               },\r\n               \"unit\":\"MONTHLY\"\r\n            },\r\n            {\r\n               \"amount\":{\r\n                  \"usd\":0.99\r\n               },\r\n               \"unit\":\"1GB of messages over 20GB\"\r\n            }\r\n         ],\r\n        \"bullets\": [\r\n          \"40 concurrent connections\"\r\n        ]\r\n      }\r\n    }]\r\n  }]\r\n}\r\n```\r\n\r\n### Additional Service Configuration\r\nThis is a JSON object that provides additional deploy-time configuration.\r\nUsually this is used for configurations which are not known in advance like URLs.\r\nEach key in this object should match a service `name` in the catalog. Its value should be an object with the following optional properties:\r\n* `extend_credentials` An object, containing these optional properties.\r\n  * `shared` An object that is merged with the `credentials` object returned by the *bind* operation for this service.\r\n  * `per_plan` An object where each key should match a plan of this service. The value is an object that is merged with the `credentials` object returned by the *bind* operation for this service and plan.\r\n  Overrides any common properties in `shared` object.\r\n* `extend_xssecurity` An object, containing these optional properties.\r\n  * `shared` An object that will overwrite the properties that are sent to the XSUAA on service instance creation. It should have the same structure as [xs-security.json].\r\n  * `per_plan` An object where each key should match a plan of this service. The value is an object that overwrites the properties that are sent to XSUAA when a service instance of this plan is created. This object should have the same structure as [xs-security.json].\r\n  Overrides any common properties in `shared` object.\r\n* `extend_catalog` An object that is merged with the object describing this service in the catalog.\r\n\r\nAll of these properties are optional.\r\n\r\nThis configuration can be provided via the option `serviceConfig` or the environment variable `SBF_SERVICE_CONFIG`.\r\n\r\nExample:\r\n```js\r\n{\r\n  \"service1\": {\r\n    \"extend_credentials\": {\r\n      \"shared\": {\r\n        // This will go into credentials when binding\r\n        // Common properties for all plans\r\n      },\r\n      \"per_plan\": {\r\n        \"plan1\": {\r\n          // Properties specific to this plan\r\n          // This will be merged with \"shared\" and will go to credentials when binding\r\n        },\r\n        \"plan2\": {\r\n          \"uri\": \"http://some.host/plan2\"\r\n        }\r\n      }\r\n    },\r\n    \"extend_xssecurity\": {\r\n      \"shared\": {\r\n        // This object will extend the properties that are sent to the XSUAA on service instance creation\r\n        // Common properties for all plans\r\n        \"authorities\": [\"$XSMASTERAPPNAME.shared_limited_scope\"]\r\n      },\r\n      \"per_plan\": {\r\n        \"plan1\": {\r\n          // This object will extend the properties that are sent to the XSUAA on service instance creation\r\n          // This will overwrite \"shared\" properties\r\n          \"authorities\": [\"$XSMASTERAPPNAME.plan_limited_scope\"]\r\n        }\r\n      }\r\n    },\r\n    \"extend_catalog\": {\r\n      // Will hold free-form JSON that will be merged with the catalog description for service \"service1\"\r\n      \"dashboard_client\": {\r\n        \"id\": \"133423\",\r\n        \"secret\": \"secret\",\r\n        \"redirect_uri\": \"http://some.host/dashboard\"\r\n      },\r\n      \"metadata\": {\r\n        \"documentationUrl\": \"http://vendor.com/docs\",\r\n        \"supportUrl\": \"http://vendor.com/support\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n### Automatic Credentials Generation\r\nBy default this module will try to find a suitable credentials provider service using the strategies described [here](#credentials-providers).\r\n\r\nThis behavior can be disabled via the `autoCredentials` option so you can take full control of credentials generation in your code.\r\nIn this case the `onBind` hook must be implemented as it is responsible for providing the credentials in the reply.\r\n\r\n**Note:** To ensure consistent security, it is highly recommended that applications and services use security features provided by the platform instead of implementing their own.\r\n\r\n### Credentials Provider Service\r\n\r\nIt is possible to explicitly specify the credentials provider service name when [automatic credentials generation](#automatic-credentials-generation) is enabled. This could be achieved via the `credentialsProviderService` option or via the environment variable `SBF_CREDENTIALS_PROVIDER_SERVICE`.\r\n\r\nThe same applies for providing restricted user credentials (SBSS on PostgreSQL case) where the service name can be provided via the `sbssRestrictedUserService` option or via the environment variable `SBF_SBSS_RESTRICTED_USER_SERVICE`.\r\n\r\nNotice that when running on K8S you should also provide a path to the volume where you have mounted those credentials unless you're relying on the default one. See k8sSecretsPath option [here](#new-servicebrokeroptions).\r\n\r\n### Business Service Support\r\n\r\nSBF will automatically add the following properties to the credentials returned in the response to a bind request:\r\n* `html5-apps-repo` - object containing `app_host_id` property\r\n* `sap.cloud.service`\r\n* `sap.cloud.service.alias`\r\n* `saasregistryenabled`\r\n\r\n**Note:** In case of IAS as a credentials provider, properties `sap.cloud.service`, `sap.cloud.service.alias` and `saasregistryenabled` will not be automatically returned. See more in the [IAS](#ias) section.\r\n\r\n**Note:** In order to provide the `html5-apps-repo` automatically as part of the service credentials, the service broker must be bound to at least one *html5-apps-repo* service instance (*app-host* plan). In the case of K8S the service instance will be looked up by label *html5-apps-repo*.\r\n\r\nIt is also possible to dynamically provide `app_host_id` in the [`onBind`](#onbindparams-callback) hook which will be merged with the `app_host_id`(s) of the already bound *html5-apps-repo* service instance(s) (if any). This can be achieved via the `reply.credentials` object returned by the `onBind` hook:\r\n\r\n```js\r\nfunction onBind(params, callback) {\r\n  // obtain 'app_host_id'\r\n  const appHostId = 'dynamic_app_host_id';\r\n\r\n  const reply = {\r\n    credentials = {\r\n      'html5-apps-repo': {\r\n        'app_host_id': appHostId // Multiple `app_host_id`s can be provided in a comma-separated list without spaces (e.g. 'app-host-1,app-host-2').\r\n      }\r\n    }\r\n  }\r\n\r\n  callback(null, reply);\r\n}\r\n```\r\n\r\n**Note:** It is expected that the `sap.cloud.service`, `sap.cloud.service.alias` and the `saasregistryenabled` properties are defined in the service catalog, under the `sapservice` property of the service metadata, for example:\r\n```json\r\n{\r\n  \"services\": [{\r\n    \"name\": \"fake-service\",\r\n    \"id\": \"acb56d7c-XXXX-XXXX-XXXX-feb140a59a66\",\r\n    \"description\": \"fake service\",\r\n    \"tags\": [\"no-sql\", \"relational\"],\r\n    \"bindable\": true,\r\n    \"metadata\": {\r\n      \"sapservice\": {\r\n        \"sap.cloud.service\": \"com.sap.sbf.testservice\",\r\n        \"sap.cloud.service.alias\": \"country\",\r\n        \"saasregistryenabled\": true\r\n      }\r\n    },\r\n    \"plan_updateable\": true,\r\n    \"plans\": [{\r\n      \"name\": \"fake-plan-1\",\r\n      \"id\": \"d3031751-XXXX-XXXX-XXXX-a42377d3320e\",\r\n      \"description\": \"Shared fake Server, 5tb persistent disk, 40 max concurrent connections\",\r\n      \"max_storage_tb\": 5,\r\n    }]\r\n  }]\r\n}\r\n```\r\n\r\n### Hooks\r\nHooks are custom callback functions that allow you to extend and even replace default service broker functionality.\r\n\r\n\r\n#### `verifyClientCertificate(params, callback)`\r\nThis hook is called on each received request in SBF if the service broker was configured with the `SBF_SECURE_INCOMING_CONNECTIONS` parameter (See [Environment variables](#environment-variables)) set to true.\r\n\r\n* `params` *Object*\r\n  * `clientCertificate` *String*  Service Manager certificate.  \r\n  * `req` *Object* See [here](#req) for more details.\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error Handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to each request.\r\n  \r\n```js\r\n  const broker = new Broker({\r\n    autoCredentials: true,\r\n  \thooks: {\r\n      verifyClientCertificate:(params, callback) =>{\r\n          console.log(params.clientCertificate);\r\n          //do you validations here\r\n          //in case of failed verification pass Forbidden\r\n           callback(new Forbidden());\r\n                              \r\n      }\r\n    }});\r\n  broker.start();\r\n```\r\n\r\nSBF performs no additional processing for this operation.\r\n\r\n**Note:** Implementing `verifyClientCertificate` is not mandatory.\r\n\r\n#### `onProvision(params, callback)`\r\nCalled when the broker receives a *provision* request.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (more information about the structure can be found [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `xsuaa` *Object* (Optional) Details can be found [here](#xsuaa-clone-info).\r\n  * The parameters described in the OSB API specification under [Provisioning, Parameters](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#parameters-1)\r\n  * The fields described in the OSB API specification under [Provisioning, Body](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#body-2)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *provision* request.\r\n    * `async` *Boolean* (Optional) Specifies whether the provision operation is started asynchronously. Default is `false`. It will not be included in the response.\r\n    * `dashboard_url` *String* (Optional) The URL of a web-based management user interface for the service instance; we refer to this as a service dashboard. The URL MUST contain enough information for the dashboard to identify the resource being accessed. **Note:** a broker that wishes to return *dashboard_url* for a service instance MUST return it with the initial response to the provision request, even if the service is provisioned asynchronously.\r\n    * `operation` *String* (Optional) For asynchronous responses, service brokers MAY return an identifier representing the operation. The value of this field SHOULD be provided by the broker client with requests to the Last Operation endpoint in a URL encoded query parameter.\r\n\r\n**Note:** The default SBF operation is executed _before_ this hook is called. For example, if XSUAA is used, the OAuth client clone is already created.\r\n\r\n#### `onUpdate(params, callback)`\r\nCalled when the broker receives an *update* request.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (more information about the structure can be found [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * `xsuaa` *Object* (Optional) Details can be found [here](#xsuaa-clone-info).\r\n  * The parameters described in the OSB API specification under [Updating a Service Instance, Parameters](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#parameters-2)\r\n  * The fields described in the OSB API specification under [Updating a Service Instance, Body](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#body-4)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *update* request.\r\n    * `async` *Boolean* (Optional) Specifies whether the update operation is started asynchronously. Default is `false`. It will not be included in the response.\r\n    * `operation` *String* (Optional) For asynchronous responses, service brokers MAY return an identifier representing the operation. The value of this field SHOULD be provided by the broker client with requests to the Last Operation endpoint in a URL encoded query parameter.\r\n\r\n**Note:** The default SBF operation is executed _before_ this hook is called. For example, if XSUAA is used, the OAuth client clone is already updated.\r\n\r\n#### `onDeprovision(params, callback)`\r\nCalled when the broker receives a *deprovision* request.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (more information about the structure can be found [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * The parameters described in the OSB API specification under [Deprovisioning, Parameters](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#parameters-4)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *deprovision* request.\r\n    * `async` *Boolean* (Optional) Specifies whether the deprovision operation is started asynchronously. Default is `false`. It will not be included in the response.\r\n    * `operation` *String* (Optional) For asynchronous responses, service brokers MAY return an identifier representing the operation. The value of this field SHOULD be provided by the broker client with requests to the Last Operation endpoint in a URL encoded query parameter.\r\n\r\n**Note:** The default SBF operation is executed right _after_ this hook and before the HTTP response is returned.\r\nFor example, if XSUAA is used, the OAuth client clone will be deleted right after this hook, even in case of an async operation (`reply.async == true`).\r\n\r\n**Note:** This hook should be repeatable (idempotent), i.e. if it completes successfully once, any subsequent invocations with the same parameters should be successful too. This is necessary in case the default SBF operation fails. Then it should be possible to repeat the whole operation to complete the cleanup. Also the platform may execute _deprovision_ after a failed _provision_ operation as part of [orphan mitigation](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#orphans). So `onDeprovision` hook may be called even when the service instance and associated resources do not exist.\r\n\r\n#### `onLastOperation(params, callback)`\r\nCalled when the broker receives a *last operation* request for an **instance**.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (more information about the structure can be found [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * The parameters described in the OSB API specification under [Polling Last Operation, Parameters](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#parameters)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *last operation* request.\r\n    * `state` *String* Valid values are \"in progress\", \"succeeded\", and \"failed\". While \"state\": \"in progress\", the platform SHOULD continue polling. A response with \"state\": \"succeeded\" or \"state\": \"failed\" MUST cause the platform to cease polling.\r\n    * `description` *String* (Optional) A user-facing message displayed to the platform API client. Can be used to tell the user details about the status of the operation.\r\n\r\n\r\nSBF performs no additional processing for this operation, except for [IAS as credentials provider](#ias), where the request is proxied to the IAS Broker.\r\n\r\n**Note:** Implementing `onLastOperation` is mandatory, if any other instance operation hook returns `reply.async = true` (apart from IAS flow). If this hook is not implemented, SBF returns status 501 (Not Implemented). If IAS is the credentials provider, the hook is optional.\r\n\r\nSee [Asynchronous broker operations](#asynchronous-broker-operations) for more information.\r\n\r\n#### `onBindLastOperation(params, callback)`\r\nCalled when the broker receives a *last operation* request for **binding**.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `binding_id` *String* Service binding ID\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (You can find more information about the structure [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* You can find the details [here](#req).\r\n  * The parameters described in the OSB API specification under [Polling Last Operation, Parameters](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#parameters)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *last operation* request.\r\n    * `state` *String* Valid values are \"in progress\", \"succeeded\", and \"failed\". While \"state\": \"in progress\", the platform SHOULD continue polling. A response with \"state\": \"succeeded\" or \"state\": \"failed\" MUST cause the platform to cease polling.\r\n    * `description` *String* (Optional) A user-facing message displayed to the platform API client. Can be used to tell the user details about the status of the operation.\r\n\r\nSBF performs no additional processing for this operation, except for [IAS as credentials provider](#ias), where the request is proxied to the IAS Broker.\r\n\r\n**Note:** Implementing `onBindLastOperation` is mandatory, if any other binding operation hook returns `reply.async = true` (apart from IAS flow). If this hook is not implemented, SBF returns status 501 (Not Implemented). If IAS is the credentials provider, the hook is optional.\r\n\r\nSee [Asynchronous broker operations](#asynchronous-broker-operations) for more information.\r\n\r\n#### `onFetchInstanceParams(params, callback)`\r\nCalled when the broker receives an *instance parameters* request.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (you can find more information about the structure [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* See [here](#req) for more details.\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *instance parameters* request.\r\n\r\nSBF performs no additional processing for this operation.\r\n\r\n**Note:** Make sure to set the `instances_retrievable` property in the broker catalog to `true`.\r\n\r\n**Note:** Implementing `onFetchInstanceParams` is not mandatory, but we recommend that you implement it together with the [onProvision hook](#onprovisionparams-callback),which is used to store parameters (SBF doesn't handle parameters' storage). If this hook isn't implemented, SBF returns status 501 (Not Implemented).\r\n\r\n**Note:** The OSB specification defines the expected response body for this request. Please review it [here](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#fetching-a-service-instance). For instance, the response body expects a `parameters` object, which is what CF is looking for as an OSB platform.\r\n\r\n#### `onBind(params, callback)`\r\nCalled when the broker receives a *bind* request.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `binding_id` *String* Service binding ID. It will be used for future unbind requests, so the broker will use it to correlate the resource it creates.\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (more information about the structure can be found [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `generatedCredentials` *Object* (Optional) The credentials object generated by the [credentials provider](#credentials-providers). It is not provided if the `autoCredentials` option is `false`.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * The fields described in the OSB API specification under [Binding, Body](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#body-6)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *bind* request.\r\n    * `credentials` *Object* A free-form object of credentials that can be used by applications or users to access the service.\r\n\r\nThe `credentials` object in the response will be produced by merging:\r\n1. `reply.credentials` returned from `onBind`\r\n2. Credentials generated by the [Credentials Provider Service](#credentials-provider-service), unless [disabled](#automatic-credentials-generation)\r\n3. The properties described in the [Business Service Support](#business-service-support) section\r\n4. Binding properties for the given service and plan from [Additional Service Configuration](#additional-service-configuration)\r\n\r\nHere each object overwrites common properties in the next one.\r\n\r\n**Note:** The default SBF operation is executed _before_ this hook is called. For example, if SBSS is used, the binding credentials are already created.\r\n\r\n**Note:** Implementing `onBind` hook is mandatory, if `autoCredentials` option is `false`.\r\nIn this case `onBind` must provide the necessary credentials in `reply.credentials`.\r\n\r\n#### `onUnbind(params, callback)`\r\nCalled when the broker receives an *unbind* request.\r\n\r\n* `params` *Object*\r\n  * `instance_id` *String* Service instance ID\r\n  * `binding_id` *String* Service binding ID. It will be used for future unbind requests, so the broker will use it to correlate the resource it creates.\r\n  * `originating_identity` *Object* Only available if the `X-Broker-API-Originating-Identity` header is provided in the request.\r\n  Contains the parsed data from the header (more information about the structure can be found [here](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/profile.md#originating-identity-header)).\r\n  * `user_id` *String* The authenticated user that called the broker.\r\n  * `req` *Object* Details can be found [here](#req).\r\n  * The parameters described in the OSB API specification under [Unbinding, Parameters](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#parameters-3)\r\n* `callback` *function(error, reply)*\r\n  * `error` *Object* See [Error handling](#error-handling).\r\n  * `reply` *Object* An object returned as a response to the *unbind* request.\r\n\r\n**Note:** The default SBF operation is executed right _after_ this hook and before the HTTP response is returned.\r\nFor example, if SBSS is used, the binding credentials will be deleted right after this hook.\r\n\r\n**Note:** This hook should be repeatable (idempotent), i.e. if it completes successfully once, any subsequent invocations with the same parameters should be successful too. This is necessary in case the default SBF operation fails. Then it should be possible to repeat the whole operation to complete the cleanup. Also the platform may execute _unbind_ after a failed _bind_ operation as part of [orphan mitigation](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#orphans). So `onUnbind` hook may be called even when the service binding and associated resources do not exist.\r\n\r\n#### `params` details\r\n\r\n##### `req`\r\n\r\nAn [IncommingMessage](https://nodejs.org/api/http.html#http_class_http_incomingmessage) instance with additional properties:\r\n- `loggingContext` - attached to the request object by the _@sap/logging_ library, provides means of getting loggers and tracers. The `correlationId` property provided by the `loggingContext` can be used to correlate log entries from different components involved in a broker operation. More information is available in the documentation of the _@sap/logging_ package.\r\n\r\n##### `XSUAA clone info`\r\n\r\nAn *Object*, currently only provided in case XSUAA is used as a credentials provider. It contains OAuth client clone information. Available properties:\r\n- `tenantId` *String*\r\n\r\n#### Error handling\r\nThe `callback` function passed to each hook takes an `error` as its first argument.\r\nThis is the standard conventions for callback functions in Node.js.\r\n\r\n**Note:** The hook must call the `callback` _exactly_ once.\r\n\r\nIn case of success, the hook should pass `null` or `undefined` as `error` argument to the `callback`.\r\n\r\nIn case of error, the hook should pass an [Error](https://nodejs.org/api/errors.html#errors_class_error) object as `error` argument to the `callback`. In this case any subsequent arguments will be ignored.\r\n\r\nIf the `error.statusCode` is set, it will be returned as HTTP status code in the response.\r\nIn this case the error message will be sent to the broker client.\r\nOtherwise the broker will return HTTP status code 500 with a generic error message.\r\n\r\n### Environment variables\r\n\r\n- `SBF_CATALOG_FILE` - path to a catalog file, the default is *./catalog.json*, see [Service Catalog](#service-catalog)\r\n- `SBF_CATALOG_SUFFIX` - suffix to append to all service names, service IDs and plan IDs in the catalog, see [Unique service broker](#unique-service-broker)\r\n- `SBF_BROKER_CREDENTIALS` - JSON object with credentials in plain text format for calling the service broker, see [Service Broker Credentials](#service-broker-credentials)\r\n- `SBF_CLIENT_CERTIFICATE_KEY` - a string that represents the private key corresponding to the client certificate used for authentication with XSUAA, see [Authentication using X.509 client certificates](#authentication-using-x509-client-certificates)\r\n- `SBF_BROKER_CREDENTIALS_HASH` - JSON object with credentials in hashed format for calling the service broker, see [Service Broker Hashed Credentials](#service-broker-hashed-credentials)\r\n- `SBF_SERVICE_CONFIG` - provides additional deploy-time configuration, see [Additional service configuration](#additional-service-configuration)\r\n- `SBF_CREDENTIALS_PROVIDER_SERVICE` - the name of the credentials provider service instance, see [Credentials provider service](#credentials-provider-service)\r\n- `SBF_SBSS_RESTRICTED_USER_SERVICE` - the name of the service containing restricted user credentials (SBSS on PostgreSQL case), see [Credentials provider service](#credentials-provider-service)\r\n- `SBF_UAA_TIMEOUT` - timeout in milliseconds for requests to XSUAA, default is 20 seconds.\r\n- `SBF_SECURE_OUTGOING_CONNECTIONS` - if set to false `false`, unencrypted outgoing connections will be allowed, see [Secure outgoing connections](#secure-outgoing-connections)\r\n- `SBF_SECURE_INCOMING_CONNECTIONS` - if set to true `true`, a [secured connection](#mtls-authentication) is established and the custom hook [verifyClientCertificate](#verifyclientcertificateparams-callback) is called . For the automatic verification of the Service Manager certificate, you also have to configure the `SBF_SERVICE_MANAGER_CERTIFICATE_SUBJECT` environment variable.\r\n- `SBF_SERVICE_MANAGER_CERTIFICATE_SUBJECT` - the Service Manager client certificate's subject. This variable has to be configured so that the Service Manager [client certificate](#out-of-the-box-mtls) is verified. Also, set `SBF_SECURE_INCOMING_CONNECTIONS` to true. You can retrieve the Service Manager certificate's subject at `https://service-manager.cfapps.<landscape domain>/v1/info` from the `service_manager_certificate_subject` field. The URL changes depending on your landscape domains. For example, https://service-manager.cfapps.eu10.hana.ondemand.com/v1/info.\r\n- `SBF_ENABLE_AUDITLOG` - if `false` disable audit logging, otherwise it is enabled.\r\n- `SBF_TENANT_ID` - Mandatory if the broker application is running on Cloud Foundry and audit logging is *enabled*.\r\n- `SBF_SECURE_UAA_SCOPES` - Relevant for [XSUAA as a credentials provider](#xsuaa). When set to `true` and no `authorities` section was provided in [Additional service configuration](#additional-service-configuration) (`extend_xssecurity`), SBF will pass an empty `authorities` array in create/update requests to XSUAA, regardless of the `authorities` provided by the consumer. Default: `true`.<br/> **Note: This behavior and environment variable form an incompatible change from release v6.4.9**.\r\n- `PORT` - the port on which the service broker will listen for requests, default is 8080.\r\n\r\n### `gen-catalog-ids`\r\n\r\nEach service object and each service plan object has a mandatory _id_ field. Its value must be a non-empty string, globally unique within the platform marketplace. Using a GUID is recommended.\r\n\r\nThe _@sap/sbf_ package provides the `gen-catalog-ids` script which generates such GUIDs for you.\r\n\r\n```sh\r\nnpx gen-catalog-ids [<path-to-catalog.json>]\r\n```\r\nHere the file path argument is optional. If not provided, the command will use _catalog.json_ in the current directory.\r\nThis command will insert a new GUID as _id_ property for each service and each plan in the catalog.\r\nIt will not change any existing IDs - only the id properties with empty string for their value and the ones not provided at all.\r\nYou can run it after creating a new catalog or after adding more services or plans.\r\n\r\n**Note:** In the command above you may need to replace the forward slashes with backslashes, depending on your platform.\r\n\r\n### `hash-broker-password`\r\n\r\nIf you use service broker credentials in [hashed format](#service-broker-hashed-credentials), you will need to hash your plain text password. For this purpose the _@sap/sbf_ package provides the `hash-broker-passsword` script which does that for you.\r\n\r\nIf you want to use some password of your own, run:\r\n\r\n```sh\r\nnpx hash-broker-password\r\n```\r\n\r\nYou will be prompted to enter the plaintext password and will be given its hash in format `sha256:<salt>:<hash-digest-of-salt+password>`.\r\nHere `<salt>` is also generated by the script.\r\n\r\nOtherwise you can use the command in _batch_ mode:\r\n\r\n```sh\r\nnpx hash-broker-password -b\r\n```\r\n\r\nThat will generate a random 32-character plaintext password, random 32-byte salt and print them along with the hash.\r\nTake note of the generated password and hash as they will not be persisted.\r\n\r\nWhen you have your service broker hashed credentials generated, you should:\r\n* provide hashed credentials via the option `brokerCredentialsHash` or the environment variable `SBF_BROKER_CREDENTIALS_HASH`\r\n* provide the user and plaintext password when [registering the service broker](#register-the-service-broker).\r\n\r\n## Troubleshooting\r\n\r\n### Increase the log level\r\n\r\nThe service broker framework uses _@sap/logging_ package so all of its features are available to control logging.\r\nFor example to set all logging and tracing to finest level set `XS_APP_LOG_LEVEL` environment variable to `debug`.\r\nSee _@sap/logging_ documentation for details.\r\n\r\nSome of the libraries used by this package employ other tracing mechanisms. For example many use the popular [debug](https://www.npmjs.com/package/debug) package. This means that by setting `DEBUG` environment variable, you can enable additional traces. Set it to `*` to enable all of them, but be careful as the output may be overwhelming.\r\nIn addition, internal Node.js traces can be enabled via `NODE_DEBUG` environment variable.\r\n\r\n**Warning:** Enabling some of these options may trace security sensitive data, so use with caution.\r\n\r\n### @sap/sbf not found\r\n\r\nIf you get the following error during deployment\r\n```\r\n       npm ERR! 404 Not found : @sap/sbf\r\n       npm ERR! 404\r\n       npm ERR! 404  '@sap/sbf' is not in the npm registry.\r\n```\r\nRun `npm install` locally and make sure `node_modules` is not in *.cfignore* file.\r\nThen push again your broker application.\r\n\r\nIf you get that error when you run `npm install` locally, make sure to configure the proper npm registry as described on the wiki of this project.\r\n\r\n### Cannot execute start-broker script\r\n\r\nThe service broker may crash during startup on XS advanced with one of the following errors in the log:\r\n```\r\nexec: start-broker: not found\r\n```\r\n```\r\nstart-broker: cannot execute: Permission denied\r\n```\r\n\r\nThere are two possible solutions:\r\n* Set environment variable `ALWAYS_INSTALL` to `true` for the broker application\r\n* Change the `start` script in _package.json_ like this:\r\n```\r\n\"start\": \"node node_modules/@sap/sbf/sbf.js\"\r\n```\r\n\r\n### Create service fails with \"Client already exists\"\r\n\r\nIf `create-service` operation fails with error \"Client already exists\", you are probably attempting to create a second service instance with the same *xsappname* in the parameters. Note that *xsappname* should be different for each service instance.\r\n\r\n[xs-security.json]: https://help.sap.com/viewer/4505d0bdaf4948449b7f7379d24d0f0d/2.0.03/en-US/6d3ed64092f748cbac691abc5fe52985.html\r\n"}]