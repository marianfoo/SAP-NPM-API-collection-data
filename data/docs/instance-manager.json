[{"name":"CHANGELOG.md","content":"# Change Log\r\nAll notable changes to this project will be documented in this file.\r\n\r\nThis project adheres to [Semantic Versioning](http://semver.org/).\r\n\r\nThe format is based on [Keep a Changelog](http://keepachangelog.com/).\r\n\r\n\r\n## 3.3.4 - 2022-06-10\r\n\r\n### Updated\r\n- Updated devDep async to 3.2.4\r\n\r\n## 3.3.3 - 2022-05-17\r\n\r\n### Fixed\r\n- **Migration Manager.** Fixed typo in cache_item_expire_seconds.\r\n\r\n### Changed\r\n- Changed istanbul test framework with c8.\r\n\r\n## 3.3.2 - 2022-03-14\r\n\r\n### Fixed\r\n- **Service Manager.** Bindings will no longer attempt to be created for non-ready instances.\r\n\r\n## 3.3.1 - 2022-02-16\r\n\r\n### Updated\r\n- Updated xssec to v3.2.13\r\n\r\n## 3.3.0 - 2022-02-04\r\n\r\n### Added\r\n- Support for Node.js v16.x\r\n\r\n### Fixed\r\n- Updated debug package to v4.3.3\r\n\r\n## 3.2.1 - 2022-01-20\r\n\r\n### Added\r\n- **Service Manager.** Added token caching.\r\n\r\n### Updated\r\n- `node-fetch` version updated to v2.6.7.\r\n\r\n## 3.2.0 - 2022-01-12\r\n\r\n### Added\r\n- **Migration Manager.** Implement Migration Manager to help with transition from Instance to Service Manager on Cloud Foundry.\r\n\r\n### Fixed\r\n- **Service Manager.** Fixed Token retrieval max timeout.\r\n\r\n## 3.1.1 - 2022-01-04\r\n\r\n### Fixed\r\n- **Service Manager.** Fixed a bug where if binding creation (fallback) failed it will call callback twice.\r\n\r\n## 3.1.0 - 2021-12-13\r\n\r\n### Added\r\n- **Service Manager.** Support for mTLS authentication\r\n- **Service Manager.** Retrieving an instance will create a binding if no binding exists for that instance.\r\n- **Service Manager.** Creating a new instance will now also put the *tenant_id* as label.\r\n- **Service Manager.** Optional parameters supported for get and getAll to support fallback for mTLS.\r\n\r\n## 3.0.0 - 2021-05-05\r\n\r\n### Fixed\r\n- Replaced dependency request with node-fetch\r\n- Updated debug package to v4.2.0\r\n\r\n### Removed\r\n- Support for Node.js 6\r\n\r\n### Added\r\n- Support for Node.js 14\r\n\r\n## 2.2.0 - 2020-07-24\r\n\r\n### Added\r\n- Integration with Service Manager\r\n\r\n### Fixed\r\n- Update dependencies\r\n- Update license\r\n\r\n## 2.1.0 - 2019-12-10\r\n\r\n### Added\r\n- Support for Node.js v12.x\r\n\r\n## 2.0.0 - 2019-04-24\r\n\r\n### Removed\r\n- Support for Node.js v0.12\r\n- Support for Node.js v4\r\n\r\n## 1.4.0 - 2018-12-18\r\n\r\n### Added\r\n- Node.js version 10 support\r\n\r\n## 1.3.4 - 2018-08-14\r\n\r\n### Fixed\r\n- Update dependencies\r\n\r\n## 1.3.3 - 2018-07-17\r\n\r\n### Fixed\r\n- Update request package to v2.87.0\r\n\r\n## 1.3.2 - 2018-05-28\r\n\r\n### Fixed\r\n- Update request package to v2.86.0\r\n\r\n## 1.3.1 - 2018-04-05\r\n\r\n### Fixed\r\n- Update npm-shrinkwrap.json\r\n\r\n## 1.3.0 - 2018-01-19\r\n\r\n### Added\r\n- npm-shrinkwrap.json\r\n\r\n## 1.2.0 - 2017-10-13\r\n\r\n### Added\r\n- Support for Node.js 8\r\n- Optional argument to `instanceManager.create` - an object with parameters for provisioning or binding\r\n\r\n### Changed\r\n- Dependencies' versions\r\n\r\n## 1.1.0 - 2017-06-01\r\n\r\n### Added\r\n- `instanceManager.getAll` function\r\n\r\n## 1.0.1 - 2017-02-10\r\n\r\n### Fixed\r\n- Update dependencies\r\n\r\n## 1.0.0 - 2017-02-02\r\n\r\n### Added\r\n- Initial implementation\r\n"},{"name":"README.md","content":"# @sap/instance-manager\r\n\r\nNode.js package for creating and deleting service instances per tenant within an application at runtime.\r\n\r\n## Overview\r\n\r\nThis package provides a client for _Instance Manager_, [_Service Manager_](https://peripli.github.io/) and **Migration Manager** - components that create and delete\r\nservice instances (via REST API) for a specified key. These components can be used in the context\r\nof multitenant applications where the tenant id is the key an instance is associated with.\r\n\r\n_Multitenancy_ is a concept for sharing resources between several different\r\nand unrelated to each other groups of users called _tenants_.\r\nExample: subscriptions to a commercial cloud application can be sold to\r\ntwo different companies each of which should use the application in isolation\r\nfrom the other one. Customizations are also applied (e.g. different branding,\r\nidentity providers, database schemas etc.).\r\n\r\nA typical application has access to external resources (e.g. a database or messaging) via _services_.\r\nIf an application is used by different tenants, then using a separate service instance\r\nfor each one will improve isolation since service binding provides access to a resource.\r\n\r\nWith this package a Node.js application can dynamically create and delete service instances per tenant at runtime.\r\n\r\nTo consume _Instance Manager_, an instance of a _managed service_ of the desired type is created first and is then bound to the application.\r\nTaking HANA database as an example, the _managed service_ is called _'managed-hana'_. Its credentials contain HTTP endpoints and credentials only which can later be used by the application for creating and deleting service instances\r\nof the desired type for each tenant.\r\nAll managed instances are of the same plan - the one used during the _managed service_ instance creation (e.g. creating a _managed-hana_ service of plan _hdi-shared_ would mean managing service instances of this plan only).\r\n\r\nTo consume _Service Manager_, an instance of the _service-manager_ service, _container_ plan should be created. Its credentials contain parameters that are used at runtime to manage service instances.\r\nInstances of any available service and plan can be managed with a single instance of _Service Manager_. The application specifies which service and plan to be used by the library.\r\n\r\n#### Migration Manager\r\n\r\nThe\r\n**Migration Manager** is created to a supply smooth migration from _Instance Manager_ (deprecated) to _Service Manager_. To consume\r\n**Migration Manager**, both _Instance Manager_ and _Service Manager_ credentials have to be passed as input (as imOpts and smOpts).\r\n```js\r\nvar createInstanceManager = require('@sap/instance-manager').create;\r\n\r\nvar options = {\r\n  imOpts: { /* properties from service binding */},\r\n  smOpts: {/* properties from service binding */}\r\n};\r\ncreateInstanceManager(options, function (err, instanceManager) {\r\n  if (err) {\r\n    return console.log('Create migration manager error:', err.message);\r\n  }\r\n\r\n  var optionalParameters = {\r\n    /* Optional JSON object containing service-specific configuration parameters */\r\n    \"provisioning_parameters\": { \"<key>\" : \"<key>\" },\r\n  };\r\n  instanceManager.create('my-tenant', optionalParameters, function (err, instance) {\r\n    if (err) {\r\n      return console.log('Create error:', err.message);\r\n    }\r\n\r\n    // consume instance.credentials\r\n    console.log(instance);\r\n\r\n    instanceManager.get('my-tenant', function (err, instance) {\r\n      if (err) {\r\n        return console.log('Get error:', err.message);\r\n      }\r\n\r\n      // same instance\r\n      console.log(instance);\r\n\r\n      instanceManager.delete('my-tenant', function (err) {\r\n        if (err) {\r\n          return console.log('Delete error:', err.message);\r\n        }\r\n\r\n        console.log('Instance deleted');\r\n      });\r\n    });\r\n  });\r\n});\r\n```\r\n**Migration Manager** is applicable only for CF runtime, as _Service Manager_ is not available for XSA.\r\n\r\n## API\r\n\r\n```js\r\nvar createInstanceManager = require('@sap/instance-manager').create;\r\n\r\nvar options = { /* properties from service binding */ };\r\ncreateInstanceManager(options, function (err, migrationManager) {\r\n  if (err) {\r\n    return console.log('Create instance manager error:', err.message);\r\n  }\r\n\r\n  var optionalParameters = {\r\n    /* Optional JSON object containing service-specific configuration parameters */\r\n    \"provisioning_parameters\": { \"<key>\" : \"<key>\" }\r\n  };\r\n  migrationManager.create('my-tenant', optionalParameters, function (err, instance) {\r\n    if (err) {\r\n      return console.log('Create error:', err.message);\r\n    }\r\n\r\n    // consume instance.credentials\r\n    console.log(instance);\r\n\r\n    migrationManager.get('my-tenant', function (err, instance) {\r\n      if (err) {\r\n        return console.log('Get error:', err.message);\r\n      }\r\n\r\n      // same instance\r\n      console.log(instance);\r\n\r\n      migrationManager.delete('my-tenant', function (err) {\r\n        if (err) {\r\n          return console.log('Delete error:', err.message);\r\n        }\r\n\r\n        console.log('Instance deleted');\r\n      });\r\n    });\r\n  });\r\n});\r\n```\r\n\r\n### Options\r\n\r\n#### Instance Manager parameters\r\n\r\nThe following properties are provided in the credentials of the _Instance Manager_ service binding.\r\n\r\nProperty | Mandatory | Details\r\n-------- | --------- | -------\r\nuser | x | User for authentication.\r\npassword | x | Password for the user.\r\npost_managed_instance_url | x | REST endpoint used for creating a new service instance for a tenant.\r\nget_managed_instance_url | x | REST endpoint used for getting the details about a specific tenant service instance.\r\nget_all_managed_instances_url | x | REST endpoint used for getting the details about all instances (for all tenants).\r\ndelete_managed_instance_url | x | REST endpoint used for deletion of a service instance.\r\n\r\n**Note**: A _managed service_ binding contains all the mandatory properties mentioned above.\r\n\r\n#### Service Manager parameters\r\n\r\nProperty | Mandatory | Details\r\n-------- | --------- | -------\r\nsm_url | x | URL of _Service Manager_.\r\nurl | x | URL of _UAA_ server from which to fetch tokens which will be send to _Service Manager_.\r\nclientid | x | Used when retrieving a token.\r\nclientsecret (not required for mTLS) | x | Used when retrieving a token.\r\ncertificate (only for mTLS) | x | Used when retrieving a token.\r\ncerturl (only for mTLS) | x | Used when retrieving a token.\r\nservice |  | Defaults to 'hana'. Name of the service of which to manage instances.\r\nplan |  | Defaults to 'hdi-shared'. Name of a plan from the selected service of which to manage instances.\r\n\r\n**Note**: A _service-manager_ binding contains all the mandatory properties mentioned above. For non-mTLS authentication *clientsecret* is required, where *certificate* and *certurl* are required for mTLS authentication.\r\n\r\n#### Migration Manager parameters\r\n\r\nThe following properties are provided in the credentials of the **Migration Manager** service binding.\r\n\r\nProperty | Mandatory | Details\r\n---------| --------- | -------\r\n| **imOpts**         |\r\nuser | x | User for authentication.\r\npassword | x | Password for the user.\r\npost_managed_instance_url | x | REST endpoint used for creating a new service instance for a tenant.\r\nget_managed_instance_url | x | REST endpoint used for getting the details about a specific tenant service instance.\r\nget_all_managed_instances_url | x | REST endpoint used for getting the details about all instances (for all tenants).\r\nmigrate_managed_instance_url | x | REST endpoint used for getting the details about all instances (for a specific tenant).\r\ndelete_managed_instance_url | x | REST endpoint used for deletion of a service instance.\r\n| **smOpts**         |\r\nsm_url | x | URL of _Service Manager_.\r\nurl | x | URL of _UAA_ server from which to fetch tokens which will be send to _Service Manager_.\r\nclientid | x | Used when retrieving a token.\r\nclientsecret | x | Used when retrieving a token.\r\nservice |  | Defaults to 'hana'. Name of the service of which to manage instances.\r\nplan |  | Defaults to 'hdi-shared'. Name of a plan from the selected service of which to manage instances.\r\n\r\n**Note**: A _migration-manager_ binding contains all the mandatory properties mentioned above.\r\n\r\n#### Migration Manager parameters\r\n\r\nThe following properties are provided in the credentials of the **Migration Manager** service binding.\r\n\r\nProperty | Mandatory | Details\r\n---------| --------- | -------\r\n| **imOpts**         |\r\nuser | x | User for authentication.\r\npassword | x | Password for the user.\r\npost_managed_instance_url | x | REST endpoint used for creating a new service instance for a tenant.\r\nget_managed_instance_url | x | REST endpoint used for getting the details about a specific tenant service instance.\r\nget_all_managed_instances_url | x | REST endpoint used for getting the details about all instances (for all tenants).\r\nmigrate_managed_instance_url | x | REST endpoint used for getting the details about all instances (for a specific tenant).\r\ndelete_managed_instance_url | x | REST endpoint used for deletion of a service instance.\r\n| **smOpts**         |\r\nsm_url | x | URL of _Service Manager_.\r\nurl | x | URL of _UAA_ server from which to fetch tokens which will be send to _Service Manager_.\r\nclientid | x | Used when retrieving a token.\r\nclientsecret | x | Used when retrieving a token.\r\nservice |  | Defaults to 'hana'. Name of the service of which to manage instances.\r\nplan |  | Defaults to 'hdi-shared'. Name of a plan from the selected service of which to manage instances.\r\n\r\n**Note**: A _migration-manager_ binding contains all the mandatory properties mentioned above.\r\n\r\n#### Optional parameters\r\n\r\nThe create and delete operations are executed asynchronously on server side. To provide an easier interface,\r\nthis library also implements polling until an operation is finished. Developers can tune polling\r\nvia some optional properties.\r\n\r\nSince operations involve network activity (thus, can be considered relatively slow) the package\r\nalso caches the created instances. Cache options can also be provided by developers.\r\n\r\nProperty | Details\r\n-------- | -------\r\npolling_interval_millis | Defaults to 300. States how many milliseconds to wait between requests in the polling phase.\r\npolling_timeout_seconds | Defaults to 120. Sets a limit for time (in seconds) that can be spent in polling.\r\ncache_max_items | Defaults to 500. States the capacity of the cache.\r\ncache_item_expire_seconds | Defaults to 600 (10 minutes). Number of seconds after which a cache entry expires.\r\n\r\n**Note**: It is recommended to have a single instance manager JavaScript object per _managed service_ bound to the application. An exception is **Migration Manager** due to its specific setup, instances for both _instance and service manager_ gets created.\r\n\r\n**Note**: Due to details in regard to consuming _Service Manager_ (more communication with the service is required), applications currently using _Instance Manager_ may need to increase the value of the *polling_timeout_seconds* setting.\r\n\r\n### Methods\r\n- `create(tenant, optionalParameters, callback)` - creates a service instance for the provided tenant.\r\nThe method polls until the instance is successfully created and then invokes the callback.\r\nReports an error having a `statusCode` property with value of `409` if an instance for this tenant already exists.\r\n  - tenant | *String* | Tenant name.\r\n  - optionalParameters | *Object* | (*optional*) JSON object with parameters for provisioning or binding, as would be done with the -c options of the CLI commands `create-service` and `bind-service` for unmanaged services. E.g.\r\n  ```json\r\n  {\r\n    \"provisioning_parameters\": { \"database_id\" : \"<HANA Tenant DB Guid or Name>\" },\r\n    \"binding_parameters\": {\"<key>\" : \"<value>\"}\r\n  }\r\n  ```\r\n  - callback | *function(err, instance)* | Callback function with the newly created instance as second argument.\r\n\r\n**Note**: With _Service Manager_ and **Migration Manager** the properties provided on the managed instance are a subset (`label`, `plan`, `tags`, `credentials`, `tenant_id` and `status`) of the properties provided on it when using _Instance Manager_.\r\n\r\n- `get(tenant, bindingParams, callback)` - gets the corresponding instance for the provided tenant either from cache or from server. Includes a binding creation fallback if instance has no bindings.\r\nValue of `null` means that a service instance for this tenant does not exist.\r\n  - tenant | *String* | Tenant name.\r\n  - optionalParameters | *Object* | **Optional.**  JSON object with parameters for provisioning or binding, as would be done with the -c options of the CLI commands. Used during binding creation fallback.\r\n  - callback | *function(err, instance)* | Callback function with the instance as second argument.\r\n\r\n**Note**: In _Instance Manager_ case this method only polls if the instance is in status `CREATION_IN_PROGRESS`.\r\nIn all other cases it returns the service instance as it is on server.\r\nThus, having the `credentials` property on the `instance` object in the callback is not guaranteed.\r\nIn _Service Manager_ case if the managed instance is not ready to be used, the method returns an error. In **Migration Manager** case it will try to get an instance from _Service Manager_ if nothing found it will then search in _Instance Manager_ and it will return result considered by _Instance Manager_.\r\n\r\n- `getAll(optionalParameters, callback)` - gets the instances for all tenants as an array of objects. This method updates the cache. Includes binding creation fallback for each instance without binding. If binding creation fails it will log an error message and continue processing.\r\n  - optionalParameters | *Object* | **Optional.**  JSON object with parameters for provisioning or binding, as would be done with the -c options of the CLI commands. Used during binding creation fallback.\r\n  - callback | *function(err, instances)* | Callback function with all instances as second argument.\r\n\r\n**Note**: In _Instance Manager_ case filtering of the instances according to their status (e.g. `CREATION_SUCCEEDED`, `CREATION_IN_PROGRESS`) does not take place. Thus, having the `credentials` property on each of the instances provided in the callback is not guaranteed. In _Service Manager_ case only ready to be used managed instances are returned. In **Migration Manager** case it will get instances from both _Service Manager_ and _Instance Manager_ and will return an array of managed instances. If no instaces found and error would be thrown.\r\n\r\n- `delete(tenant, callback)` - deletes service instance for the provided tenant.\r\nThe method polls until the instance is successfully deleted and then invokes the callback.\r\nReports an error having a `statusCode` property with value of `404` if an instance for this tenant does not exist.\r\n  - tenant | *String* | Tenant name.\r\n  - callback | *function(err)* | Callback function called when the instance is deleted or an error has occurred.\r\n\r\nWhen the callback of a method is invoked with an error which is caused by an unexpected HTTP response code\r\nreceived from the server, then this error object will have a `statusCode` property with the value of the HTTP status code.\r\n\r\n**Note**: In **Migration Manager** case it will try to delete service instance for the provided tenant first in _Instance Manager_ then it will continue with _Service Manager_. In case nothing's found an error would be thrown, all other cases it would delete service instances.\r\n\r\n## Debug logs\r\n\r\nOne can enable debug logs of this package via adding _instance-manager_ to the `DEBUG` environment variable.\r\n\r\n\r\n## Binding Labels\r\n\r\n***Note: The @sap/instance-manager will only retrieve bindings that have all three of the below bindings. These labels are automatically assigned and added when creating bindings via this library.***\r\n\r\nLabel Name | Value\r\n-------- | ---------\r\ntenant_id | The tenant for which the binding is created.\r\nservice_plan_id | The ID of the 'hdi-shared' plan of the 'hana' service offering (by default).\r\nmanaging_client_lib | 'instance-manager-client-lib' - this value is used as an additional filter to distinguish instances created and used by this library, and those created by other means and used for other purposes.\r\n\r\n"}]